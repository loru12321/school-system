<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <style>
        /* ================== 移动端仪表盘风格 (Dashboard Style) ================== */
        @media screen and (max-width: 768px) {
            /* 1. 彻底隐藏 PC 端所有非核心元素 */
            /* 1. 彻底隐藏 PC 端所有非核心元素 (增加权重以覆盖 main.css) */
            body>header,
            body>.nav-wrapper,
            body>.container,
            .side-nav,
            .content-area,
            #app-subtitle,
            #custom-logo-img,
            .loading-mask,
            #mobile-top-bar,
            .control-panel

            /* 确保旧控制面板也隐藏 */
                {
                display: none !important;
            }

            /* 2. 全局容器使得手机端占满 */
            body,
            html {
                background-color: #f5f7fa;
                /* 浅灰底色 */
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow-x: hidden;
            }

            .container {
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                background: transparent !important;
                box-shadow: none !important;
            }

            /* 3. 仪表盘容器 */
            #mob-dashboard-view {
                display: block !important;
                padding-bottom: 80px;
                /* 底部导航留空 */
            }

            /* 4. 沉浸式头部 */
            .mob-dash-header {
                background: linear-gradient(135deg, #4f46e5, #3b82f6);
                padding: 20px 20px 50px 20px;
                /* 底部留白给卡片可以上浮 */
                color: white;
                border-radius: 0 0 20px 20px;
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            }

            .mob-dash-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .mob-school-name {
                font-size: 18px;
                font-weight: bold;
            }

            .mob-user-info {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                background: rgba(255, 255, 255, 0.2);
                padding: 5px 10px;
                border-radius: 20px;
                backdrop-filter: blur(5px);
            }

            /* 5. 金刚区 (Grid Navigation) - 核心控制面板 */
            .mob-grid-nav-card {
                background: white;
                margin: -35px 15px 15px 15px;
                /* 向上浮动覆盖头部 */
                border-radius: 12px;
                padding: 20px 10px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 15px 10px;
                position: relative;
                z-index: 10;
            }

            .mob-grid-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 8px;
                font-size: 12px;
                color: #64748b;
            }

            .mob-grid-icon-box {
                width: 45px;
                height: 45px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: white;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }

            /* 6. 数据概览卡片 */
            .mob-data-card {
                background: white;
                margin: 0 15px 15px 15px;
                border-radius: 12px;
                padding: 15px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            }

            .mob-card-title {
                font-size: 15px;
                font-weight: bold;
                color: #1e293b;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .mob-stat-row {
                display: flex;
                justify-content: space-between;
                text-align: center;
            }

            .mob-stat-item {
                flex: 1;
            }

            .mob-stat-val {
                font-size: 20px;
                font-weight: bold;
                color: #333;
            }

            .mob-stat-label {
                font-size: 11px;
                color: #94a3b8;
                margin-top: 4px;
            }

            /* 7. 底部导航栏 */
            .mob-bottom-tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60px;
                background: white;
                border-top: 1px solid #eee;
                display: flex;
                justify-content: space-around;
                align-items: center;
                font-size: 10px;
                color: #94a3b8;
                padding-bottom: env(safe-area-inset-bottom);
                z-index: 100;
            }

            .mob-tab-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                padding: 5px;
                flex: 1;
            }

            .mob-tab-item.active {
                color: #4f46e5;
            }

            .mob-tab-item i {
                font-size: 22px;
            }
        }
    </style>
    <script>
        // ✅ 兜底初始化 Supabase，防止 sbClient 未定义
        var sbClient = window.sbClient || null;
        window.SUPABASE_URL = localStorage.getItem('SUPABASE_URL') || "https://okwcciujnfvobbwaydiv.supabase.co";
        window.SUPABASE_KEY = localStorage.getItem('SUPABASE_KEY') || "sb_publishable_NQqut_NdTW2z1_R27rJ8jA_S3fTh2r4";
        window.initSupabase = function () {
            if (window.supabase && !sbClient) {
                sbClient = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
                window.sbClient = sbClient;
                console.log("✅ Supabase 连接初始化成功");
            }
        };
    </script>
    <script>
        // 页面加载后自动初始化异常阈值输入框
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof initMacroAnomalyConfigUI === 'function') initMacroAnomalyConfigUI();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js" crossorigin="anonymous"
        onload="window.initSupabase()"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js" crossorigin="anonymous"
        onerror="this.onerror=null;this.src='https://unpkg.com/lz-string@1.5.0/libs/lz-string.min.js'"></script>
    <!-- 🟢 [修复] 添加 XLSX 库支持 Excel 导入导出功能 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"
        onerror="this.onerror=null;this.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>
    <!-- 🟢 [修复] 添加 Alpine.js（教师卡片依赖） -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" crossorigin="anonymous"
        onerror="this.onerror=null;this.src='https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js'"></script>
    <!-- 🟢 [修复] 添加 Chart.js（报告图表依赖） -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"
        onerror="this.onerror=null;this.src='https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js'"></script>
    <!-- 🟢 [修复] 添加 SweetAlert2（Swal 依赖） -->
    <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js" crossorigin="anonymous"
        onerror="this.onerror=null;this.src='https://unpkg.com/sweetalert2@11/dist/sweetalert2.all.min.js'"></script>
    <!-- 🟢 [新增] 添加 jsPDF（PDF导出） -->
    <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"
        onerror="this.onerror=null;this.src='https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'"></script>
    <script src="./assets/js/cloud.js"></script>

    <!-- ================== 样式定义 (CSS) ================== -->
    <link rel="stylesheet" href="./assets/css/main.css">

    <!-- ================== Windows 11 Fluent Design UI 重构包 ================== -->
    <style>
        /* 1. 全局字体与背景 (Mica 材质模拟) */
        body {
            font-family: "Segoe UI Variable", "Segoe UI", "Microsoft YaHei", sans-serif !important;
            background-color: #f0f3f9 !important;
            /* Win11 浅色背景 */
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 0) 0, hsla(253, 16%, 7%, 0) 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 0) 0, hsla(225, 39%, 30%, 0) 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 0) 0, hsla(339, 49%, 30%, 0) 50%) !important;
            color: #202020 !important;
            -webkit-font-smoothing: antialiased;
        }

        /* 2. 卡片与容器：亚克力磨砂玻璃效果 */
        .card-box,
        .section,
        .nav-wrapper,
        .modal-content,
        .spotlight-box,
        .side-nav,
        .control-panel {
            background: rgba(255, 255, 255, 0.75) !important;
            /* 半透明白 */
            backdrop-filter: blur(20px) saturate(125%) !important;
            /* 核心：高斯模糊 */
            border: 1px solid rgba(255, 255, 255, 0.6) !important;
            /* 玻璃边缘光 */
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.06) !important;
            /* 弥散阴影 */
            border-radius: 12px !important;
            /* Win11 标准圆角 */
        }

        /* 3. 顶部 Header：去除重色，改为清爽风格 */
        header {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.03) !important;
            color: #333 !important;
            margin-bottom: 20px !important;
        }

        /* 强制标题文字颜色变深，适应浅色背景 */
        header h1,
        header p,
        header .btn {
            color: #1a1a1a !important;
            text-shadow: none !important;
        }

        header .btn {
            background: rgba(255, 255, 255, 0.5) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        header .btn:hover {
            background: white !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        /* 4. 按钮：扁平化 + 微动效 */
        .btn {
            border-radius: 6px !important;
            /* Win11 按钮圆角 */
            border: 1px solid transparent !important;
            font-weight: 600 !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;
        }

        .btn:active {
            transform: scale(0.96) !important;
            /* 点击缩放 */
            opacity: 0.8;
        }

        /* 主色按钮 */
        .btn-primary,
        button[onclick*="login"] {
            background-color: #0067c0 !important;
            /* Win11 默认蓝 */
            color: white !important;
        }

        .btn:not(.btn-primary):not(.btn-danger):not(.btn-success):not(.btn-purple):not(.btn-orange) {
            background-color: #ffffff !important;
            border: 1px solid #d1d5db !important;
            color: #333 !important;
        }

        .btn:not(.btn-primary):not(.btn-danger):hover {
            background-color: #f3f4f6 !important;
        }

        /* 5. 输入框：底部高亮线风格 */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            background-color: rgba(255, 255, 255, 0.6) !important;
            border: 1px solid #d1d5db !important;
            border-bottom: 2px solid #d1d5db !important;
            /* 底部加粗 */
            border-radius: 6px !important;
            transition: all 0.2s !important;
            color: #333 !important;
        }

        input:focus,
        select:focus,
        textarea:focus {
            background-color: #fff !important;
            border-color: #d1d5db !important;
            border-bottom-color: #0067c0 !important;
            /* 聚焦变蓝 */
            box-shadow: none !important;
        }

        /* 6. 表格：极简风，去竖线 */
        table {
            border-collapse: separate !important;
            border-spacing: 0 !important;
        }

        thead th {
            background: transparent !important;
            border-bottom: 1px solid #e5e7eb !important;
            color: #64748b !important;
            font-size: 12px !important;
            text-transform: none !important;
            padding: 12px 8px !important;
        }

        /* 悬浮行效果 */
        tbody tr {
            transition: background 0.1s !important;
            border-radius: 6px !important;
        }

        tbody tr:hover td {
            background-color: rgba(0, 0, 0, 0.03) !important;
            /* 极淡的灰 */
        }

        td {
            border-right: none !important;
            /* 去除竖线 */
            border-bottom: 1px solid #f1f5f9 !important;
            padding: 12px 8px !important;
        }

        /* 修复首列冻结的背景 */
        table th:first-child,
        table td:first-child {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px);
        }

        /* 7. 导航栏：胶囊样式 */
        .nav-wrapper {
            background: rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            padding: 5px !important;
        }

        .nav-categories {
            background: transparent !important;
            gap: 5px !important;
            padding: 5px !important;
        }

        .nav-cat-item {
            color: #666 !important;
            border-radius: 4px !important;
            border-bottom: none !important;
            padding: 8px 16px !important;
            background: transparent !important;
        }

        .nav-cat-item:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
        }

        .nav-cat-item.active {
            background-color: #ffffff !important;
            color: #0067c0 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
            font-weight: 700 !important;
        }

        /* 二级导航胶囊 */
        .nav-link {
            border-radius: 20px !important;
            background: transparent !important;
            border: none !important;
        }

        .nav-link:hover {
            background: rgba(0, 0, 0, 0.05) !important;
        }

        .nav-link.active {
            background: #0067c0 !important;
            color: white !important;
            box-shadow: 0 2px 8px rgba(0, 103, 192, 0.3) !important;
        }

        /* 8. 弹窗 Modal：居中悬浮卡片 */
        .modal {
            background: rgba(0, 0, 0, 0.4) !important;
            backdrop-filter: blur(5px) !important;
            /* 背景虚化 */
        }

        .modal-content {
            border: 1px solid rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2) !important;
            animation: modalPop 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28) !important;
        }

        @keyframes modalPop {
            0% {
                transform: scale(0.95);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 9. 滚动条美化 (Overlay Scrollbars) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }

        /* 10. 修复左侧导航 (Side Nav) */
        .side-nav {
            background: rgba(255, 255, 255, 0.6) !important;
            border: none !important;
        }

        .side-nav-link.active {
            background: rgba(0, 103, 192, 0.1) !important;
            color: #0067c0 !important;
            border-left: 3px solid #0067c0 !important;
        }

        /* 11. 消息提示 Toast */
        .toast-msg {
            background: rgba(255, 255, 255, 0.9) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
        }

        /* ================== 【终极版】全域沉浸式深色模式 (Immersive Dark Mode) ================== */
        /* 核心逻辑：强制将所有白色半透明容器改为深灰半透明，文字反白 */

        /* 1. 整体背景：深邃黑 */
        body.dark-mode {
            background-color: #0f0f0f !important;
            background-image: none !important;
            /* 去掉花哨背景，保持纯净深色 */
            color: #e0e0e0 !important;
        }

        /* 2. 核心容器变黑 (卡片、头部、导航、弹窗、侧边栏) */
        body.dark-mode .card-box,
        body.dark-mode .section,
        body.dark-mode .nav-wrapper,
        body.dark-mode .modal-content,
        body.dark-mode .spotlight-box,
        body.dark-mode .side-nav,
        body.dark-mode .control-panel,
        body.dark-mode .upload-box,
        body.dark-mode header,
        body.dark-mode .teacher-card,
        /* 教师卡片 */
        body.dark-mode .mob-card,
        /* 手机端卡片 */
        body.dark-mode .sub-header

        /* 小标题栏 */
            {
            background: rgba(30, 30, 30, 0.85) !important;
            /* 深灰色背景 */
            backdrop-filter: blur(20px) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            /* 极细的亮边 */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6) !important;
            /* 深色阴影 */
            color: #e0e0e0 !important;
        }

        /* 3. 强制文字反白 */
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4,
        body.dark-mode p,
        body.dark-mode span,
        body.dark-mode label,
        body.dark-mode div,
        body.dark-mode strong,
        body.dark-mode b,
        body.dark-mode .nav-cat-item,
        body.dark-mode .side-nav-link {
            color: #e0e0e0 !important;
        }

        /* 弱化次要文字 */
        body.dark-mode .text-gray,
        body.dark-mode small,
        body.dark-mode .nav-link {
            color: #a0a0a0 !important;
        }

        /* 4. 输入框、下拉框：深灰底白字 */
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode textarea {
            background-color: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: #fff !important;
        }

        body.dark-mode input:focus,
        body.dark-mode select:focus {
            border-color: #3b82f6 !important;
            /* 聚焦时亮蓝边 */
            background-color: rgba(0, 0, 0, 0.6) !important;
        }

        /* 5. 按钮：微调 */
        body.dark-mode .btn:not(.btn-primary):not(.btn-danger):not(.btn-success) {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: #fff !important;
        }

        /* 6. 表格特殊处理 */
        body.dark-mode thead th {
            background-color: rgba(45, 45, 45, 0.9) !important;
            /* 表头稍亮 */
            color: #ccc !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        body.dark-mode td {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
            color: #e0e0e0 !important;
        }

        /* 冻结列背景必须变黑，否则滚动时会透出文字 */
        body.dark-mode table th:first-child,
        body.dark-mode table td:first-child {
            background: #1e1e1e !important;
            border-right: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* 鼠标悬停行高亮 */
        body.dark-mode tbody tr:hover td {
            background-color: rgba(255, 255, 255, 0.08) !important;
        }

        /* 7. 导航栏激活状态 */
        body.dark-mode .nav-cat-item.active,
        body.dark-mode .nav-link.active,
        body.dark-mode .side-nav-link.active {
            background-color: #3b82f6 !important;
            /* 亮蓝色 */
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4) !important;
            /* 发光效果 */
        }

        /* 8. 去除白色背景的补丁 */
        body.dark-mode .bg-gray-50,
        body.dark-mode .bg-white {
            background-color: transparent !important;
        }

        /* ================== 3. 字体层级与间距优化 (Typography & Spacing) ================== */

        /* A. 增加表格舒适度 (Loose Display) */
        td,
        th {
            padding: 14px 12px !important;
            /* 增加上下内边距，让数据不拥挤 */
            font-size: 13px !important;
            /* 稍微调小字号，显得更精致 */
        }

        /* B. 强调数字列字体 (Tabular Nums) */
        /* 从第3列开始通常是数字，使用等宽字体对齐更整齐 */
        td:nth-child(n+3) {
            font-family: "Cascadia Code", "Consolas", "Roboto Mono", "Menlo", monospace !important;
            letter-spacing: -0.5px;
            /* 数字稍微紧凑一点 */
            font-feature-settings: "tnum";
            /* 开启等宽数字特性 */
        }

        /* C. 模块标题增加呼吸感 */
        .sec-head {
            margin-bottom: 25px !important;
            padding-bottom: 15px !important;
            border-bottom-width: 1px !important;
            /* 细线更现代 */
        }

        /* D. 优化卡片内间距 */
        .card-box,
        .section {
            padding: 25px !important;
            /* 加大卡片内边距 */
        }

        /* E. 优化统计数字字重 */
        .stat-value,
        .fb-val,
        .total-val {
            font-weight: 700 !important;
            letter-spacing: -1px !important;
            /* 大数字紧凑更具张力 */
        }

        /* ================== 4. 骨架屏加载效果 (Skeleton Loading) ================== */

        /* A. 定义微光流体动画 (Shimmer Animation) */
        @keyframes skeleton-shimmer {
            0% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0 50%;
            }
        }

        /* B. 表格加载态容器 */
        /* 当给 table 或 div 加上 class="loading-mask" 时触发 */
        .loading-mask {
            position: relative;
            pointer-events: none;
            /* 禁止点击 */
            min-height: 200px;
        }

        /* C. 覆盖在内容上的骨架层 */
        .loading-mask::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            /* 浅色模式下的骨架背景：灰白相间流光 */
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.8) 20%,
                    rgba(240, 240, 240, 0.9) 50%,
                    rgba(255, 255, 255, 0.8) 80%,
                    rgba(255, 255, 255, 0) 100%);
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s infinite linear;
            backdrop-filter: blur(2px);
            /* 轻微模糊底层文字 */
            border-radius: 8px;
        }

        /* D. 针对表格行的条纹骨架 (更逼真) */
        /* 自动匹配空表格或加载中的表格 */
        .loading-mask tbody tr td {
            position: relative;
            color: transparent !important;
            /* 隐藏真实文字 */
        }

        .loading-mask tbody tr td::before {
            content: "";
            position: absolute;
            top: 12px;
            bottom: 12px;
            left: 10px;
            right: 10px;
            background: #e2e8f0;
            border-radius: 4px;
            /* 骨架条的微光效果 */
            background-image: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0,
                    rgba(255, 255, 255, 0.5) 20%,
                    rgba(255, 255, 255, 0.8) 60%,
                    rgba(255, 255, 255, 0));
            background-size: 200% 100%;
            animation: skeleton-shimmer 2s infinite linear;
        }

        /* E. 深色模式适配 (Dark Mode Skeleton) */
        body.dark-mode .loading-mask::after {
            /* 深色模式下的流光：深灰到黑 */
            background: linear-gradient(90deg,
                    rgba(30, 30, 30, 0) 0%,
                    rgba(50, 50, 50, 0.5) 50%,
                    rgba(30, 30, 30, 0) 100%);
        }

        body.dark-mode .loading-mask tbody tr td::before {
            background: #2d2d2d;
            /* 深色骨架条底色 */
            background-image: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0,
                    rgba(255, 255, 255, 0.05) 50%,
                    rgba(255, 255, 255, 0));
        }

        /* ================== 5. 移动端底部导航质感增强 (Mobile Glassmorphism) ================== */
        @media screen and (max-width: 768px) {
            .mob-bottom-nav {
                background: rgba(255, 255, 255, 0.85) !important;
                /* 高透白 */
                backdrop-filter: blur(20px) saturate(180%) !important;
                /* iOS 风格毛玻璃 */
                -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
                border-top: 1px solid rgba(0, 0, 0, 0.05) !important;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05) !important;
                /* 适配全面屏底部横条 (Safe Area) */
                padding-bottom: max(10px, env(safe-area-inset-bottom)) !important;
                height: auto !important;
                min-height: 65px;
                z-index: 99999 !important;
                /* 确保最顶层 */
            }

            .mob-nav-item {
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                opacity: 0.6;
                padding-top: 8px;
            }

            .mob-nav-item.active {
                color: #0067c0 !important;
                opacity: 1;
                transform: translateY(-2px);
                /* 选中微浮动 */
            }

            /* 选中时图标加个胶囊微光背景 */
            .mob-nav-item.active i {
                background: rgba(0, 103, 192, 0.1);
                border-radius: 16px;
                padding: 6px 20px;
                margin-bottom: 2px;
                transition: 0.3s;
            }

            /* --- 深色模式适配 (Dark Mode Mobile Nav) --- */
            body.dark-mode .mob-bottom-nav {
                background: rgba(30, 30, 30, 0.85) !important;
                border-top-color: rgba(255, 255, 255, 0.1) !important;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5) !important;
            }

            body.dark-mode .mob-nav-item {
                color: #a0a0a0 !important;
            }

            body.dark-mode .mob-nav-item.active {
                color: #3b82f6 !important;
            }

            body.dark-mode .mob-nav-item.active i {
                background: rgba(59, 130, 246, 0.25);
                color: #ffffff !important;
                box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
            }
        }
    </style>
    </style>

    <!-- 📱 移动端专属样式与逻辑 (Mobile Optimization) -->
    <style>
        /* ================== 移动端核心变量与重置 ================== */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --mobile-header-height: 60px;
            --mobile-nav-height: 65px;
        }

        /* 深色模式下的毛玻璃 */
        body.dark-mode {
            --glass-bg: rgba(30, 30, 30, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ================== 移动端登录页优化 ================== */
        @media screen and (max-width: 768px) {

            /* 1. 登录容器：全屏适配，取消圆角和边距限制 */
            #login-overlay {
                background-size: 10px 10px !important;
                /* 点阵变小 */
                padding: 20px !important;
                align-items: flex-start !important;
                /* 内容上移，避免软键盘遮挡 */
                padding-top: 15vh !important;
            }

            #login-overlay>div {
                width: 100% !important;
                max-width: 100% !important;
                border: none !important;
                box-shadow: none !important;
                background: transparent !important;
                /* 移除白色背景块，改为透明 */
                padding: 0 !important;
            }

            /* 登录框内部毛玻璃卡片 */
            #login-form {
                background: var(--glass-bg) !important;
                backdrop-filter: blur(20px) !important;
                -webkit-backdrop-filter: blur(20px) !important;
                border: var(--glass-border) !important;
                border-radius: 16px !important;
                padding: 25px !important;
                box-shadow: var(--glass-shadow) !important;
            }

            #login-overlay h1 {
                font-size: 28px !important;
                margin-bottom: 8px !important;
            }

            /* 输入框加大，方便手指点击 */
            #login-form input {
                padding: 14px !important;
                font-size: 16px !important;
                /* 防止 iOS 自动缩放 */
                border-radius: 10px !important;
                background: rgba(255, 255, 255, 0.8) !important;
            }

            /* 登录按钮 */
            #login-form button {
                padding: 14px !important;
                font-size: 18px !important;
                border-radius: 10px !important;
                background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
                box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4) !important;
            }

            /* 隐藏 PC 端不需要的元素 */
            #cohort-growth,
            #global-loader .loader-text {
                display: none !important;
            }
        }
    </style>
</head>

<body>

    <!-- 全局加载遮罩 -->
    <div id="global-loader" class="hidden">
        <div class="loader-spinner"></div>
        <div class="loader-text" id="loader-text">系统正在处理数据，请稍候...</div>
    </div>

    <!-- ✋ 🔴 [已移除]：删除了 mobile-lite-interface 整个容器，手机访问将直接显示下方的主界面 🔴 -->

    <div id="login-overlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:#f3f4f6; z-index:50000; display:flex; align-items:center; justify-content:center; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px;">
        <div
            style="background:white; padding:40px; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width:100%; max-width:420px; border:1px solid #e5e7eb;">
            <div style="text-align:center; margin-bottom:30px;">
                <h1 style="color:var(--primary); font-size:24px; font-weight:800; margin-bottom:5px;">智慧教务管理系统</h1>
                <p style="color:#64748b; font-size:14px;">统一身份认证入口</p>
            </div>

            <!-- 登录表单 -->
            <div id="login-form">

                <!-- 1. 用户名输入框 -->
                <div class="form-group">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">
                        账号 / 姓名
                    </label>
                    <input type="text" id="login-user" placeholder="管理员账号 / 教师姓名 / 学生姓名"
                        style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                        onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <!-- 2. 班级输入框 (改为始终显示，但在 JS 里判断逻辑) -->
                <div class="form-group" style="margin-top:15px;">
                    <label style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">
                        班级 <span style="color:#f59e0b; font-weight:normal; font-size:11px;">(教职工留空，家长必填如:701)</span>
                    </label>
                    <input type="text" id="login-class" placeholder="请输入班级 (仅家长/学生必填)"
                        style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                        onkeydown="if(event.key==='Enter') Auth.login()">
                </div>

                <!-- 3. 密码输入框 -->
                <div class="form-group" style="margin-top:15px;">
                    <label
                        style="display:block; font-size:12px; font-weight:bold; color:#475569; margin-bottom:5px;">密码</label>
                    <input type="password" id="login-pass" placeholder="输入密码"
                        style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                        onkeydown="if(event.key==='Enter') window.Auth?.login()">
                </div>

                <button onclick="window.Auth?.login()"
                    style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:6px; font-size:16px; font-weight:bold; margin-top:25px; cursor:pointer; transition:0.2s; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    立即登录
                </button>

                <!-- 已添加 display:none 隐藏默认提示 -->
                <div
                    style="display:none; text-align:center; margin-top:15px; font-size:12px; color:#94a3b8; line-height: 1.6;">
                    管理员默认: admin / admin123<br>
                    其他角色默认密码: 123456
                </div>
            </div>
        </div>

        <!-- 纵向成长档案 (Cohort Growth) -->
        <div id="cohort-growth" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-timeline"></i> 纵向成长档案 <span class="badge" style="background:#0ea5e9;">📈
                        班主任必看</span></h3>
                <p><strong>一句话目的：</strong>基于届别ID构建学生成长曲线与稳定性画像。</p>
                <p><strong>推荐顺序：</strong>完成多次考试导入后使用。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-timeline"></i> 成长轨迹与稳定性分析</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-purple" onclick="CohortGrowth.render()">🔎 生成成长档案</button>
                    <button class="btn btn-gray" onclick="CohortGrowth.exportVolatility()">📥 导出波动名单</button>
                </div>
            </div>
            <div class="info-bar">
                <span>基于届别历史考试，计算 $Z$ 分数波动率、排名百分位变化。</span>
                <span style="margin-left:auto; font-size:12px;">建议至少 4 次考试数据</span>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div class="card-box" style="border-left:4px solid #38bdf8; background:#f0f9ff;">
                    <div class="sub-header">🌊 Z-Score 波动率 (稳定性)</div>
                    <div class="table-wrap">
                        <table id="cohort-volatility-table">
                            <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>班级</th>
                                    <th>考试次数</th>
                                    <th>波动率(σ)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-box" style="border-left:4px solid #22c55e; background:#f0fdf4;">
                    <div class="sub-header">🚀 排名百分位成长 (首尾对比)</div>
                    <div class="table-wrap">
                        <table id="cohort-growth-table">
                            <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>班级</th>
                                    <th>起始百分位</th>
                                    <th>最新百分位</th>
                                    <th>变化</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 消息提示容器 -->
    <div id="toast-container" class="toast-container"></div>

    <!-- 届别入口弹窗 -->
    <div id="mode-mask">
        <div class="mode-box">
            <h2 style="color:var(--primary); margin-bottom:15px; font-size:24px;">📂 进入届别档案</h2>
            <p style="color:#64748b;">以“入学年份”为主线建立完整成长周期，系统将自动匹配年级与核算模式</p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
                <input id="entry-cohort-year" type="number" min="2000" max="2100" placeholder="入学年份 (如 2022)"
                    style="padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; width:200px;">
                <button class="btn btn-primary" onclick="enterCohortFromMask()">进入届别</button>
            </div>
            <div style="margin-top:10px; font-size:12px; color:#64748b;">已有届别可在顶部下拉直接切换</div>
        </div>
    </div>

    <!-- 手机端管理主界面 (默认隐藏，通过 JS 激活) -->
    <!-- 📱 移动端仪表盘视图 -->
    <div id="mob-dashboard-view" style="display: none;">
        <!-- 头部 -->
        <div class="mob-dash-header">
            <div class="mob-dash-top">
                <div class="mob-school-name"><i class="ti ti-building-arch"></i> 智慧教务</div>
                <div class="mob-user-info" onclick="Auth.logout()">
                    <i class="ti ti-user-circle"></i> <span id="mob-dash-user">老师</span>
                </div>
            </div>
            <div style="font-size: 24px; font-weight: bold;">工作台</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">今天是 <span
                    id="mob-date-display">--月--日</span>，祝您工作愉快</div>
        </div>

        <!-- 金刚区导航 (Grid Nav) -->
        <div class="mob-grid-nav-card">
            <div class="mob-grid-item"
                onclick="document.getElementById('upload').scrollIntoView({behavior:'smooth'}); MobMgr.showToast('请在下方上传数据')">
                <div class="mob-grid-icon-box" style="background: linear-gradient(135deg, #10b981, #34d399);">
                    <i class="ti ti-file-import"></i>
                </div>
                <span>导入数据</span>
            </div>
            <div class="mob-grid-item" onclick="showModuleHelp('starter-hub')">
                <div class="mob-grid-icon-box" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                    <i class="ti ti-compass"></i>
                </div>
                <span>新手向导</span>
            </div>
            <div class="mob-grid-item"
                onclick="DataManager.renderCloudBackups(); document.getElementById('dm-cloud-modal').classList.remove('hidden')">
                <div class="mob-grid-icon-box" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                    <i class="ti ti-cloud"></i>
                </div>
                <span>云端回滚</span>
            </div>
            <div class="mob-grid-item" onclick="openSkinModal()">
                <div class="mob-grid-icon-box" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
                    <i class="ti ti-palette"></i>
                </div>
                <span>外观设置</span>
            </div>
            <div class="mob-grid-item" onclick="toggleDarkMode()">
                <div class="mob-grid-icon-box" style="background: linear-gradient(135deg, #475569, #64748b);">
                    <i class="ti ti-moon"></i>
                </div>
                <span>深色模式</span>
            </div>
            <div class="mob-grid-item" onclick="if(confirm('确定退出登录吗？')) Auth.logout()">
                <div class="mob-grid-icon-box" style="background: linear-gradient(135deg, #ef4444, #f87171);">
                    <i class="ti ti-logout"></i>
                </div>
                <span>退出登录</span>
            </div>
        </div>

        <!-- 数据概览卡片 -->
        <div class="mob-data-card">
            <div class="mob-card-title"><i class="ti ti-chart-bar" style="color:#4f46e5"></i> 数据概览</div>
            <div class="mob-stat-row">
                <div class="mob-stat-item">
                    <div class="mob-stat-val" id="mob-stat-total">--</div>
                    <div class="mob-stat-label">总人数</div>
                </div>
                <div class="mob-stat-item">
                    <div class="mob-stat-val" id="mob-stat-avg" style="color:#10b981">--</div>
                    <div class="mob-stat-label">总平均分</div>
                </div>
                <div class="mob-stat-item">
                    <div class="mob-stat-val" id="mob-stat-pass" style="color:#f59e0b">--%</div>
                    <div class="mob-stat-label">及格率</div>
                </div>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#94a3b8; text-align:center;">
                * 更多详细分析请向下滚动查看完整 PC 视图
            </div>
        </div>

        <!-- 底部导航 -->
        <div class="mob-bottom-tabs">
            <div class="mob-tab-item active" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <i class="ti ti-smart-home"></i>
                <span>工作台</span>
            </div>
            <div class="mob-tab-item"
                onclick="document.getElementById('dm-student-list').scrollIntoView({behavior:'smooth'})">
                <i class="ti ti-address-book"></i>
                <span>通讯录</span>
            </div>
            <div class="mob-tab-item"
                onclick="document.getElementById('analysis-output').scrollIntoView({behavior:'smooth'})">
                <i class="ti ti-chart-pie"></i>
                <span>分析报表</span>
            </div>
            <div class="mob-tab-item" onclick="Auth.logout()">
                <i class="ti ti-user"></i>
                <span>我的</span>
            </div>
        </div>
    </div>


    <!-- 主应用界面 -->
    <div id="watermark-layer" aria-hidden="true"></div>
    <div class="container hidden" id="app">
        <header id="main-header">
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Logo 容器 (默认隐藏，上传后显示) -->
                <img id="custom-logo-img" src="" loading="lazy" decoding="async"
                    style="display:none; height: 60px; width: auto; border-radius: 6px; background: rgba(255,255,255,0.95); padding: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
                    alt="校徽">

                <!-- 标题文字区域 -->
                <div style="flex: 1; display: flex; align-items: center; gap: 15px;">
                    <h1 id="app-title"
                        style="margin:0; font-size:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 800; letter-spacing: -0.5px;">
                        SmartEdu Analytics <span id="mode-badge" class="badge"></span>
                    </h1>
                    <span id="role-hint"
                        style="font-size:12px; color:#fff; background:rgba(255,255,255,0.15); backdrop-filter: blur(4px); padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.25);">Role:
                        Guest</span>
                </div>

                <!-- 右上角工具栏 -->
                <div style="display:flex; gap:8px; align-items:center;">
                    <select id="cohort-selector" onchange="CohortManager.switchTo(this.value)"
                        style="background:rgba(255,255,255,0.15); color:white; border:1px solid rgba(255,255,255,0.3); padding:6px 12px; border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; outline:none; transition: all 0.2s;">
                        <option value="" style="color:#333">📁 Select Cohort</option>
                    </select>
                    <button class="btn"
                        style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); color:white; padding: 6px 12px; font-size: 13px;"
                        onclick="scrollToAnchor('upload', this)" title="Manage Cohorts">
                        <i class="ti ti-users-group"></i> Cohorts
                    </button>
                    <div id="admin-msg-btn" class="notification-btn" style="display:none;"
                        onclick="IssueManager.openAdminPanel()">
                        <button class="btn"
                            style="background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.4); color:white;"
                            title="查看申诉反馈">
                            <i class="ti ti-bell"></i>
                        </button>
                        <div id="msg-badge" class="notification-badge hidden">0</div>
                    </div>
                    <!-- 注意：此按钮默认通过 CSS #admin-panel-btn {display:none} 隐藏，只有 body[data-role="admin"] 时才显示 -->
                    <button class="btn" id="admin-panel-btn"
                        onclick="document.getElementById('admin-modal').style.display='flex'"
                        style="background:rgba(220, 38, 38, 0.8); color:white; border:1px solid rgba(255,255,255,0.2); display:none; padding: 6px 12px; font-size: 13px;">
                        <i class="ti ti-settings"></i> Accounts
                    </button>
                    <button class="btn" id="btn-cloud-rollback" onclick="openCloudRollback()"
                        title="Admin: Cloud Rollback"
                        style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); color:white; display:none; padding: 6px 12px; font-size: 13px;">
                        <i class="ti ti-rotate"></i> Rollback
                    </button>
                    <button class="btn"
                        style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(5px); color:white; padding: 6px 12px; font-size: 13px;"
                        onclick="HelpSystem.startTour()" title="Tutorial">
                        <i class="ti ti-help-circle"></i> Guide
                    </button>
                    <!-- [新增] 外观设置按钮 -->
                    <button class="btn"
                        style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(5px); color:white; padding: 6px 12px; font-size: 13px;"
                        onclick="openSkinModal()" title="Theme/Appearance">
                        <i class="ti ti-palette"></i> Theme
                    </button>

                    <!-- 深色模式切换按钮 -->
                    <button class="btn"
                        style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); padding: 6px 10px;"
                        onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="ti ti-moon"></i>
                    </button>
                    <!-- 全局搜索提示按钮 -->
                    <div style="color:rgba(255,255,255,0.9); font-size:12px; border:1px solid rgba(255,255,255,0.3); padding:6px 12px; border-radius:6px; cursor:pointer; background: rgba(0,0,0,0.15); font-weight: 500; transition: all 0.2s;"
                        onclick="openSpotlight()" onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                        onmouseout="this.style.background='rgba(0,0,0,0.15)'">
                        <i class="ti ti-search"></i> Search
                    </div>

                    <button class="btn" id="btn-guest-mode" onclick="toggleGuestMode()"
                        style="background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); color:white; font-size:12px; padding:6px 10px; margin-left:5px;"
                        title="Incognito Mode (Data deleted on close)">
                        <i class="ti ti-flame"></i> Incognito
                    </button>
                </div>
            </div>
        </header>

        <!-- 双层顶部导航菜单 -->
        <div class="nav-wrapper">
            <div class="nav-categories" id="navCategories"></div>
            <div class="nav-sub-items" id="navSubItems"></div>
        </div>

        <!-- 0. 新教师上手入口 -->
        <div id="starter-hub" class="section active card-box">
            <div class="module-desc-bar" style="border-color: var(--color-data)">
                <h3><i class="ti ti-rocket"></i> 00 新教师上手入口 <span class="badge" style="background:#0ea5e9;">新手必看</span>
                    <span class="module-help-btn" onclick="showModuleHelp('starter-hub')">📘 模型说明</span>
                </h3>
                <p><strong>一句话目的：</strong>用最短路径完成“选学期 → 导入数据 → 任课表 → 教师画像”的闭环。</p>
                <p><strong>推荐顺序：</strong>引导向导 → 导入成绩 → 任课同步 → 教师画像。</p>
            </div>

            <div class="starter-grid">
                <div class="starter-card">
                    <h4><i class="ti ti-activity"></i> 数据状态面板</h4>
                    <div id="starter-status-panel" class="status-grid"></div>
                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                        <span style="font-size:12px; color:#475569;">本校：</span>
                        <select id="mySchoolSelect"
                            style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; min-width:160px;"></select>
                        <button class="btn btn-gray" onclick="autoDetectMySchool()">自动识别</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-checklist"></i> 任务清单</h4>
                    <ul id="starter-task-list" class="task-list">
                        <li class="task-item" data-task="term"><span class="dot"></span>选择学期与届别</li>
                        <li class="task-item" data-task="scores"><span class="dot"></span>导入成绩数据</li>
                        <li class="task-item" data-task="teacher"><span class="dot"></span>导入任课表并同步</li>
                        <li class="task-item" data-task="school"><span class="dot"></span>选择本校</li>
                        <li class="task-item" data-task="analysis"><span class="dot"></span>查看教师画像</li>
                    </ul>
                    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-blue" onclick="openStarterGuide()"><i class="ti ti-compass"></i>
                            引导向导</button>
                        <button class="btn btn-gray" onclick="loadDemoData()"><i class="ti ti-flask"></i> 演示数据</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-link"></i> 统一入口</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-purple" onclick="switchTab('upload')"><i class="ti ti-file-upload"></i>
                            数据导入</button>
                        <button class="btn btn-orange" onclick="openTeacherSync()"><i class="ti ti-users"></i>
                            教师任课</button>
                        <button class="btn btn-green" onclick="switchTab('teacher-analysis')"><i
                                class="ti ti-school"></i> 教师画像</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-stethoscope"></i> 自动诊断</h4>
                    <div id="starter-diagnose-result" style="font-size:12px; color:#64748b;">点击按钮开始诊断。</div>
                    <div style="margin-top:10px;">
                        <button class="btn btn-red" onclick="runAutoDiagnosis()"><i class="ti ti-shield-check"></i>
                            一键诊断</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-alert-circle"></i> 数据异常中心</h4>
                    <ul id="starter-issue-list" class="issue-list">
                        <li class="issue-item" style="color:#64748b; background:#f8fafc; border-color:#e2e8f0;">点击扫描查看异常
                        </li>
                    </ul>
                    <div style="margin-top:10px;">
                        <button class="btn btn-orange" onclick="scanDataIssues()"><i class="ti ti-scan"></i>
                            扫描异常</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-history"></i> 操作记录</h4>
                    <ul id="starter-log-list" class="log-list"></ul>
                    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-gray" onclick="clearActionLogs()"><i class="ti ti-trash"></i>
                            清空记录</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-database-export"></i> 备份与恢复</h4>
                    <div style="font-size:12px; color:#64748b;">建议在切换届别或大批量修改前手动备份。</div>
                    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-blue" onclick="manualBackup()"><i class="ti ti-device-floppy"></i>
                            一键备份</button>
                        <button class="btn btn-gray" onclick="manualRestore()"><i class="ti ti-rotate"></i>
                            一键恢复</button>
                    </div>
                </div>
                <div class="starter-card">
                    <h4><i class="ti ti-download"></i> 模板下载</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-green" onclick="downloadTemplate('junior')">成绩模板(6-8)</button>
                        <button class="btn btn-green" onclick="downloadTemplate('grade9')">成绩模板(9年级)</button>
                        <button class="btn btn-orange" onclick="downloadTemplate('teacher')">任课模板</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 1. 数据上传 & 项目管理 -->
        <div id="upload" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-data)">
                <h3><i class="ti ti-database-import"></i> 01 数据枢纽中心 <span class="badge" style="background:#16a34a;">⭐
                        教务常用</span></h3>
                <p><strong>一句话目的：</strong>导入并规范化成绩数据，建立分析基础。</p>
                <p><strong>推荐顺序：</strong>第1步（导入数据）→ 第2步（生成分析）→ 第3步（导出结果）。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-file-upload"></i> 数据文件上传
                    <span class="module-help-btn" onclick="showModuleHelp('upload')">📘 使用说明</span>
                </h2>
                <div style="margin-left: auto;">
                    <button class="btn btn-orange" onclick="runDataDoctor()">
                        <i class="ti ti-stethoscope"></i> 数据体检
                    </button>
                </div>
            </div>
            <div class="info-bar"><span>当前模式：<strong id="mode-info"></strong>。系统将自动过滤无关数据。</span></div>
            <div class="card-box" style="border-left:4px solid #7c3aed; background:#f5f3ff; margin-top:10px;">
                <div class="sec-head" style="border-bottom-color:#ddd6fe; margin-bottom:10px;">
                    <h2 style="color:#5b21b6;"><i class="ti ti-users-group"></i> 届别管理 (Cohort)</h2>
                    <div style="font-size:12px; color:#6b7280;">以“入学年份”为主轴，贯穿三年成长档案</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <input id="cohort-year" type="number" min="2000" max="2100" placeholder="入学年份 (如 2022)"
                        style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; width:180px;">
                    <button class="btn btn-purple" onclick="CohortManager.addFromUI()">➕ 新建届别</button>
                    <button class="btn btn-gray" onclick="resetCohortSelection()">↩ 重新选择届别</button>
                    <span id="cohort-status" style="font-size:12px; color:#64748b;"></span>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569;">
                    当前届别：<strong id="cohort-current-label">未选择</strong>
                </div>
            </div>
            <div class="card-box" style="border-left:4px solid #0ea5e9; background:#f0f9ff; margin-top:10px;">
                <div class="sec-head" style="border-bottom-color:#bae6fd; margin-bottom:10px;">
                    <h2 style="color:#0369a1;"><i class="ti ti-archive"></i> 考试批次 / 学期档案化</h2>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span id="exam-archive-status" style="font-size:12px; color:#64748b;">未封存</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <span style="font-size:12px; color:#475569;">届别：</span>
                    <span id="exam-cohort-label" style="font-size:12px; font-weight:bold; color:#1e3a8a;">未选择</span>
                    <select id="exam-year" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;"
                        onchange="refreshExamGradePreview(); onExamTermChange();">
                        <option value="2025-2026">2025-2026</option>
                        <option value="2026-2027">2026-2027</option>
                        <option value="2027-2028">2027-2028</option>
                    </select>
                    <select id="exam-term" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;"
                        onchange="refreshExamGradePreview(); onExamTermChange();">
                        <option value="上学期">上学期</option>
                        <option value="下学期">下学期</option>
                    </select>
                    <select id="exam-type" style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                        <option value="月考">月考</option>
                        <option value="期中">期中</option>
                        <option value="期末">期末</option>
                        <option value="模拟">模拟</option>
                    </select>
                    <input id="exam-date" type="date"
                        style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px;">
                    <input id="exam-name" type="text" placeholder="考试名称(可选)"
                        style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; width:200px;">
                    <label style="display:flex; align-items:center; gap:6px; font-size:12px; color:#475569;">
                        <input type="checkbox" id="exam-reset-point"> 本次考试经历重新分班
                    </label>
                    <span style="font-size:12px; color:#475569;">本次年级：</span>
                    <strong id="exam-grade-label" style="font-size:12px; color:#1e3a8a;">-</strong>
                    <button class="btn btn-primary" onclick="setCurrentExamMeta()">设为当前考试</button>
                    <button class="btn btn-orange" onclick="archiveCurrentExam()">一键封存本次考试</button>
                    <button class="btn btn-gray" onclick="unlockArchive()">解除封存</button>
                </div>
                <div style="margin-top:8px; font-size:12px; color:#475569;">
                    当前考试ID：<strong id="exam-key-display">未设置</strong>
                </div>
                <div
                    style="margin-top:8px; font-size:12px; color:#475569; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    历史考试：
                    <select id="exam-history-select"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:6px; min-width:220px;"></select>
                    <button class="btn btn-sm btn-gray" onclick="CohortDB.loadExamFromSelect()">切换到该考试</button>
                </div>
                <div id="exam-history-status" style="margin-top:6px; font-size:12px; color:#64748b;">
                    历史考试: 0 期｜最近快照: 无
                </div>
                <div style="margin-top:6px;">
                    <button class="btn btn-sm btn-gray" onclick="showMultiCompareDataSourceDiag()">多期数据源诊断</button>
                </div>
            </div>
            <div
                style="background: #f0fdf4; border: 1px dashed #86efac; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="font-weight: bold; color: #166534; display: flex; align-items: center; gap: 5px;">
                    <i class="ti ti-template"></i> 新手必读：标准模板下载
                </div>
                <div style="flex: 1; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-sm"
                        style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;"
                        onclick="downloadTemplate('primary')">
                        <i class="ti ti-download"></i> 小学期末模板
                    </button>
                    <button class="btn btn-sm"
                        style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;"
                        onclick="downloadTemplate('junior')">
                        <i class="ti ti-download"></i> 初中月考模板 (7-8年级)
                    </button>
                    <button class="btn btn-sm"
                        style="background: white; color: #166534; border: 1px solid #166534; font-size: 12px;"
                        onclick="downloadTemplate('grade9')">
                        <i class="ti ti-download"></i> 中考一模模板 (9年级)
                    </button>
                    <button class="btn btn-sm"
                        style="background: white; color: #0369a1; border: 1px solid #0369a1; font-size: 12px;"
                        onclick="downloadTemplate('teacher')">
                        <i class="ti ti-id"></i> 教师任课导入模板
                    </button>
                </div>
            </div>
            <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()" tabindex="0"
                role="button" aria-label="上传成绩文件，按回车键可打开文件选择器">
                <div class="upload-icon"><i class="ti ti-cloud-upload"></i></div>
                <p style="font-size:18px; margin-bottom:10px; font-weight:600;">点击上传成绩 Excel 文件</p>
                <p style="color:#94a3b8;">支持多文件上传 (.xlsx, .xls)</p>
                <input type="file" id="fileInput" multiple accept=".xlsx,.xls" hidden>
            </div>

            <!-- [新增] 届别快照管理区域 -->
            <div class="control-panel" style="background: #eff6ff; border-color: #bfdbfe; margin-top: 15px;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 5px 0; color: var(--primary); font-size: 15px;">
                        💾 届别状态管理 <span id="auto-backup-status"
                            style="font-size:11px; color:#64748b; font-weight:normal; margin-left:10px;"></span>
                    </h3>
                    <p style="font-size: 12px; color: #64748b; margin: 0;">保存当前届别所有进度（含成绩、教师设置、排座、分班结果），下次可直接恢复。</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" id="btn-save-project" onclick="saveProjectSnapshot()">
                        <i class="ti ti-download"></i> 保存项目 (.json)
                    </button>
                    <button class="btn btn-orange" id="btn-load-project"
                        onclick="document.getElementById('projectFileInput').click()">
                        <i class="ti ti-upload"></i> 恢复项目
                    </button>
                    <input type="file" id="projectFileInput" accept=".json" hidden onchange="loadProjectSnapshot(this)">
                    <button class="btn btn-danger" id="btn-reset-system" onclick="resetSystem()"
                        style="background: #dc2626; color: white;">
                        <i class="ti ti-trash"></i> 清空重置
                    </button>
                </div>
            </div>

            <div class="control-panel" id="auto-snapshot-panel"
                style="background:#fff7ed; border-color:#fed7aa; margin-top:10px;">
                <div style="flex:1;">
                    <h3 style="margin:0 0 5px 0; color:#b45309; font-size:15px;">
                        🕘 自动快照 / 回滚
                    </h3>
                    <p style="font-size:12px; color:#64748b; margin:0;">每次保存前自动保留最近 5 版，可一键回滚。</p>
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn btn-sm btn-orange"
                        onclick="createAutoSnapshot(getCurrentSnapshotPayload())">手动生成快照</button>
                </div>
                <div id="auto-snapshot-list" style="width:100%; margin-top:8px; font-size:12px; color:#7c2d12;"></div>
            </div>

            <div id="msg-box"
                style="margin-top:20px; font-weight:bold; color:var(--success); text-align:center; font-size:16px;">
            </div>
        </div>

        <!-- 2. 乡镇学校分析 -->
        <div id="analysis" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-macro)">
                <h3><i class="ti ti-world-latitude"></i> 02 镇域宏观横向评价 <span class="badge" style="background:#0ea5e9;">📊
                        班主任必看</span></h3>
                <p><strong>一句话目的：</strong>快速比较学校/班级整体水平与排名位置。</p>
                <p><strong>推荐顺序：</strong>导入完成后优先查看本模块，确定整体站位。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-chart-dots"></i> 乡镇学校分析 - 两率一分
                    <span class="module-help-btn" onclick="showModuleHelp('macro')">📘 算法说明</span>
                </h2>
                <div class="control-panel" style="margin-bottom:0; padding:5px;">
                    <input type="text" id="mySchool" placeholder="输入本校名称高亮" style="width:180px;">
                    <button class="btn" onclick="renderHorizontalTable()">生成横向对比表</button>
                    <button class="btn btn-purple" onclick="toggleTableHeatmap('horizontal-table')">🎨 开启热力图</button>
                    <button class="btn btn-green" onclick="exportMacroTables()">导出全科分析表</button>
                </div>
            </div>
            <div
                style="margin:12px 0 14px 0; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:#f8fafc;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                    <div style="font-weight:600; color:#334155;">🧭 校际联考多期对比（2期/3期）</div>
                    <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                        <label>期数：</label>
                        <select id="macroComparePeriodCount"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                            onchange="onMacroComparePeriodCountChange()">
                            <option value="2">2期</option>
                            <option value="3">3期</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                    <label style="font-size:12px; color:#475569;">学校：</label>
                    <select id="macroCompareSchool"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:130px;"></select>
                    <label style="font-size:12px; color:#475569;">第1期：</label>
                    <select id="macroCompareExam1"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    <label style="font-size:12px; color:#475569;">第2期：</label>
                    <select id="macroCompareExam2"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    <span id="macroCompareExam3Wrap" style="display:none;">
                        <label style="font-size:12px; color:#475569; margin-left:2px;">第3期：</label>
                        <select id="macroCompareExam3"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    </span>
                    <button class="btn btn-sm btn-blue" onclick="renderMacroMultiPeriodComparison()">生成校际多期对比</button>
                    <button class="btn btn-sm btn-green" onclick="exportMacroMultiPeriodComparison()">导出校际多期对比</button>
                    <button class="btn btn-sm" style="background:#8b5cf6; color:white;"
                        onclick="saveMacroMultiPeriodCompareToCloud()">☁️ 保存云端对比</button>
                    <button class="btn btn-sm" style="background:#06b6d4; color:white;"
                        onclick="viewCloudMacroCompares()">📋 查看云端对比</button>
                </div>
                <div id="macroCompareHint" style="margin-top:6px; font-size:12px; color:#64748b;">请选择2期或3期考试后生成。</div>
                <div id="macroCompareResult" style="margin-top:10px;"></div>
            </div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">快速定位</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-total', this)">🏆 综合总表</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>📘 各科详情</span><i
                            class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-subjects-container" class="side-nav-sub-container"></div>
                    <div class="side-nav-link" onclick="scrollToAnchor('horizontal-box', this)">↔️ 横向对比</div>
                </div>
                <div class="content-area">
                    <div id="anchor-total" class="anchor-target">
                        <div class="sub-header" style="margin-top:0;"><span>🏆 <span class="label-total">全科总</span> -
                                综合分析表</span></div>
                        <div class="table-wrap">
                            <table id="tb-total">
                                <thead>
                                    <tr>
                                        <th>学校名称</th>
                                        <th>实考人数</th>
                                        <th>平均分</th>
                                        <th>优秀率</th>
                                        <th>及格率</th>
                                        <th>平均分赋分</th>
                                        <th>优秀率赋分</th>
                                        <th>及格率赋分</th>
                                        <th>两率一分总分</th>
                                        <th>排名</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="subject-tables-container" class="anchor-target" style="padding-top:20px;"></div>
                    <div id="horizontal-box" class="hidden anchor-target" style="padding-top:20px;">
                        <div class="sub-header"
                            style="display:flex; justify-content:space-between; align-items:center;">
                            <span>↔️ 横向对比一览表</span>
                            <button class="btn btn-green" onclick="exportHorizontalExcel()">导出横向Excel</button>
                        </div>
                        <div class="table-wrap" id="horizontal-table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2.1 镇域预警与亮点看板 -->
        <div id="macro-watch" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-macro)">
                <h3><i class="ti ti-alert-triangle"></i> 02A 镇域预警与亮点看板</h3>
                <p>说明：集中呈现全镇核心KPI与红黄绿预警清单，便于快速定位问题学校与标杆学校。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-dashboard"></i> 风险预警与亮点总览
                    <span class="module-help-btn" onclick="showModuleHelp('macro')">📘 规则说明</span>
                </h2>
            </div>
            <div id="macro-dashboard" class="fb-dashboard" style="margin-bottom:25px;"></div>
            <div id="traffic-light-dashboard" class="traffic-grid hidden">
                <!-- 红灯区：严重预警 -->
                <div class="traffic-col red">
                    <div class="traffic-head red">
                        <span><i class="ti ti-alert-triangle-filled"></i> 红色预警 (重点整改)</span>
                        <span id="count-red" class="badge" style="background:#b91c1c">0</span>
                    </div>
                    <div style="font-size:11px; color:#b91c1c; margin-bottom:10px; opacity:0.8;">
                        触发条件: 及格率&lt;60% 或 单科排名倒数第一
                    </div>
                    <div class="traffic-list" id="list-red"></div>
                </div>

                <!-- 黄灯区：风险提示 -->
                <div class="traffic-col yellow">
                    <div class="traffic-head yellow">
                        <span><i class="ti ti-alert-circle-filled"></i> 黄色关注 (培优提升)</span>
                        <span id="count-yellow" class="badge" style="background:#b45309">0</span>
                    </div>
                    <div style="font-size:11px; color:#b45309; margin-bottom:10px; opacity:0.8;">
                        触发条件: 优秀率&lt;15% 或 临界生密集
                    </div>
                    <div class="traffic-list" id="list-yellow"></div>
                </div>

                <!-- 绿灯区：标杆示范 -->
                <div class="traffic-col green">
                    <div class="traffic-head green">
                        <span><i class="ti ti-thumb-up-filled"></i> 绿色标杆 (经验推广)</span>
                        <span id="count-green" class="badge" style="background:#15803d">0</span>
                    </div>
                    <div style="font-size:11px; color:#15803d; margin-bottom:10px; opacity:0.8;">
                        触发条件: 优秀率&gt;30% 或 综合排名第一
                    </div>
                    <div class="traffic-list" id="list-green"></div>
                </div>
            </div>
        </div>

        <!-- 2.1 新增：高分段核算独立模块 -->
        <div id="high-score" class="section card-box">
            <div class="module-desc-bar" style="border-color: #b45309">
                <h3><i class="ti ti-trophy"></i> 9年级高分段核算</h3>
                <p>考核标准：总分≥490分。赋分公式：(本校高分率 / 全镇最高高分率) × 70。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-trophy"></i> 高分段赋分详情
                    <span class="module-help-btn" onclick="showModuleHelp('high-score')">📘 核算规则</span>
                </h2>
                <button class="btn btn-green" onclick="exportHighScoreExcel()">📊 导出Excel</button>
            </div>
            <details class="explain-panel">
                <summary>口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>实考人数：本次有有效成绩的学生数。</p>
                    <p>高分人数：总分达到高分线（当前默认 ≥490）的学生数。</p>
                    <p>高分率：高分人数 ÷ 实考人数。</p>
                    <p>高分赋分：以高分率进行标准化折算，用于横向比较。</p>
                </div>
            </details>
            <div class="table-wrap">
                <table id="tb-high-score">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th>实考人数</th>
                            <th style="background:#fff7ed; color:#b45309;">高分人数 (≥490)</th>
                            <th style="background:#fff7ed; color:#b45309;">高分率</th>
                            <th style="background:#fff7ed; color:#b45309;">高分赋分 (满分70)</th>
                            <th>排名</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>


        <!-- 3. 后1/3核算 -->
        <div id="bottom3" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-arrow-bar-to-down"></i> 后1/3学生核算
                    <span class="module-help-btn" onclick="showModuleHelp('bottom3')">📘 剔除规则</span>
                    <span style="font-size:14px; font-weight:normal; color:#666; margin-left:5px;">(剔除率: <span
                            id="label-exc"></span>)</span>
                </h2>
                <button class="btn" onclick="exportExcel('bottom3')">导出结果</button>
            </div>
            <details class="explain-panel">
                <summary>口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>总人数：学校在籍人数（含缺考）。</p>
                    <p>后1/3人数：按总分从低到高排序后的后 1/3 人数。</p>
                    <p>剔除人数：按照剔除率从后 1/3 中剔除的人数。</p>
                    <p>有效后1/3均分：在剔除后，剩余后 1/3 学生的平均分。</p>
                    <p>核算得分：有效后1/3均分按全镇最高值折算，用于排名。</p>
                </div>
            </details>
            <div class="table-wrap">
                <table id="tb-bottom3">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th>总人数</th>
                            <th>后1/3人数</th>
                            <th>剔除人数</th>
                            <th>有效后1/3均分</th>
                            <th>核算得分</th>
                            <th>排名</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 4. 指标生核算 -->
        <div id="indicator" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> 指标生达标核算
                    <span class="module-help-btn" onclick="showModuleHelp('indicator')">📘 计分公式</span>
                </h2>
                <div>
                    <button class="btn btn-blue" onclick="openTargetEditor()">
                        <i class="ti ti-edit"></i> 在线调整目标
                    </button>
                    <button class="btn btn-green" id="btn-indicator-calc" onclick="calcIndicators()">开始计算</button>
                    <button class="btn" onclick="exportExcel('indicator')">导出结果</button>
                </div>
            </div>
            <details class="explain-panel">
                <summary>口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>指标线：根据设定的名次或比例自动换算为分数线。</p>
                    <p>达标人数：总分达到对应指标线的学生数。</p>
                    <p>达标率：达标人数 ÷ 实考人数。</p>
                    <p>指标得分：按达标率进行标准化折算，用于校际比较。</p>
                </div>
            </details>
            <div class="table-wrap">
                <table id="tb-indicator">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th>指标一(目标/达标)</th>
                            <th>得分</th>
                            <th>指标二(目标/达标)</th>
                            <th>得分</th>
                            <th>指标生总分</th>
                            <th>排名</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 5. 综合总排名 -->
        <div id="summary" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-report"></i> 综合分析报告 <span class="badge" style="background:#16a34a;">⭐ 教务常用</span>
                    <span class="module-help-btn" onclick="showModuleHelp('summary')">📘 权重说明</span>
                </h2>
                <div>
                    <button class="btn btn-green" onclick="calcSummary()">生成总排名</button>
                    <button class="btn btn-green" onclick="exportSummaryTable()">导出报告</button>
                    <button class="btn btn-orange" onclick="exportPPTReport()">
                        <i class="ti ti-presentation"></i> 导出汇报PPT
                    </button>
                </div>
            </div>
            <div class="table-wrap">
                <table id="tb-summary">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th>两率一分得分</th>
                            <th>后1/3得分</th>
                            <th>指标生得分</th>
                            <th>综合总分</th>
                            <th>总排名</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 6. 本校教师分析 -->
        <div id="teacher-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-school"></i> 本校教师教学分析 <span class="badge" style="background:#0ea5e9;">📊
                        班主任必看</span>
                    <span class="module-help-btn" onclick="showModuleHelp('teacher')">📘 评价模型</span>
                </h2>
                <button class="btn" onclick="exportTeacherAnalysis()">导出教师分析</button>
            </div>
            <div class="info-bar" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <span>本校教师教学分析基于导入的教师信息和成绩数据，展示教师所教班级的整体表现，并与乡镇学校进行对比。</span>
                <button id="teacher-sync-cta" class="btn btn-orange" style="display:none; white-space:nowrap;"
                    onclick="openTeacherSync()">去同步任课表</button>
            </div>
            <div
                style="margin:12px 0 14px 0; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:#f8fafc;">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                    <div style="font-weight:600; color:#334155;">🧭 教师同学科多期对比（2期/3期）</div>
                    <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                        <label>期数：</label>
                        <select id="teacherComparePeriodCount"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                            onchange="onTeacherComparePeriodCountChange()">
                            <option value="2">2期</option>
                            <option value="3">3期</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                    <label style="font-size:12px; color:#475569;">学校：</label>
                    <select id="teacherCompareSchool"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:130px;"
                        onchange="updateTeacherCompareTeacherSelect()"></select>
                    <label style="font-size:12px; color:#475569;">学科：</label>
                    <select id="teacherCompareSubject"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:110px;"
                        onchange="updateTeacherCompareTeacherSelect()"></select>
                    <label style="font-size:12px; color:#475569;">教师：</label>
                    <select id="teacherCompareTeacher"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:120px;"></select>
                    <label style="font-size:12px; color:#475569;">第1期：</label>
                    <select id="teacherCompareExam1"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    <label style="font-size:12px; color:#475569;">第2期：</label>
                    <select id="teacherCompareExam2"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    <span id="teacherCompareExam3Wrap" style="display:none;">
                        <label style="font-size:12px; color:#475569; margin-left:2px;">第3期：</label>
                        <select id="teacherCompareExam3"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    </span>
                    <button class="btn btn-sm btn-blue" onclick="renderTeacherMultiPeriodComparison()">生成教师多期对比</button>
                    <button class="btn btn-sm" style="background:#ea580c; color:white;"
                        onclick="renderAllTeachersMultiPeriodComparison()" title="生成该学校所有教师的对比表">📊 生成全校对比</button>
                    <button class="btn btn-sm btn-green"
                        onclick="exportTeacherMultiPeriodComparison()">导出教师多期对比</button>
                    <button class="btn btn-sm" style="background:#8b5cf6; color:white;"
                        onclick="saveTeacherMultiPeriodCompareToCloud()" title="保存当前对比结果到云端">☁️ 保存云端对比</button>
                    <button class="btn btn-sm" style="background:#06b6d4; color:white;"
                        onclick="viewCloudTeacherCompares()" title="查看已保存的教师对比记录">📋 查看云端对比</button>
                </div>
                <div id="teacherCompareHint" style="margin-top:6px; font-size:12px; color:#64748b;">
                    请选择学校+学科+教师并选择2期或3期考试后生成。</div>
                <div id="teacherCompareResult" style="margin-top:10px;"></div>
            </div>
            <details class="explain-panel">
                <summary>指标口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>平均分：该教师所教班级、该学科所有有效成绩的算术平均。</p>
                    <p>优秀线/及格线：按年级实考人数比例自动划定，9年级优秀线取前15%，其他年级取前20%，及格线取前50%；单校总分可按“名次线”换算。</p>
                    <p>优秀率：优秀人数 ÷ 实考人数，优秀线来自本次年级分布阈值。</p>
                    <p>及格率：及格人数 ÷ 实考人数，及格线来自本次年级分布阈值。</p>
                    <p>优秀人数：分数 ≥ 优秀线的人数；及格人数：分数 ≥ 及格线的人数。</p>
                    <p>低分人数：分数 &lt; 低分线的人数（低分线 = 及格线 × 0.6）。</p>
                    <p>低分率：低于“及格线 × 0.6”的占比；如未生成及格线则按 60 分口径计算。</p>
                    <p>与级比：与年级平均水平的差值（均分/优率/及格率分别对比）。</p>
                    <p>贡献值：教师均分 − 年级均分（同学科），反映“相对提升”。</p>
                    <p>综合得分：基准分 + 贡献值 + 优秀率权重 + 及格率权重 − 低分率惩罚，用于校内横向比较。</p>
                    <p>校内排名：同学科教师按综合得分排序，分数并列时共享名次。</p>
                </div>
            </details>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">功能导航</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-cards', this)">📇 教师概况卡片</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-detail', this)">📊 详细数据对比</div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-pair', this)">🤝 结对子建议</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>🏅 乡镇排名</span><i
                            class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-teacher-ranks-container" class="side-nav-sub-container"></div>
                </div>
                <div class="content-area">
                    <div id="anchor-cards" class="anchor-target"> <!-- 使用 x-data 声明这是一个 Alpine 组件，x-show 控制显示 -->
                        <div class="teacher-cards-container" id="teacherCardsContainer" x-data>

                            <!-- 空状态提示 -->
                            <div x-show="$store.teacherData.list.length === 0"
                                style="grid-column: 1/-1; text-align:center; color:#999; padding:20px;">
                                暂无教师数据，请先在上方配置并导入。
                                <div style="margin-top:10px;">
                                    <button class="btn btn-orange" onclick="openTeacherSync()">去同步任课表</button>
                                </div>
                            </div>

                            <!-- 循环渲染卡片 -->
                            <template x-for="item in $store.teacherData.list" :key="item.id">
                                <div class="teacher-card">
                                    <div class="teacher-header">
                                        <div>
                                            <div class="teacher-name" x-text="item.name + ' - ' + item.subject"></div>
                                            <div class="teacher-classes" x-text="item.classes + '班'"></div>
                                        </div>
                                        <div :class="`performance-badge ${item.badgeClass}`" x-text="item.badgeText">
                                        </div>
                                    </div>
                                    <div class="teacher-stats">
                                        <div class="stat-item">
                                            <div class="stat-value" x-text="item.avg"></div>
                                            <div class="stat-label">平均分</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" x-text="item.excRate"></div>
                                            <div class="stat-label">优秀率</div>
                                        </div>
                                        <div class="stat-item">
                                            <div class="stat-value" x-text="item.passRate"></div>
                                            <div class="stat-label">及格率</div>
                                        </div>
                                    </div>
                                    <div
                                        style="display:flex; justify-content:space-between; font-size:12px; color:#666; margin-bottom:15px; padding:0 10px;">
                                        <span>学生: <span x-text="item.count"></span>人</span>
                                        <span>镇排: <strong style="color:var(--primary)"
                                                x-text="item.rank"></strong></span>
                                    </div>
                                    <!-- 点击事件直接绑定 JS 函数 -->
                                    <button class="view-details-btn"
                                        @click="showTeacherDetails(item.name, item.subject)">查看详情</button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div id="anchor-detail" class="anchor-target" style="padding-top:30px;">
                        <div class="sub-header"
                            style="display:flex; justify-content:space-between; align-items:center;">
                            <span>📊 教师教学详细数据对比表</span>
                            <button class="btn btn-green" onclick="exportTeacherComparisonExcel()">导出Excel</button>
                        </div>
                        <div class="table-wrap">
                            <table class="comparison-table" id="teacherComparisonTable">
                                <thead>
                                    <tr>
                                        <th rowspan="2">教师姓名</th>
                                        <th rowspan="2">学科</th>
                                        <th rowspan="2">任教班级</th>
                                        <th rowspan="2">人数</th>
                                        <th colspan="3">平均分</th>
                                        <th colspan="3">优秀率</th>
                                        <th colspan="3">及格率</th>
                                        <th rowspan="2">综合得分</th>
                                        <th rowspan="2">校内排名</th>
                                    </tr>
                                    <tr>
                                        <th>实际值</th>
                                        <th>与级比</th>
                                        <th>排名</th>
                                        <th>实际值</th>
                                        <th>与级比</th>
                                        <th>排名</th>
                                        <th>实际值</th>
                                        <th>与级比</th>
                                        <th>排名</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="anchor-pair" class="anchor-target" style="padding-top:30px;">
                        <div id="teacher-pairing-box">
                            <div class="sub-header">🤝 校内教师“结对子”互助建议 (基于数据分析)</div>
                            <div id="teacher-pairing-suggestions" class="pairing-container"></div>
                        </div>
                    </div>
                    <div id="teacher-township-ranking-container"></div>
                    <div style="margin-top:10px; text-align:right;"><button class="btn btn-green"
                            onclick="exportTeacherTownshipRankExcel()">导出教师乡镇排名</button></div>
                </div>
            </div>
        </div>

        <!-- ================== 新增模块：校内绩效公平考核 (单校模式) ================== -->
        <div id="single-school-eval" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-internal)">
                <h3><i class="ti ti-scale"></i> 03 校内绩效管理与评价</h3>
                <p>说明：面向校长室。解决生源不均导致的考核不公，通过“生源增值模型”和“大班额补偿系数”，科学核算每位教师、每个班级的真实教学贡献。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-scale"></i> 校内绩效公平考核模型
                    <span class="module-help-btn" onclick="showModuleHelp('sse')">📘 100分制详解</span>
                </h2>
                <button class="btn btn-green" onclick="SSE_calculate()">🚀 开始考核计算</button>
            </div>
            <details class="explain-panel">
                <summary>绩效分口径说明（点击展开）</summary>
                <div class="explain-content">
                    <p>实考人数：本次有有效成绩的学生数；在籍人数用于计算班额补偿。</p>
                    <p>优秀率/及格率：按年级实考分布划线，优秀线为前 25%，及格线为前 80%。</p>
                    <p>均分对比：班级均分与年级均分对比后折算为权重分。</p>
                    <p>生源增值：在有历史数据时，基于学生名次变化的班级平均增量；未勾选或无历史数据则记 0 分。</p>
                    <p>大班补偿分：班级在籍人数与年级平均班额的差值 × 0.1，体现管理成本。</p>
                    <p>最终绩效分：优秀率、及格率、均分对比、生源增值及班额补偿的加总，用于校内公平排序。</p>
                </div>
            </details>

            <!-- 核心理念展示区 -->
            <div
                style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); border: 1px solid #bae6fd; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #0369a1; margin-bottom: 10px; font-size: 18px;"><i class="ti ti-bulb"></i>
                    核心理念：“不让老实人吃亏”</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    <div
                        style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">1. 不看人口看密度 (35+35分)
                        </div>
                        <p style="font-size: 12px; color: #666;">
                            摒弃“优生人数”绝对值，改用<strong>“优秀率/及格率”</strong>。<br>
                            <span style="background: #dcfce7; padding: 1px 4px;">60人班15个优生 = 40人班10个优生</span>，得分完全一致。
                        </p>
                    </div>
                    <div
                        style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">2. 不看起点看变化 (10分)
                        </div>
                        <p style="font-size: 12px; color: #666;">
                            引入<strong>“生源增值分”</strong>。对比上次考试排位百分比变化。<br>
                            差班从年级后20%进步到后40%，即视为高绩效，奖励<strong>“加工能力”</strong>。
                        </p>
                    </div>
                    <div
                        style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 5px;">3. 大班额补偿系数 (额外加分)
                        </div>
                        <p style="font-size: 12px; color: #666;">
                            承认管理成本。以年级平均人数为基准。<br>
                            每多 <strong>1</strong> 名学生，总分额外补偿 <strong>0.1</strong> 分辛苦分。
                        </p>
                    </div>
                </div>
            </div>

            <!-- 控制面板 -->
            <div class="control-panel">
                <div style="flex: 1;">
                    <label><strong>选择考核学校：</strong></label>
                    <select id="sse_school_select" style="min-width: 200px; padding: 8px;">
                        <option value="">-- 请选择 --</option>
                    </select>
                </div>
                <div style="flex: 2; display: flex; gap: 15px; align-items: center; font-size: 13px;">
                    <label><input type="checkbox" id="sse_check_exc" checked> 优秀贡献(前25%)</label>
                    <label><input type="checkbox" id="sse_check_pass" checked> 及格保底(前80%)</label>
                    <label><input type="checkbox" id="sse_check_avg" checked> 均分水位</label>
                    <label><input type="checkbox" id="sse_check_prog" checked> 生源增值</label>
                </div>
                <div style="border-left: 1px solid #ccc; padding-left: 15px;">
                    <button class="btn btn-purple" onclick="SSE_export()">📥 导出考核表</button>
                </div>
            </div>

            <!-- 结果展示区 -->
            <div id="sse_result_container" class="hidden">
                <div class="sub-header">
                    <span>📊 绩效赋分排行榜</span>
                    <span style="font-size: 12px; font-weight: normal; margin-left: 10px;">
                        (基准: 优秀35 + 及格35 + 均分20 + 增值10 = 100分 + 班额补偿)
                    </span>
                </div>
                <div class="table-wrap">
                    <table id="sse_table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>班级</th>
                                <th>班主任/教师</th>
                                <th>实考人数</th>
                                <th>大班补偿分</th>
                                <th>优秀率(25%)<br><small style="color:#999">权重35</small></th>
                                <th>及格率(80%)<br><small style="color:#999">权重35</small></th>
                                <th>均分对比<br><small style="color:#999">权重20</small></th>
                                <th>生源增值<br><small style="color:#999">权重10</small></th>
                                <th style="background: #eff6ff; color: #1e3a8a;">最终考核分</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div
                    style="margin-top: 15px; font-size: 12px; color: #666; background: #f9fafb; padding: 10px; border-radius: 6px;">
                    <strong>ℹ️ 算法说明：</strong><br>
                    1. <strong>优秀/及格得分：</strong> (本班率 / 年级最高率) × 权重分。鼓励向最高标准看齐。<br>
                    2. <strong>均分得分：</strong> (本班均分 / 年级均分) × 权重分。<br>
                    3. <strong>生源增值：</strong> 计算全班学生排位百分比变化的平均值。正值为进步。按 (进步值 / 最大进步值) × 10 计算，退步者此项从低计分。<br>
                    4. <strong>大班补偿：</strong> (班级人数 - 年级平均人数) × 0.1。人数少于平均线不扣分。
                </div>
            </div>
        </div>

        <!-- 学科深度关联分析 -->
        <div id="correlation-analysis" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-topology-star-3"></i> 学科贡献度与关联性深度分析</h2><button class="btn btn-green"
                    onclick="exportCorrelationExcel()">导出分析Excel</button>
            </div>
            <div class="info-bar">探索学科间的内在联系以及各学科对总分排名的贡献度（区分度）。</div>
            <div class="control-panel">
                <label>分析范围：</label><select id="corrSchoolSelect" style="min-width:200px;">
                    <option value="ALL">全乡镇</option>
                </select>
                <button class="btn btn-purple" onclick="renderCorrelationAnalysis()">🚀 开始深度分析</button>
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:20px;">
                <div class="bg-gray-50">
                    <h3 style="margin-bottom:15px; color:#333;">🔗 学科间相关性热力矩阵 (Pearson)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">数值越接近1.0(深红)，表示两科成绩越同步。</p>
                    <div class="table-wrap" style="box-shadow:none; border:none; margin-top:0;">
                        <table class="heatmap-table" id="corrMatrixTable">
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50">
                    <h3 style="margin-bottom:15px; color:#333;">⚖️ 学科对总排名贡献度 (区分度)</h3>
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">数值越高，说明该学科越能决定总排名的位次。</p>
                    <div id="contributionChartContainer"></div>
                </div>
            </div>
            <div class="bg-gray-50" style="margin-top:20px;">
                <h3 style="margin-bottom:15px; color:#333;">📉 “提分项”与“拖后腿”频率分析</h3>
                <div class="table-wrap">
                    <table id="liftDragTable">
                        <thead>
                            <tr>
                                <th>学科</th>
                                <th>提分主力 (单科排名前于总排)</th>
                                <th>拖分主力 (单科排名后于总排)</th>
                                <th>平衡型</th>
                                <th>净贡献 (提分-拖分)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 临界生精准辅导任务单 -->
        <div id="marginal-push" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-target-arrow"></i> 04 精准诊断与干预</h3>
                <p>说明：面向一线科任教师。挖掘临界生（拟优秀、拟及格）、偏科生以及成绩波动剧烈的“过山车”学生，生成任务单实现精准帮扶。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-target"></i> 临界生精准辅导任务单
                    <span class="module-help-btn" onclick="showModuleHelp('student-diag')">📘 筛选逻辑</span>
                </h2>
                <div>
                    <button class="btn btn-purple" onclick="printMarginalTickets()">🖨 批量打印任务单</button>
                    <button class="btn btn-green" onclick="exportMarginalTasks()">📊 导出Excel</button>
                </div>
            </div>

            <div class="info-bar">
                <strong>核心策略：</strong> 筛选出距离“优秀线”或“及格线”仅差
                <span style="border-bottom:2px solid var(--primary); font-weight:bold;">N分</span>
                的学生，生成科任教师的重点关注名单。
            </div>

            <div class="control-panel" style="background: #fffbeb; border-color: #fcd34d;">
                <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                    <div>
                        <label>选择学校：</label><br>
                        <select id="mpSchoolSelect" style="min-width:150px;" onchange="updateMpClassSelect()">
                            <option value="">--请选择--</option>
                        </select>
                    </div>
                    <div>
                        <label>班级 (可选)：</label><br>
                        <select id="mpClassSelect" style="min-width:100px;">
                            <option value="">全部班级</option>
                        </select>
                    </div>
                    <div>
                        <label>学科：</label><br>
                        <select id="mpSubjectSelect" style="min-width:100px;">
                            <option value="ALL">全部学科</option>
                        </select>
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:15px;">
                        <label><strong>🎯 临界分值 (Gap)</strong>：</label><br>
                        <input type="number" id="mpGap" value="5" style="width:70px; font-weight:bold; color:red;"> 分以内
                    </div>
                    <div>
                        <label>目标类型：</label><br>
                        <select id="mpType">
                            <option value="both" selected>全部 (拟优+拟及格)</option>
                            <option value="pass">仅看 拟及格 (保底)</option>
                            <option value="exc">仅看 拟优秀 (培优)</option>
                        </select>
                    </div>
                    <div style="padding-top:16px;">
                        <button class="btn btn-primary" onclick="generateMarginalTickets()">🚀 生成辅导单</button>
                    </div>
                </div>
            </div>

            <!-- 闭环管理：转化率追踪面板 -->
            <div style="margin:15px 0; background:#f0fdf4; border:1px solid #86efac; border-radius:8px; padding:15px;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px dashed #bbf7d0; padding-bottom:10px; margin-bottom:10px;">
                    <h3 style="color:#166534; margin:0; font-size:15px;"><i class="ti ti-refresh"></i> 临界生转化闭环管理 (教师评价)
                    </h3>
                    <div style="font-size:12px; color:#15803d;">
                        逻辑：保存本次生成的名单为“历史任务” -> 下次考试导入数据 -> 自动计算有多少人成功“上线”
                    </div>
                </div>

                <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                    <!-- 动作A: 存档 -->
                    <div style="flex:1; border-right:1px solid #bbf7d0; padding-right:15px;">
                        <div style="font-weight:bold; color:#166534; margin-bottom:5px;">第1步：当前任务存档</div>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="mp_save_name" placeholder="任务名 (如:期中临界生)"
                                style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; flex:1;">
                            <button class="btn btn-green btn-sm" onclick="MP_saveSnapshot()">💾 存档</button>
                        </div>
                    </div>

                    <!-- 动作B: 追踪 -->
                    <div style="flex:2;">
                        <div style="font-weight:bold; color:#166534; margin-bottom:5px;">第2步：转化效果追踪 (需先上传新数据)</div>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select id="mp_snapshot_select"
                                style="padding:5px; border:1px solid #cbd5e1; border-radius:4px; font-size:12px; min-width:150px;">
                                <option value="">-- 选择历史任务 --</option>
                            </select>
                            <button class="btn btn-orange btn-sm" onclick="MP_analyzeConversion()">📈 计算转化率</button>
                            <button class="btn btn-gray btn-sm" onclick="MP_deleteSnapshot()"><i
                                    class="ti ti-trash"></i></button>
                        </div>
                    </div>
                </div>

                <!-- 分析结果展示区 -->
                <div id="mp-conversion-result" class="hidden"
                    style="margin-top:15px; background:white; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                    <div class="sub-header" style="margin-top:0;">📊 教师辅导效能评估 (基于转化率)</div>
                    <div class="table-wrap">
                        <table id="mp_conversion_table" style="font-size:12px;">
                            <thead>
                                <tr>
                                    <th>教师/班级</th>
                                    <th>学科</th>
                                    <th>目标类型</th>
                                    <th>追踪人数 (历史)</th>
                                    <th>本次上线人数</th>
                                    <th>转化成功率</th>
                                    <th>评价</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 任务单预览区 -->
            <div id="mp-tickets-container" class="mp-grid">
                <div style="grid-column:1/-1; text-align:center; padding:50px; color:#94a3b8;">
                    <i class="ti ti-clipboard-list" style="font-size:48px; margin-bottom:10px;"></i>
                    <p>请调整参数后点击“生成辅导单”</p>
                </div>
            </div>
        </div>

        <!-- 考后座位微调建议 -->
        <div id="seat-adjustment" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-armchair"></i> 考后“座位微调”建议</h2>
            </div>
            <div class="info-bar">基于最近发展区理论(ZPD)与小组合作学习模式，生成促进互助的座位表。</div>

            <!-- [修改] 考后座位微调 - 交互优化后的约束框 -->
            <div class="constraints-box">
                <h4><i class="ti ti-alert-triangle"></i> 特殊情况约束配置 (智能标签输入)</h4>
                <div class="info-bar" style="margin:0 0 10px 0; padding:5px; font-size:11px;">💡
                    提示：在输入框中输入姓名，从下拉菜单中选择。数据源为当前选中的班级。</div>
                <div class="constraints-grid">
                    <div><label>😡 难管/调皮:</label><input type="hidden" id="adj_c_diff">
                        <div id="widget_adj_diff" class="tag-widget-container"><input type="text"
                                class="tag-input-field" placeholder="搜姓名...">
                            <div class="suggestion-dropdown"></div>
                        </div>
                    </div>
                    <div><label>👓 视力不好 (前排):</label><input type="hidden" id="adj_c_vision">
                        <div id="widget_adj_vision" class="tag-widget-container"><input type="text"
                                class="tag-input-field" placeholder="搜姓名...">
                            <div class="suggestion-dropdown"></div>
                        </div>
                    </div>
                    <div><label>❤️ 心理关注:</label><input type="hidden" id="adj_c_psy">
                        <div id="widget_adj_psy" class="tag-widget-container"><input type="text" class="tag-input-field"
                                placeholder="搜姓名...">
                            <div class="suggestion-dropdown"></div>
                        </div>
                    </div>
                    <div><label>🗣️ 爱说话:</label><input type="hidden" id="adj_c_talk">
                        <div id="widget_adj_talk" class="tag-widget-container"><input type="text"
                                class="tag-input-field" placeholder="搜姓名...">
                            <div class="suggestion-dropdown"></div>
                        </div>
                    </div>
                    <div style="grid-column: 1/-1"><label>⚔️ 互有矛盾/避免同桌 (生成器):</label>
                        <div class="conflict-builder"><select id="conflict_sel_a">
                                <option value="">学生 A</option>
                            </select><span>&</span><select id="conflict_sel_b">
                                <option value="">学生 B</option>
                            </select><button class="btn btn-gray" style="padding:2px 8px; height:28px;"
                                onclick="addConflictPair('adj')">➕ 添加</button></div><input type="hidden"
                            id="adj_c_conflict">
                        <div id="widget_adj_conflict" class="tag-widget-container" style="background:#f9fafb;"><span
                                style="font-size:11px; color:#999; padding:4px;">请使用上方选择器添加矛盾对</span></div>
                    </div>
                </div>
            </div>

            <div class="control-panel">
                <div style="flex:2; display:flex; gap:10px; flex-wrap:wrap;">
                    <div><label>学校：</label><br><select id="seatAdjSchoolSelect" style="min-width:120px;">
                            <option value="">--请选择--</option>
                        </select></div>
                    <div><label>班级：</label><br><select id="seatAdjClassSelect" style="min-width:100px;">
                            <option value="">--班级--</option>
                        </select></div>
                    <div><label>左右大组数 (中间过道)：</label><br><input type="number" id="seatAdjGroups" value="2" min="1"
                            max="4" style="width:60px;" onchange="renderSeatGrid()"></div>
                    <div><label>每组列数：</label><br><input type="number" id="seatAdjCols" value="4" min="2" max="6"
                            style="width:60px;" onchange="renderSeatGrid()"></div>
                    <div><label>分组策略：</label><br>
                        <select id="seatAdjStrategy">
                            <option value="conversion">🚀 提分转化型 (A带C, B带D)</option>
                            <option value="balanced">⚖️ 团队PK型 (4人均分平衡)</option>
                            <option value="pair">🤝 传统互助型 (强弱结对)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateSeatSuggestions()">🎲 生成共同体座次</button>
                <button class="btn btn-purple" onclick="window.print()">🖨 打印</button>
            </div>
            <div id="seat-adj-workspace" class="seat-workspace hidden" style="margin-top:20px;">
                <div class="seat-tools" style="width:200px;">
                    <h4 style="margin-bottom:10px;">策略说明</h4>
                    <div id="seat-strategy-desc"
                        style="font-size:12px; color:#666; margin-bottom:15px; padding:10px; background:#e0f2fe; border-radius:6px;">
                        选择策略后查看详细说明...
                    </div>
                    <h4 style="margin-bottom:10px;">图例</h4>
                    <div style="font-size:12px; display:flex; flex-direction:column; gap:5px;">
                        <span style="background:#dcfce7; padding:2px 5px; border-radius:4px;">🟩 前25% (A层:优)</span>
                        <span style="background:#e0f2fe; padding:2px 5px; border-radius:4px;">🟦 25-50% (B层:良)</span>
                        <span style="background:#fef9c3; padding:2px 5px; border-radius:4px;">🟨 50-75% (C层:潜)</span>
                        <span style="background:#fee2e2; padding:2px 5px; border-radius:4px;">🟥 后25% (D层:基)</span>
                    </div>
                    <div id="seat-stats" style="margin-top:20px; font-size:12px; color:#333; font-weight:bold;"></div>
                </div>
                <div class="seat-canvas" style="min-height:500px;">
                    <div class="seat-stage">讲 台</div>
                    <div id="seat-count-display" style="margin-bottom:10px; font-weight:bold; color:#666;"></div>
                    <div id="seat-adj-container" class="seat-container" style="position:relative;"></div>
                </div>
            </div>
        </div>

        <!-- 学科互助分组 -->
        <div id="mutual-aid" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-friends"></i> 学科互助分组</h2><button class="btn btn-green"
                    onclick="exportMutualAidGroups()">导出Excel</button>
            </div>
            <div class="info-bar">
                <strong>组长(小老师)选拔标准：</strong>
                ① 单科成绩班级前 <strong>25%</strong>；
                ② 总分成绩班级前 <strong>40%</strong> (拒绝严重偏科，确保综合辅导能力)。
            </div>
            <div class="control-panel">
                <div style="flex:1; border-right:1px solid #ccc; padding-right:10px; margin-right:10px;">
                    <label><strong>数据源：</strong></label>
                    <select id="aid_source" style="width:100%; margin-top:5px;" onchange="updateMutualAidSelects()">
                        <option value="upload">📊 上传的考试成绩 (老生)</option>
                        <option value="freshman">🚀 新生分班结果 (新生)</option>
                    </select>
                </div>
                <div style="flex:2; display:flex; gap:10px; flex-wrap:wrap;">
                    <div><label>学校：</label><br><select id="aidSchoolSelect" style="min-width:120px;">
                            <option value="">--请选择--</option>
                        </select></div>
                    <div><label>班级：</label><br><select id="aidClassSelect" style="min-width:100px;">
                            <option value="">--班级--</option>
                        </select></div>
                    <div><label>互助学科：</label><br><select id="aidSubjectSelect" style="min-width:100px;">
                            <option value="total">总分(综合)</option>
                        </select></div>
                    <div><label>每组人数：</label><br><input type="number" id="aidGroupSize" value="4" min="2" max="8"
                            style="width:60px;"></div>
                </div>
                <button class="btn btn-primary" onclick="renderMutualAidGroups()">⚡ 生成分组</button>
            </div>
            <div id="aid-groups-container" class="aid-grid">
                <div style="grid-column:1/-1; text-align:center; padding:40px; color:#999;">
                    <i class="ti ti-users" style="font-size:48px; margin-bottom:10px;"></i>
                    <p>请选择班级和学科后点击生成</p>
                </div>
            </div>
        </div>

        <!-- 7. 班级横向对比 -->
        <div id="class-comparison" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-layout-columns"></i> 班级横向对比分析
                    <span class="module-help-btn" onclick="showModuleHelp('class-comp')">📘 全景矩阵说明</span>
                </h2>
            </div>
            <div class="info-bar">对比同一学校内各班级的各项指标，独立于教师分析。</div>
            <div class="control-panel">
                <label>选择学校：</label><select id="classCompSchoolSelect" style="min-width:200px;">
                    <option value="">--请选择--</option>
                </select>
                <button class="btn" onclick="renderClassComparison()">开始对比</button>
                <button class="btn btn-green" onclick="exportClassComparisonExcel()">导出Excel</button>
                <div style="border-left:1px solid #ccc; padding-left:10px; margin-left:10px; display:flex; gap:5px;">
                    <button class="btn btn-purple" onclick="toggleTableHeatmap('class-comp-results')">🎨 热力图</button>
                    <div style="position:relative;">
                        <button class="btn btn-gray" onclick="toggleColFilterMenu()" id="btn-col-filter">👁️
                            筛选学科</button>
                        <div id="col-filter-popover" class="filter-popover">
                            <!-- JS 动态填充复选框 -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">快速定位</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-class-total', this)">📊 总分对比</div>
                    <div class="side-nav-link" onclick="toggleSubNav(this)"><span>📘 单科详情</span><i
                            class="ti ti-chevron-right nav-caret"></i></div>
                    <div id="side-nav-class-subjects" class="side-nav-sub-container"></div>
                </div>
                <div class="content-area" id="class-comp-results"></div>
            </div>
        </div>

        <!-- 8. 班情诊断 -->
        <div id="class-diagnosis" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-activity"></i> 班情诊断 (标准差/分化度分析)</h2><button class="btn btn-green"
                    onclick="exportDiagnosisExcel()">导出诊断表</button>
            </div>
            <div class="info-bar">通过标准差（SD）判断班级成绩是“两极分化”还是“整体均衡”。</div>
            <div class="control-panel">
                <label>学校：</label><select id="diagSchoolSelect" style="min-width:200px;">
                    <option value="">--请选择--</option>
                </select>
                <label style="margin-left:15px;">学科：</label><select id="diagSubjectSelect" style="min-width:100px;">
                    <option value="total">总分</option>
                </select>
                <label style="margin-left:15px;">间距：</label><input type="number" id="diagStep" value="10"
                    style="width:80px;" placeholder="分">
                <button class="btn" style="margin-left:15px;" onclick="renderClassDiagnosis()">诊断分析</button>
            </div>
            <div id="diagnosis-results">
                <div style="text-align:center; padding:40px; color:#94a3b8;"><i class="ti ti-chart-bar"
                        style="font-size:48px; display:block; margin-bottom:10px;"></i>
                    <p>请选择学校和学科开始诊断</p>
                </div>
            </div>
        </div>

        <!-- 9. 分数段统计 -->
        <div id="segment-analysis" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-chart-histogram"></i> 分数段统计分析</h2><button class="btn btn-green"
                    onclick="renderSegmentAnalysis()">生成统计表</button><button class="btn btn-green"
                    onclick="exportSegmentExcel()">导出Excel</button>
            </div>
            <div class="control-panel">
                <label>统计范围：</label><select id="segSchoolSelect" style="min-width:150px;">
                    <option value="ALL">全乡镇</option>
                </select>
                <label style="margin-left:10px;">学科：</label><select id="segSubjectSelect" style="min-width:100px;">
                    <option value="total">总分</option>
                </select>
                <label style="margin-left:10px;">分段跨度：</label><input type="number" id="segStep" value="10"
                    style="width:80px;">
            </div>
            <div
                style="background:white; padding:15px; border:1px solid #e2e8f0; border-radius:8px; margin-bottom:15px; height:350px; position:relative;">
                <canvas id="segmentChart"></canvas>
            </div>
            <div class="table-wrap">
                <table id="tb-segment">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 10. 学生考试明细 -->
        <div id="student-details" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-student)">
                <h3><i class="ti ti-users"></i> 学生考试明细 <span class="badge" style="background:#16a34a;">⭐ 教务常用</span>
                </h3>
                <p><strong>一句话目的：</strong>快速查看学生明细与班级成绩列表。</p>
                <p><strong>推荐顺序：</strong>总体分析后进入本模块进行班级/学生筛选。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-users"></i> 学生考试明细</h2><button class="btn"
                    onclick="exportStudentDetails()">导出Excel</button>
            </div>
            <div class="control-panel">
                <label>选择本校：</label><select id="studentSchoolSelect" style="min-width:150px;">
                    <option value="">--请选择--</option>
                </select>
                <label style="margin-left: 10px;">选择班级：</label><select id="studentClassSelect" style="min-width:120px;">
                    <option value="">全部</option>
                </select>
                <span id="classTeacherViewModeWrap" style="display:none; margin-left:10px;">
                    <label>查看模式：</label>
                    <select id="classTeacherViewMode" style="min-width:140px;">
                        <option value="class_all">本班全科</option>
                        <option value="teaching">任教学科</option>
                    </select>
                </span>
                <button class="btn" onclick="renderStudentDetails()">筛选查询</button>
                <button class="btn btn-green" style="margin-left:auto;" onclick="generateMobileLongImage()">
                    <i class="ti ti-photo-scan"></i> 生成班级成绩长图 (手机端)
                </button>
                <button class="btn btn-orange" onclick="generateInquiryPackage()">
                    <i class="ti ti-package"></i> 生成家长查分包 (HTML)
                </button>
                <button class="btn btn-primary" style="background:#0891b2;" onclick="generateClassPPT()">
                    <i class="ti ti-presentation"></i> 生成班级分析会 PPT
                </button>
            </div>

            <!-- 🆕 学生多期成绩对比 -->
            <div id="student-multi-period-compare-section"
                style="margin:16px 0 14px 0; padding:12px; border:1px solid #e2e8f0; border-radius:8px; background:#f8fafc; display:none;">
                <div
                    style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <div style="font-weight:600; color:#334155;">📊 学生多期成绩对比（2期/3期）</div>
                    <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                        <label>期数：</label>
                        <select id="studentComparePeriodCount"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                            onchange="onStudentComparePeriodCountChange()">
                            <option value="2">2期</option>
                            <option value="3">3期</option>
                        </select>
                    </div>
                </div>
                <!-- 🔐 [权限控制]：只有管理员、年级主任、教务主任能看到的选择界面 -->
                <div id="student-compare-admin-controls"
                    style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                    <label style="font-size:12px; color:#475569;">学校：</label>
                    <select id="studentCompareSchool"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:130px;"></select>
                    <label style="font-size:12px; color:#475569;">第1期：</label>
                    <select id="studentCompareExam1"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    <label style="font-size:12px; color:#475569;">第2期：</label>
                    <select id="studentCompareExam2"
                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    <span id="studentCompareExam3Wrap" style="display:none;">
                        <label style="font-size:12px; color:#475569; margin-left:2px;">第3期：</label>
                        <select id="studentCompareExam3"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                    </span>
                    <button class="btn btn-sm btn-blue" onclick="renderStudentMultiPeriodComparison()">生成全校学生对比</button>
                    <button class="btn btn-sm" style="background:#8b5cf6; color:white;"
                        onclick="saveStudentCompareToCloud()" title="保存对比结果到云端，供老师/家长查看">☁️ 保存到云端</button>
                </div>
                <!-- 🔐 [教师可见]：查看云端对比和导出功能 -->
                <div id="student-compare-teacher-controls"
                    style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                    <button class="btn btn-sm" style="background:#06b6d4; color:white;"
                        onclick="viewCloudStudentCompares()" title="查看已保存的云端对比结果">📋 查看云端对比</button>
                    <button class="btn btn-sm btn-green" onclick="exportStudentMultiPeriodComparison()">导出Excel</button>
                    <span style="font-size:12px; color:#64748b; margin-left:8px;">提示：教师只能查看自己任教班级的对比数据</span>
                </div>
                <div
                    style="display:flex; gap:8px; align-items:center; margin-top:8px; padding-top:8px; border-top:1px solid #e2e8f0; flex-wrap:wrap;">
                    <label style="font-size:12px; color:#475569;">🔍 筛选：</label>
                    <input type="text" id="studentCompareNameInput" placeholder="输入姓名（可用逗号分隔多个）"
                        style="padding:4px 8px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"
                        onkeypress="if(event.key==='Enter') filterStudentCompareByName()">
                    <button class="btn btn-sm" onclick="filterStudentCompareByName()">查询姓名</button>
                    <button class="btn btn-sm" style="background:#10b981; color:white;"
                        onclick="filterByProgress('improve')">只看进步</button>
                    <button class="btn btn-sm" style="background:#ef4444; color:white;"
                        onclick="filterByProgress('decline')">只看退步</button>
                    <button class="btn btn-sm btn-gray" onclick="clearStudentCompareFilter()">显示全部</button>
                    <span style="margin-left:auto; display:flex; gap:6px; align-items:center;">
                        <label style="font-size:12px; color:#475569;">显示：</label>
                        <select id="studentCompareGroupBy"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                            onchange="toggleGroupDisplay()">
                            <optgroup label="📋 列表视图">
                                <option value="none">全部学生（列表）</option>
                            </optgroup>
                            <optgroup label="📁 班级分组" id="classGroupOptions">
                                <option value="class">所有班级（分组显示）</option>
                            </optgroup>
                        </select>
                        <label style="font-size:12px; color:#475569; margin-left:8px;">排序：</label>
                        <select id="studentCompareSortBy"
                            style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                            onchange="sortStudentCompare()">
                            <option value="class">按班级+姓名</option>
                            <option value="totalDesc">按最近总分降序</option>
                            <option value="totalAsc">按最近总分升序</option>
                            <option value="improveDesc">按进步幅度降序</option>
                            <option value="improveAsc">按退步幅度降序</option>
                            <option value="rankImprove">按排名提升降序</option>
                        </select>
                    </span>
                </div>
                <div id="studentCompareHint" style="margin-top:6px; font-size:12px; color:#64748b;">
                    <span id="student-compare-hint-admin">请选择学校和2期或3期考试后生成对比。生成后可保存到云端，供老师、班主任、家长等查看。</span>
                    <span id="student-compare-hint-teacher"
                        style="display:none;">请点击"查看云端对比"按钮查看已保存的学生对比数据。您只能查看自己任教班级的学生数据。</span>
                </div>
                <div id="studentCompareSummary" style="margin-top:10px;"></div>
                <div id="studentComparePagination"
                    style="margin-top:10px; display:none; padding:8px; background:#f8fafc; border-radius:6px; display:flex; justify-content:space-between; align-items:center; font-size:12px;">
                    <div>
                        <label style="color:#475569;">每页显示：</label>
                        <select id="studentComparePageSize"
                            style="padding:3px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                            onchange="changePageSize()">
                            <option value="10">10人</option>
                            <option value="20" selected>20人</option>
                            <option value="30">30人</option>
                            <option value="50">50人</option>
                            <option value="999999">全部</option>
                        </select>
                        <span id="studentComparePaginationInfo" style="margin-left:15px; color:#64748b;"></span>
                    </div>
                    <div id="studentComparePaginationButtons" style="display:flex; gap:5px;"></div>
                </div>
                <div id="studentCompareResult" style="margin-top:10px;"></div>
            </div>

            <div class="table-wrap">
                <table id="studentDetailTable" class="mobile-card-table">
                    <thead>
                        <tr>
                            <th>学校</th>
                            <th>班级</th>
                            <th>姓名</th>
                            <th>考号</th>
                            <th>考场</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="mobile-share-render-area" class="mobile-share-container"></div>
        </div>

        <!-- 进退步追踪分析 (修复缺失模块) -->
        <div id="progress-analysis" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-diag)">
                <h3><i class="ti ti-trending-up"></i> 进退步追踪与增值评价 <span class="badge" style="background:#f59e0b;">📊
                        班主任必看</span></h3>
                <p><strong>一句话目的：</strong>定位学生进退步与班级增值效果。</p>
                <p><strong>推荐顺序：</strong>先上传历史成绩，再进入本模块看进步分布。</p>
            </div>
            <div class="sec-head">
                <h2>
                    <i class="ti ti-trending-up"></i> 学生进退步追踪分析
                    <span class="module-help-btn" onclick="showModuleHelp('value-added')">📘 增值评价</span>
                </h2>
                <div style="display:flex; gap:10px;">
                    <div style="display:flex; border:1px solid #e2e8f0; border-radius:6px; overflow:hidden;">
                        <button class="btn btn-sm active" onclick="switchValueAddedView('school', this)"
                            style="border-radius:0; background:#e0f2fe; color:#0369a1;">按学校看</button>
                        <button class="btn btn-sm" onclick="switchValueAddedView('class', this)"
                            style="border-radius:0; background:white; color:#64748b;">按班级看</button>
                    </div>
                    <button class="btn btn-green" onclick="exportValueAddedExcel()">📊 导出增值评价表</button>
                </div>
            </div>

            <div class="info-bar">
                <span id="va-data-status">⚠️ 请先上传“上次考试”数据以激活此功能</span>
                <span style="margin-left:auto; font-size:12px;">核心算法：(入口排名 - 出口排名) = 增值名次</span>
            </div>

            <div class="layout-grid">
                <div class="side-nav">
                    <div class="side-nav-title">功能视图</div>
                    <div class="side-nav-link active" onclick="scrollToAnchor('anchor-va-report', this)">📈 增值性评价报表
                    </div>
                    <div class="side-nav-link" onclick="scrollToAnchor('anchor-va-trend', this)">🔍 个人进退步追踪</div>
                </div>
                <div class="content-area">
                    <!-- 增值评价表 -->
                    <div id="anchor-va-report" class="anchor-target">
                        <div class="sub-header">🏫 教学效能增值评价表 (集体)</div>
                        <div class="table-wrap">
                            <table id="tb-value-added">
                                <thead>
                                    <tr>
                                        <th>单位名称</th>
                                        <th>匹配人数</th>
                                        <th>入口均位 (上次)</th>
                                        <th>出口均位 (本次)</th>
                                        <th>平均增值 (名次)</th>
                                        <th>评价</th>
                                        <th>排名</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- 个人追踪 -->
                    <div id="anchor-va-trend" class="anchor-target" style="margin-top:30px;">
                        <div class="sub-header"
                            style="display:flex; justify-content:space-between; align-items:center;">
                            <span>👤 学生个人进退步详情</span>
                            <div style="font-size:12px; font-weight:normal;">
                                <label>学校：</label>
                                <!-- 🔥 关键修复点：这就是报错找不到的 ID -->
                                <select id="progressSchoolSelect"
                                    style="padding:4px; border:1px solid #ccc; border-radius:4px;"
                                    onchange="renderProgressAnalysis()">
                                    <option value="">--请选择--</option>
                                </select>
                                <label style="margin-left:8px;">历史基准：</label>
                                <select id="progressBaselineSelect"
                                    style="padding:4px; border:1px solid #ccc; border-radius:4px; min-width:180px;"
                                    onchange="renderProgressAnalysis()">
                                    <option value="">--请选择历史考试--</option>
                                </select>
                            </div>
                        </div>

                        <div
                            style="margin:12px 0 14px 0; padding:10px; border:1px solid #e2e8f0; border-radius:8px; background:#f8fafc;">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                                <div style="font-weight:600; color:#334155;">🧭 多期对比 (支持2期/3期：月考/期中/期末等任意组合)</div>
                                <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                                    <label>期数：</label>
                                    <select id="progressComparePeriodCount"
                                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                                        onchange="onProgressComparePeriodCountChange()">
                                        <option value="2">2期</option>
                                        <option value="3">3期</option>
                                    </select>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px;">
                                <label style="font-size:12px; color:#475569;">对比学校：</label>
                                <select id="progressCompareSchool"
                                    style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:130px;"></select>
                                <label style="font-size:12px; color:#475569;">第1期：</label>
                                <select id="progressCompareExam1"
                                    style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                                <label style="font-size:12px; color:#475569;">第2期：</label>
                                <select id="progressCompareExam2"
                                    style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                                <span id="progressCompareExam3Wrap" style="display:none;">
                                    <label style="font-size:12px; color:#475569; margin-left:2px;">第3期：</label>
                                    <select id="progressCompareExam3"
                                        style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px; min-width:180px;"></select>
                                </span>
                                <button class="btn btn-sm btn-blue"
                                    onclick="renderMultiPeriodComparison()">生成多期对比</button>
                                <button class="btn btn-sm btn-green"
                                    onclick="exportMultiPeriodComparison()">导出多期对比</button>
                            </div>
                            <div id="multiPeriodCompareHint" style="margin-top:6px; font-size:12px; color:#64748b;">
                                请选择2期或3期考试后生成。</div>
                            <div id="multiPeriodCompareResult" style="margin-top:10px;"></div>
                        </div>

                        <div
                            style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px; height:300px;">
                            <div
                                style="background:white; border:1px solid #e2e8f0; border-radius:8px; padding:10px; position:relative;">
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">🛤️ 排名散点分布 (上浮为进，下沉为退)</h4>
                                <div style="height:calc(100% - 30px);"><canvas id="trendChart"></canvas></div>
                            </div>
                            <div
                                style="background:white; border:1px solid #e2e8f0; border-radius:8px; padding:10px; position:relative;">
                                <h4 style="margin:0 0 10px 0; font-size:13px; color:#666;">🌊 生源层级流动桑基图 (A/B/C/D层)</h4>
                                <div style="height:calc(100% - 30px);"><canvas id="sankeyChart"></canvas></div>
                            </div>
                        </div>

                        <div
                            style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:5px; flex-wrap:wrap;">
                            <div style="display:flex; gap:8px; align-items:center; font-size:12px;">
                                <label>筛选：</label>
                                <select id="progressFilterType"
                                    style="padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                                    onchange="applyProgressFilter()">
                                    <option value="all">全部</option>
                                    <option value="up">仅进步</option>
                                    <option value="down">仅退步</option>
                                </select>
                                <label>阈值(名次)</label>
                                <input id="progressFilterThreshold" type="number" value="20"
                                    style="width:70px; padding:4px 6px; border:1px solid #cbd5e1; border-radius:4px;"
                                    oninput="applyProgressFilter()">
                                <span style="color:#64748b;">仅显示 |变化| ≥ 阈值</span>
                                <button class="btn btn-sm btn-gray" onclick="resetProgressFilter()">重置筛选</button>
                            </div>
                            <button class="btn btn-sm btn-green" onclick="exportProgressAnalysis()">📥 导出个人明细</button>
                        </div>
                        <div class="table-wrap">
                            <table id="progressTable" class="mobile-card-table">
                                <thead>
                                    <tr>
                                        <th>班级</th>
                                        <th>姓名</th>
                                        <th>本次总分</th>
                                        <th>本次校排</th>
                                        <th>上次总分</th>
                                        <th>上次校排</th>
                                        <th>进退步</th>
                                        <th>状态评价</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 11. 个性化成绩单生成器 -->
        <div id="report-generator" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-student)">
                <h3><i class="ti ti-user-heart"></i> 05 学生发展与家校沟通 <span class="badge" style="background:#0ea5e9;">📊
                        班主任必看</span></h3>
                <p><strong>一句话目的：</strong>生成成绩单与家长查分材料。</p>
                <p><strong>推荐顺序：</strong>完成分析后，用于班级汇报与家校沟通。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-certificate"></i> 个性化成绩单生成器</h2>
            </div>
            <div class="control-panel" style="background:#fff; border-color:var(--primary-light);">
                <label>选择学校：</label><select id="sel-school" style="min-width:150px;">
                    <option>--请先上传数据--</option>
                </select>
                <label>班级：</label><select id="sel-class" style="min-width:120px;">
                    <option>--请先选择学校--</option>
                </select>
            </div>
            <div class="control-panel">
                <input type="text" id="inp-name" placeholder="查询单个学生姓名" style="width:120px;">
                <button class="btn" onclick="doQuery()">查询单人报告</button>
                <button class="btn btn-purple" id="btn-report-cloud-compare"
                    onclick="viewCloudStudentComparesForCurrentStudent()">
                    <i class="ti ti-cloud-search"></i> 查看云端对比（本人）
                </button>
                <!-- [新增] 批量PDF入口 -->
                <button class="btn btn-primary" style="margin-left:auto;" onclick="batchGeneratePDF()">
                    <i class="ti ti-files"></i> 批量生成全班 PDF
                </button>
            </div>
            <div id="single-report-result" class="hidden">
                <div style="text-align: right; margin-bottom: 10px; display:flex; justify-content:flex-end; gap:10px;">
                    <!-- [修改] 打印/PDF -->
                    <button class="btn btn-purple" onclick="printSingleReport()">
                        <i class="ti ti-printer"></i> 打印 / 另存为 PDF
                    </button>
                    <button class="btn btn-blue" onclick="downloadSingleReportPDF()">
                        <i class="ti ti-file-export"></i> 下载PDF
                    </button>
                </div>
                <div id="report-card-capture-area" class="report-card-container"></div>
            </div>
            <div class="sub-header" style="margin-top: 50px;">🎯 优秀和及格边缘生分析</div>
            <div class="control-panel">
                <label>选择本校：</label><select id="marginalSchoolSelect" style="min-width:200px;">
                    <option value="">--请选择--</option>
                </select>
                <button class="btn" onclick="analyzeMarginalStudents()">分析边缘生</button>
                <button class="btn btn-green" onclick="exportMarginalStudents()">导出Excel</button>
            </div>
            <div id="marginal-student-results"></div>
        </div>

        <div id="subject-balance" class="section card-box">
            <div class="module-desc-bar" style="border-color: #059669">
                <h3><i class="ti ti-scale"></i> 学生优劣势学科可视化透视</h3>
                <p>说明：以全镇平均分为基准，直观展示每个学生“强在哪、弱在哪”。绿色代表优势，红色代表劣势，长度代表程度。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-activity"></i> 优劣势学科透视表</h2>
                <button class="btn btn-green" onclick="SB_exportExcel()">📊 导出Excel</button>
            </div>

            <div class="control-panel">
                <label>选择学校：</label>
                <select id="sbSchoolSelect" style="min-width:150px;">
                    <option value="">--请选择--</option>
                </select>

                <label style="margin-left: 10px;">班级：</label>
                <select id="sbClassSelect" style="min-width:120px;">
                    <option value="">全部</option>
                </select>

                <label style="margin-left: 10px; border-left:1px solid #ccc; padding-left:10px;">排序依据：</label>
                <select id="sbSortBy">
                    <option value="total">按总分降序</option>
                    <option value="balance">按偏科程度(最不均衡在前)</option>
                </select>

                <button class="btn btn-primary" onclick="SB_renderTable()">🔍 开始分析</button>
            </div>

            <!-- 图例说明 -->
            <div style="font-size:12px; margin:10px 0; color:#666; display:flex; gap:15px; align-items:center;">
                <span>图例说明：</span>
                <span style="display:flex; align-items:center;">
                    <div style="width:15px; height:8px; background:#16a34a; margin-right:5px;"></div> 优势 (高于均分)
                </span>
                <span style="display:flex; align-items:center;">
                    <div style="width:15px; height:8px; background:#dc2626; margin-right:5px;"></div> 劣势 (低于均分)
                </span>
                <span style="color:#94a3b8;">(数值表示与全镇平均分的分差)</span>
            </div>

            <div class="table-wrap">
                <table id="sb-table">
                    <thead>
                        <tr>
                            <th style="width:80px;">姓名</th>
                            <th style="width:60px;">总分</th>
                            <th style="width:60px;">镇排</th>
                            <th>优劣势分布图 (基准线：全镇平均分)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" style="text-align:center; padding:30px; color:#999;">请选择班级并点击分析</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card-box" style="border-left:4px solid #f59e0b; background:#fff7ed; margin-top:15px;">
                <div class="sec-head" style="border-bottom-color:#fed7aa; margin-bottom:10px;">
                    <h2 style="color:#9a3412;"><i class="ti ti-cluster"></i> 学科瘸腿深度聚类</h2>
                    <button class="btn btn-orange" onclick="SB_runCluster()">🔬 生成聚类与辅导策略</button>
                </div>
                <div style="font-size:12px; color:#7c2d12; margin-bottom:10px;">
                    说明：使用 K-Means 自动分类为<strong>全科均衡型 / 文强理弱型 / 理强文弱型 / 单科突围型</strong>，并给出辅导策略模板。
                </div>
                <div id="sb-cluster-results" style="font-size:12px; color:#7c2d12;"></div>
            </div>
        </div>

        <!-- 12. 偏科潜力生挖掘 -->
        <div id="potential-analysis" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-bulb"></i> 偏科潜力生挖掘
                    <span class="module-help-btn" onclick="showModuleHelp('student-diag')">📘 挖掘原理</span>
                </h2>
                <button class="btn btn-green" onclick="exportPotentialAnalysis()">导出名单</button>
            </div>
            <div class="info-bar"><span class="text-blue">核心逻辑：</span> 筛选出 <strong>总分排名靠前</strong> (如前20%)，但
                <strong>单科排名严重滞后</strong> (如50%以后) 的学生。
            </div>
            <div class="control-panel" style="background:#fffbeb; border-color:#fcd34d;">
                <label>范围：</label><select id="potSchoolSelect" style="min-width:150px;">
                    <option value="ALL">全乡镇</option>
                </select>
                <label style="margin-left:15px;">总分排名前：</label><select id="potTopSelect" style="width:100px;">
                    <option value="0.1">10%</option>
                    <option value="0.2" selected>20%</option>
                    <option value="0.3">30%</option>
                    <option value="0.5">50%</option>
                </select>
                <label style="margin-left:15px;">单科排名后：</label><select id="potLowSelect" style="width:100px;">
                    <option value="0.3">30%</option>
                    <option value="0.4">40%</option>
                    <option value="0.5" selected>50%</option>
                    <option value="0.6">60%</option>
                    <option value="0.8">80%</option>
                </select>
                <button class="btn btn-orange" style="margin-left:15px;" onclick="renderPotentialAnalysis()">🔍
                    一键挖掘</button>
            </div>
            <div id="potential-results">
                <div style="text-align:center; padding:40px; color:#94a3b8;"><i class="ti ti-search"
                        style="font-size:48px; display:block; margin-bottom:10px;"></i>
                    <p>请点击上方“一键挖掘”按钮开始分析</p>
                </div>
            </div>
        </div>

        <!-- 13. 新生分班 & 座位编排 -->
        <div id="freshman-simulator" class="section card-box">
            <div class="sec-head">
                <h2>
                    <i class="ti ti-arrows-split"></i> 新生均衡分班
                    <span class="module-help-btn" onclick="showModuleHelp('tools')">📘 算法逻辑</span>
                </h2>
                <div>
                    <button class="btn btn-purple" onclick="FB_saveToLocal()">💾 保存方案</button>
                    <button class="btn btn-green" onclick="FB_exportResult()">📊 导出结果</button>
                </div>
            </div>
            <div class="control-panel" style="flex-direction: column; align-items: stretch;">
                <div
                    style="display:flex; gap:20px; flex-wrap:wrap; border-bottom:1px dashed #cbd5e1; padding-bottom:15px; margin-bottom:15px;">
                    <div class="upload-box" style="flex:1; padding:20px; min-width:250px;"
                        onclick="document.getElementById('fbFileInput').click()">
                        <div class="upload-icon"><i class="ti ti-file-import"></i></div>
                        <div style="font-weight:bold;">点击导入新生名单 Excel</div>
                        <div style="font-size:12px; color:#64748b;">必需: 姓名,性别,总分 | 可选: 身高,视力,备注(关系)</div>
                        <input type="file" id="fbFileInput" accept=".xlsx,.xls" hidden onchange="FB_loadData(this)">
                    </div>
                    <div
                        style="flex:2; display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:15px;">
                        <div><label class="stat-label">拟分班级数</label><input type="number" id="fb_cls_num" value="6"
                                min="1" max="30" style="width:100%;"></div>
                        <div><label class="stat-label">班额微调</label><select id="fb_cls_size" style="width:100%;">
                                <option value="0">自动平均</option>
                                <option value="auto">允许±2人</option>
                            </select></div>
                        <div><label class="stat-label">男女控制</label><select id="fb_rule_gender" style="width:100%;">
                                <option value="strict">严格均衡</option>
                                <option value="loose">允许差异</option>
                            </select></div>
                        <div><label class="stat-label">难管学生</label><select id="fb_rule_diff" style="width:100%;">
                                <option value="spread">均匀分散 (推荐)</option>
                                <option value="gather">集中管理</option>
                            </select></div>
                        <div><label class="stat-label">核心算法</label><select id="fb_algorithm" style="width:100%;">
                                <option value="complex" selected>🧠 综合智能优化</option>
                                <option value="snake">🐍 经典蛇形分班</option>
                            </select></div>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div
                        style="font-size:13px; color:#b45309; background:#fffbeb; padding:5px 10px; border-radius:4px;">
                        <i class="ti ti-alert-circle"></i> <strong>智能提示：</strong> 系统将自动解析备注列中的 "和XX同班"、"与XX分开"
                        等自然语言，优先级最高。
                    </div>
                    <button class="btn btn-primary" style="padding:10px 30px; font-size:16px;"
                        onclick="FB_runDivision()">🚀 开始智能分班</button>
                </div>
            </div>
            <div id="fb-results-area" class="hidden">
                <div
                    style="background:white; border-radius:8px; padding:15px; margin-top:20px; border:1px solid #e2e8f0;">
                    <h3 style="margin-bottom:15px; color:#333; font-size:16px;">⚖️ 分班均衡度诊断 (箱线图)</h3>
                    <div style="height:300px; position:relative;">
                        <canvas id="balanceChart"></canvas>
                    </div>
                    <div id="balanceTableContainer" style="margin-top:20px; overflow-x:auto;"></div>
                </div>

                <div class="sub-header" style="margin-top:20px;">🏫 分班结果列表 (点击班级卡片进入座位编排)</div>
                <div class="fb-class-grid" id="fb_class_container"></div>
            </div>
            <div id="fb_seat_view" class="hidden"
                style="margin-top:30px; border-top:3px solid var(--primary); padding-top:20px; background:#fff;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 style="color:var(--primary); margin:0;"><i class="ti ti-armchair"></i> <span
                            id="seat_class_title"></span> 座位编排</h2>
                    <button class="btn btn-gray"
                        onclick="document.getElementById('fb_seat_view').classList.add('hidden')">❌ 关闭/返回</button>
                </div>
                <div class="seat-workspace">
                    <div class="seat-tools">
                        <h4 style="border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">🛠 教室布局
                        </h4>
                        <div style="margin-bottom:10px;"><label>左右大组数 (中间为过道):</label><input type="number"
                                id="seat_opt_groups" value="2" min="1" max="4" style="width:60px;"
                                onchange="FB_renderSeatMap()"></div>
                        <div style="margin-bottom:20px;"><label>每组列数:</label><input type="number" id="seat_opt_cols"
                                value="4" min="1" max="6" style="width:100%;" onchange="FB_renderSeatMap()"></div>

                        <!-- [修改] 新生分班 - 交互优化后的约束框 -->
                        <div class="constraints-box" style="padding:10px;">
                            <h4 style="margin:0 0 10px 0;">🚧 临时干预 (智能输入)</h4>
                            <div style="font-size:12px; display:flex; flex-direction:column; gap:8px;">
                                <div><label>😡 难管:</label><input type="hidden" id="fb_c_diff">
                                    <div id="widget_fb_diff" class="tag-widget-container"><input type="text"
                                            class="tag-input-field" placeholder="输入姓名...">
                                        <div class="suggestion-dropdown"></div>
                                    </div>
                                </div>
                                <div><label>👓 视力:</label><input type="hidden" id="fb_c_vision">
                                    <div id="widget_fb_vision" class="tag-widget-container"><input type="text"
                                            class="tag-input-field" placeholder="输入姓名...">
                                        <div class="suggestion-dropdown"></div>
                                    </div>
                                </div>
                                <div><label>🗣️ 说话:</label><input type="hidden" id="fb_c_talk">
                                    <div id="widget_fb_talk" class="tag-widget-container"><input type="text"
                                            class="tag-input-field" placeholder="输入姓名...">
                                        <div class="suggestion-dropdown"></div>
                                    </div>
                                </div>
                                <div><label>⚔️ 矛盾:</label>
                                    <div class="conflict-builder"><select id="fb_conflict_sel_a" style="width:40%">
                                            <option value="">A</option>
                                        </select><span>&</span><select id="fb_conflict_sel_b" style="width:40%">
                                            <option value="">B</option>
                                        </select><button class="btn btn-gray" style="padding:0 5px;"
                                            onclick="addConflictPair('fb')">+</button></div><input type="hidden"
                                        id="fb_c_conflict">
                                    <div id="widget_fb_conflict" class="tag-widget-container"
                                        style="background:#f9fafb;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 1. 新增：固定搭档 (绑定) 组件 -->
                        <div class="constraints-box"
                            style="padding:10px; margin-top:10px; background:#f0fdf4; border-color:#86efac;">
                            <h4 style="margin:0 0 10px 0; color:#166534;">🔗 强行绑定 (固定同桌)</h4>
                            <div style="font-size:12px;">
                                <div class="conflict-builder">
                                    <select id="fb_bind_sel_a" style="width:40%">
                                        <option value="">A</option>
                                    </select>
                                    <span>&</span>
                                    <select id="fb_bind_sel_b" style="width:40%">
                                        <option value="">B</option>
                                    </select>
                                    <button class="btn btn-green" style="padding:0 5px;"
                                        onclick="addBindPair('fb')">+</button>
                                </div>
                                <input type="hidden" id="fb_c_bind">
                                <div id="widget_fb_bind" class="tag-widget-container" style="background:#f9fafb;"></div>
                            </div>
                        </div>

                        <!-- 2. 新增：多方案管理面板 -->
                        <div
                            style="background:#f0fdf4; border:1px solid #86efac; border-radius:6px; padding:10px; margin-bottom:10px; display:flex; gap:10px;">
                            <button class="btn btn-gray" id="btn_undo" onclick="HistoryManager.undo()" disabled
                                style="flex:1;">
                                <i class="ti ti-arrow-back-up"></i> 撤销
                            </button>
                            <button class="btn btn-gray" id="btn_redo" onclick="HistoryManager.redo()" disabled
                                style="flex:1;">
                                <i class="ti ti-arrow-forward-up"></i> 重做
                            </button>
                        </div>
                        <div
                            style="background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:10px; margin-bottom:15px; margin-top:10px;">
                            <h4 style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">💾 方案记忆
                            </h4>
                            <div style="display:flex; gap:5px; margin-bottom:5px;">
                                <select id="seat_scenario_select" style="flex:1; font-size:12px;"
                                    onchange="FB_loadScenario()">
                                    <option value="">-- 选择方案 --</option>
                                </select>
                            </div>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-primary btn-sm" style="flex:1; font-size:12px;"
                                    onclick="FB_saveScenario()">保存当前</button>
                                <button class="btn btn-danger btn-sm" style="width:30px; padding:0;"
                                    onclick="FB_deleteScenario()" title="删除选中"><i class="ti ti-trash"></i></button>
                            </div>
                        </div>

                        <div
                            style="background:#fff; border:1px solid #cbd5e1; border-radius:6px; padding:10px; margin-bottom:15px; margin-top:10px;">
                            <button class="btn btn-gray" style="width:100%; margin-bottom:8px;"
                                onclick="FB_toggleViewRotation()">
                                <i class="ti ti-rotate"></i> 切换讲台视角 (黑板)
                            </button>
                            <div style="font-size:12px; color:#d97706; display:flex; align-items:start; gap:5px;">
                                <i class="ti ti-mouse-2"></i>
                                <span><strong>右键点击座位</strong>可锁定/解锁。<br>锁定后，一键重排时不移动位置。</span>
                            </div>
                        </div>
                        <h4 style="border-bottom:1px solid #e2e8f0; padding-bottom:5px; margin-bottom:10px;">🧠 智能规则
                        </h4>
                        <div style="display:flex; flex-direction:column; gap:8px; font-size:13px;">
                            <label><input type="checkbox" id="rule_s_height" checked> 按身高前低后高</label><label><input
                                    type="checkbox" id="rule_s_vision" checked> 视力保护 (前3排)</label><label><input
                                    type="checkbox" id="rule_s_gender" checked> 男女同桌混排</label><label><input
                                    type="checkbox" id="rule_s_diff" checked> 难管学生“C位”监控</label><label><input
                                    type="checkbox" id="rule_s_rel" checked> 关系互斥强制分开</label>
                        </div>
                        <button class="btn btn-primary" style="width:100%; margin-top:20px;"
                            onclick="FB_autoSeatAlgo()">✨ 一键生成座位</button>
                        <button class="btn btn-purple" style="width:100%; margin-top:10px;" onclick="window.print()">🖨
                            打印座位表</button>
                    </div>
                    <div class="seat-canvas">
                        <div class="seat-stage">讲 台 / 黑 板</div>
                        <div id="seat_map_container" class="seat-container"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 14. 智能考场编排 -->
        <div id="exam-arranger" class="section card-box">
            <div class="module-desc-bar" style="border-color: var(--color-tools)">
                <h3><i class="ti ti-settings-automation"></i> 06 智慧教务事务工具</h3>
                <p>说明：解决日常繁杂教务。包含考场智能编排、自动生成桌贴、新生均衡分班、座位表智能排列（考虑视力/身高/矛盾）等功能。</p>
            </div>
            <div class="sec-head">
                <h2><i class="ti ti-id-badge-2"></i> 智能考场编排器</h2>
                <div><button class="btn btn-green" onclick="EXAM_exportResult()">📊 导出考务Excel</button><button
                        class="btn btn-orange" onclick="EXAM_generateDeskLabels()">🏷️ 批量打印桌贴</button><button
                        class="btn btn-purple" onclick="window.print()">🖨 批量打印桌贴</button></div>
            </div>
            <div class="control-panel" style="flex-direction: column; align-items: stretch;">
                <div
                    style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed #e2e8f0;">
                    <div class="upload-box" style="flex:1; padding:20px; min-width:250px;"
                        onclick="document.getElementById('examFileInput').click()">
                        <div class="upload-icon"><i class="ti ti-file-certificate"></i></div>
                        <div style="font-weight:bold;">导入本次考试学生名单</div>
                        <div style="font-size:12px; color:#64748b;">自动识别姓名/班级/总分(自动按分排序)</div>
                        <input type="file" id="examFileInput" accept=".xlsx,.xls" hidden onchange="EXAM_loadData(this)">
                    </div>
                    <div
                        style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:15px; background:#f8fafc; padding:10px; border-radius:8px;">
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <div><label style="width:80px;font-weight:bold;">考号前缀：</label><input type="text"
                                    id="exam_prefix" value="202501" style="width:100px;"></div>
                            <div><label style="width:80px;font-weight:bold;">每场人数：</label><input type="number"
                                    id="exam_seats_per_room" value="30" style="width:100px;"></div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px;">
                            <label style="cursor:pointer; display:flex; align-items:center;">
                                <input type="checkbox" id="exam_opt_separate" checked>
                                <span style="margin-left:5px;">🔀 <b>同班互斥</b> (防作弊)</span>
                            </label>
                            <label style="cursor:pointer; display:flex; align-items:center;">
                                <input type="checkbox" id="exam_opt_snake">
                                <span style="margin-left:5px;">🐍 <b>S型蛇形排列</b> (座位号)</span>
                            </label>
                        </div>
                        <button class="btn btn-primary" style="grid-column: 1/-1; margin-top:5px;"
                            onclick="EXAM_generate()">
                            🚀 智能生成考场安排
                        </button>
                    </div>
                </div>
                <div id="exam-results-area" class="hidden">
                    <div class="nav-sub-items"
                        style="margin-bottom:15px; background:#f1f5f9; border-radius:6px; border:none;">
                        <div class="nav-link active" onclick="EXAM_switchView('overview', this)">👀 考场概览</div>
                        <div class="nav-link" onclick="EXAM_switchView('setup', this)">👨‍🏫 人员配置</div>
                        <div class="nav-link" onclick="EXAM_switchView('students', this)">📋 考生查询表</div>
                        <div class="nav-link" onclick="EXAM_switchView('proctor', this)">👮 监考汇总表</div>
                    </div>
                    <div id="exam-view-overview">
                        <div class="info-bar">💡 点击考场卡片可查看该考场的详细座次表。打印时会自动分页。</div>
                        <div id="exam_room_grid" class="exam-room-grid"></div>
                    </div>
                    <div id="exam-view-students" class="hidden">
                        <div class="table-wrap">
                            <table id="exam_student_table">
                                <thead>
                                    <tr>
                                        <th>考号</th>
                                        <th>姓名</th>
                                        <th>班级</th>
                                        <th>考场号</th>
                                        <th>座号</th>
                                        <th>上次成绩</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="exam-view-setup" class="hidden">
                        <div class="info-bar">依据【数据中心】导入的教师信息，请勾选不在考务名单的人员，并分配特殊角色。</div>
                        <div class="proctor-setup-grid">
                            <!-- 教师黑名单 -->
                            <div>
                                <span class="role-label"><i class="ti ti-user-x"></i> 1. 排除不参加监考的人员 (勾选)</span>
                                <div id="proctor-teacher-pool" class="teacher-scroll-list">
                                    <!-- 动态加载教师 -->
                                    <div style="color:#999; padding:20px; grid-column: 1/-1;">请先导入教师信息...</div>
                                </div>
                            </div>
                            <!-- 角色分配 -->
                            <div>
                                <span class="role-label"><i class="ti ti-users"></i> 2. 指定特殊岗位 (多选/按住Ctrl)</span>
                                <div class="role-group">
                                    <label class="role-label">⚖️ 纪律巡考/校级巡查</label>
                                    <select id="proctor-role-patrol" class="role-select" multiple></select>
                                </div>
                                <div class="role-group" style="border-left: 4px solid #10b981;">
                                    <label class="role-label">🧹 卫生考务/后勤保障组</label>
                                    <select id="proctor-role-affairs" class="role-select" multiple></select>
                                </div>
                                <button class="btn btn-primary" style="width:100%; margin-top:10px;"
                                    onclick="EXAM_assignProctors()">
                                    🚀 一键编排监考表 (2人/班)
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="exam-view-proctor" class="hidden">
                        <div class="table-wrap">
                            <table id="exam_proctor_table" class="proctor-table">
                                <thead>
                                    <tr>
                                        <th>考场</th>
                                        <th>人数</th>
                                        <th>起止考号</th>
                                        <th>监考员签字</th>
                                        <th>巡考员签字</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="grade-scheduler" class="section card-box">
            <div class="module-desc-bar" style="border-color: #7c3aed">
                <h3><i class="ti ti-calendar-time"></i> 下一年级部排课系统</h3>
                <p>说明：独立于当前成绩数据。用于新学期排课，支持自定义课时结构、合堂课、早晚自习特定规则以及教师均衡排班。</p>
            </div>

            <div class="sec-head">
                <h2><i class="ti ti-layout-grid"></i> 级部智能排课</h2>
                <div>
                    <button class="btn btn-purple" onclick="SCHEDULER.exportResult()">📥 导出课表(Excel)</button>
                    <button class="btn btn-orange" onclick="document.getElementById('schedulerImportFile').click()">📤
                        导入已有课表优化</button>
                    <button class="btn btn-gray" onclick="SCHEDULER.auditFatigue()">🧠 AI疲劳审计</button>
                    <input type="file" id="schedulerImportFile" accept=".xlsx,.xls" hidden
                        onchange="SCHEDULER.importExisting(this)">
                </div>
            </div>

            <!-- 1. 基础配置面板 -->
            <div class="control-panel" style="display:block;">
                <h4 style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">⚙️ 课时结构配置</h4>
                <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:15px;">
                    <div>
                        <label class="stat-label">上午节数</label>
                        <input type="number" id="sch_am_count" value="4" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">下午节数</label>
                        <input type="number" id="sch_pm_count" value="4" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">晚自习节数</label>
                        <input type="number" id="sch_eve_count" value="3" style="width:60px;">
                    </div>
                    <div style="border-left:1px solid #ccc; padding-left:15px;">
                        <label class="stat-label">单节时长(分)</label>
                        <input type="number" id="sch_dur_class" value="45" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">课间时长(分)</label>
                        <input type="number" id="sch_dur_break" value="10" style="width:60px;">
                    </div>
                    <div>
                        <label class="stat-label">大课间位置</label>
                        <select id="sch_big_break_pos" style="width:100px;">
                            <option value="2">第2节后</option>
                            <option value="3">第3节后</option>
                        </select>
                    </div>
                </div>

                <h4 style="margin-bottom:10px; border-bottom:1px dashed #ccc; padding-bottom:5px;">🚧 常规规则约束</h4>
                <div
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:10px; font-size:13px;">
                    <label><input type="checkbox" id="sch_rule_fri_eve" checked> 周五晚上不上课</label>
                    <label><input type="checkbox" id="sch_rule_fri_pm"
                            onchange="document.getElementById('sch_fri_pm_val').disabled=!this.checked"> 周五下午仅上 <input
                            type="number" id="sch_fri_pm_val" value="2" style="width:40px; padding:0;" disabled>
                        节</label>
                    <label><input type="checkbox" id="sch_rule_morning_read" checked> 添加 [07:00] 小晨读+早读</label>
                    <label><input type="checkbox" id="sch_rule_noon_write" checked> 添加 [13:30] 午间练字/午唱</label>
                    <div
                        style="grid-column: 1/-1; background:#fff; padding:8px; border:1px solid #eee; border-radius:4px;">
                        <strong>🔗 合堂/连堂规则 (晚自习):</strong><br>
                        <select id="sch_combined_slot" style="margin-top:5px;">
                            <option value="eve_3">晚自习第3节</option>
                            <option value="eve_all">整个晚自习</option>
                        </select>
                        <span style="color:#666;"> 必须由同一老师跨班连上 (如: 1,2,3班合堂)</span>
                    </div>
                </div>
            </div>

            <!-- 2. 资源导入 -->
            <div style="display:flex; gap:20px; margin-top:20px;">
                <div class="upload-box" style="flex:1; min-height:150px; padding:20px;"
                    onclick="document.getElementById('schTeacherFile').click()">
                    <div class="upload-icon"><i class="ti ti-users"></i></div>
                    <div style="font-weight:bold;">导入新学期教师任课表 (Excel)</div>
                    <div style="font-size:12px; color:#64748b;">
                        必需列: [教师姓名] [学科] [任教班级] [周课时量]<br>
                        (例如: 张三 | 语文 | 701,702 | 12)
                    </div>
                    <input type="file" id="schTeacherFile" accept=".xlsx,.xls" hidden
                        onchange="SCHEDULER.loadData(this)">
                </div>

                <div
                    style="flex:2; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:15px; max-height:200px; overflow-y:auto;">
                    <div style="display:flex; justify-content:space-between;">
                        <h4 style="margin:0;">📋 待排课程资源预览</h4>
                        <button class="btn btn-sm btn-green" onclick="SCHEDULER.downloadTemplate()"><i
                                class="ti ti-download"></i> 下载任课模板</button>
                    </div>
                    <div id="sch_resource_preview" style="margin-top:10px; font-size:12px; color:#666;">
                        请先上传 Excel 文件...
                    </div>
                </div>
            </div>

            <!-- 3. 动态约束配置区 (核心修改) -->
            <div class="constraints-box"
                style="margin-top:20px; background:#fff; border:1px solid #e2e8f0; box-shadow:0 4px 6px rgba(0,0,0,0.02);">
                <h4 style="color:#4f46e5; border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:15px;">
                    <i class="ti ti-adjustments-alt"></i> 排课规则与特殊约束 (动态配置)
                </h4>

                <div class="constraints-grid" style="grid-template-columns: 1fr 1fr; gap:20px;">

                    <!-- 0. 晚自习合堂/连堂规则 (替换了原来的简单下拉框) -->
                    <div
                        style="grid-column: 1/-1; background:#fff7ed; padding:10px; border-radius:6px; border:1px solid #fdba74;">
                        <label style="font-weight:bold; color:#9a3412; margin-bottom:5px; display:block;">
                            🔗 晚自习合堂规则 (指定学科 + 教师所有班级连上)
                        </label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:5px;">
                            <span style="font-size:12px; color:#666;">将在:</span>
                            <select id="sch_comb_slot" style="width:120px; padding:4px; border:1px solid #fed7aa;">
                                <option value="eve_3">晚自习第3节</option>
                                <option value="eve_2">晚自习第2节</option>
                                <option value="eve_1">晚自习第1节</option>
                            </select>

                            <span style="font-size:12px; color:#666;">允许合堂的学科:</span>
                            <select id="sch_comb_subject" style="width:100px; padding:4px; border:1px solid #fed7aa;">
                                <option value="物理">物理</option>
                                <option value="化学">化学</option>
                                <option value="生物">生物</option>
                                <option value="政治">政治</option>
                                <option value="历史">历史</option>
                                <option value="地理">地理</option>
                                <option value="语文">语文</option>
                                <option value="数学">数学</option>
                                <option value="英语">英语</option>
                            </select>

                            <button class="btn btn-sm" style="background:#ea580c; color:white;"
                                onclick="SCHEDULER.addConstraint('combined')">
                                <i class="ti ti-link"></i> 添加规则
                            </button>
                        </div>
                        <div id="sch_tags_combined" class="tag-widget-container"
                            style="min-height:35px; background:white; border-color:#fed7aa;"></div>
                        <div style="font-size:11px; color:#c2410c; margin-top:4px;">
                            ℹ️ 逻辑：系统会自动寻找该学科教多个班的老师，尝试在周一至周五的指定时段，安排其所有班级一起上课。
                        </div>
                    </div>

                    <!-- 1. 班会设置 (支持多次) -->
                    <div style="background:#f8fafc; padding:10px; border-radius:6px; border:1px solid #e2e8f0;">
                        <label style="font-weight:bold; color:#333; margin-bottom:5px; display:block;">🏫
                            班会/固定全校活动</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="sch_meet_day" style="width:80px; padding:4px;">
                                <option value="1">周一</option>
                                <option value="2">周二</option>
                                <option value="3">周三</option>
                                <option value="4">周四</option>
                                <option value="5" selected>周五</option>
                            </select>
                            <select id="sch_meet_slot" style="flex:1; padding:4px;">
                                <option value="pm_3">下午第3节</option>
                                <option value="pm_4">下午第4节</option>
                                <option value="eve_1">晚自习第1节</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="SCHEDULER.addConstraint('meeting')">➕
                                添加</button>
                        </div>
                        <!-- 动态标签容器 -->
                        <div id="sch_tags_meeting" class="tag-widget-container"
                            style="min-height:35px; background:white;"></div>
                    </div>

                    <!-- 2. 教师禁排 (开会/请假) -->
                    <div style="background:#fffbeb; padding:10px; border-radius:6px; border:1px solid #fcd34d;">
                        <label style="font-weight:bold; color:#b45309; margin-bottom:5px; display:block;">🚫 教师禁排/开会
                            (不排课)</label>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="sch_busy_day" style="width:70px; padding:4px;">
                                <option value="1">周一</option>
                                <option value="5">周五</option>
                                <option value="3">周三</option>
                            </select>
                            <input type="text" id="sch_busy_slots" placeholder="节次(如: 1,2 或 am_1)"
                                style="width:100px; padding:4px;">
                            <input type="text" id="sch_busy_name" placeholder="教师姓名" style="flex:1; padding:4px;">
                            <button class="btn btn-sm btn-orange" onclick="SCHEDULER.addConstraint('busy')">➕
                                添加</button>
                        </div>
                        <div id="sch_tags_busy" class="tag-widget-container" style="min-height:35px; background:white;">
                        </div>
                    </div>

                    <!-- 3. 教研活动/半天无课 -->
                    <div
                        style="grid-column: 1/-1; background:#f0fdf4; padding:10px; border-radius:6px; border:1px solid #86efac;">
                        <label style="font-weight:bold; color:#166534; margin-bottom:5px; display:block;">🗓️ 教研组活动 /
                            半天无课 (批量锁死)</label>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:5px;">
                            <select id="sch_act_day" style="width:80px; padding:4px;">
                                <option value="3">周三</option>
                                <option value="1">周一</option>
                                <option value="2">周二</option>
                                <option value="4">周四</option>
                                <option value="5">周五</option>
                            </select>
                            <select id="sch_act_range" style="width:120px; padding:4px;">
                                <option value="pm_all">整个下午</option>
                                <option value="am_all">整个上午</option>
                                <option value="custom">指定节次→</option>
                            </select>
                            <input type="text" id="sch_act_custom_slots" placeholder="如: 6,7,8"
                                style="width:80px; padding:4px; display:none;">

                            <span>对象:</span>
                            <select id="sch_act_subject" style="width:100px; padding:4px;">
                                <option value="ALL">全级部(无课)</option>
                                <option value="语文">语文组</option>
                                <option value="数学">数学组</option>
                                <option value="英语">英语组</option>
                                <option value="物理">物理组</option>
                                <option value="化学">化学组</option>
                                <option value="政治">政治组</option>
                            </select>
                            <button class="btn btn-sm btn-green" onclick="SCHEDULER.addConstraint('activity')">➕
                                添加活动</button>
                        </div>
                        <div id="sch_tags_activity" class="tag-widget-container"
                            style="min-height:35px; background:white;"></div>
                    </div>
                </div>

                <div style="font-size:11px; color:#666; margin-top:5px; padding-left:5px;">
                    💡 提示：教师禁排支持输入 "上午"、"下午" 或具体数字 "1,2"；全级部无课会自动跳过排课。
                </div>
            </div>

            <div style="margin-top:20px; text-align:center;">
                <button class="btn btn-primary" style="padding:12px 30px; font-size:16px;" onclick="SCHEDULER.run()">
                    🚀 开始智能排课
                </button>
            </div>

            <!-- 4. 结果展示 -->
            <div id="sch_result_area" class="hidden" style="margin-top:20px;">
                <div class="sub-header">📅 排课结果预览 (点击单元格可微调)</div>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <select id="sch_view_mode" onchange="SCHEDULER.renderTable()">
                        <option value="class">按班级查看</option>
                        <option value="teacher">按教师查看</option>
                    </select>
                    <select id="sch_view_target" onchange="SCHEDULER.renderTable()">
                        <!-- 动态填充班级或教师名 -->
                    </select>
                </div>
                <div class="table-wrap">
                    <table id="sch_table" style="text-align:center; font-size:12px;">
                        <!-- JS 渲染 -->
                    </table>
                </div>
            </div>

            <!-- 5. AI 疲劳审计 -->
            <div id="sch_audit_area" class="hidden"
                style="margin-top:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px;">
                <div class="sub-header">🧠 排课疲劳审计结果</div>
                <div id="sch_audit_summary" style="font-size:12px; color:#64748b; margin-bottom:6px;"></div>
                <div id="sch_audit_list" class="tag-widget-container" style="min-height:40px; background:white;"></div>
            </div>
        </div>

        <div id="poster-generator" class="section card-box">
            <div class="sec-head">
                <h2><i class="ti ti-photo-star"></i> 喜报/红榜生成器</h2>
                <div class="control-panel" style="margin-bottom:0; padding:5px; border:none; background:none;">
                    <button class="btn btn-purple" onclick="downloadPoster()">⬇️ 保存图片</button>
                </div>
            </div>

            <div class="poster-workspace">
                <!-- 左侧：控制器 -->
                <div class="poster-controls">
                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">🎨 1. 选择主题</h4>
                    <div class="thumb-select">
                        <div class="thumb-btn active" onclick="setPosterTheme('red', this)">🧧 大红喜报</div>
                        <div class="thumb-btn" onclick="setPosterTheme('blue', this)">📘 清爽蓝调</div>
                        <div class="thumb-btn" onclick="setPosterTheme('tech', this)">🤖 赛博科技</div>
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">
                        📊 2. 数据来源</h4>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">学校：</label>
                        <select id="posterSchoolSelect" style="width:100%; margin-bottom:5px;"
                            onchange="updatePosterClassSelect()">
                            <option value="">--请选择--</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">班级 (可选)：</label>
                        <select id="posterClassSelect" style="width:100%; margin-bottom:5px;">
                            <option value="">全校排名</option>
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">榜单类型：</label>
                        <select id="posterSubjectSelect" style="width:100%; margin-bottom:5px;">
                            <option value="total">🏆 总分光荣榜</option>
                            <!-- JS动态填充科目 -->
                        </select>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label style="font-size:12px;">上榜人数：</label>
                        <input type="number" id="posterCount" value="10" min="1" max="50" style="width:100%;">
                    </div>

                    <h4 style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px; margin-top:20px;">
                        📝 3. 文案定制</h4>
                    <div style="margin-bottom:5px;"><input type="text" id="posterTitleInput" value="光荣榜"
                            placeholder="大标题" style="width:100%;"></div>
                    <div style="margin-bottom:10px;"><input type="text" id="posterSubInput" value="本次期末考试优秀名单"
                            placeholder="副标题" style="width:100%;"></div>

                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="renderPoster()">🔄
                        生成/刷新预览</button>
                </div>

                <!-- 右侧：预览画布 -->
                <div class="poster-preview-area">
                    <div id="poster-canvas" class="poster-canvas theme-red">
                        <div class="p-header">
                            <h1 class="p-title" contenteditable="true">光荣榜</h1>
                            <div class="p-sub" contenteditable="true">2024-2025学年 第一学期期末考试</div>
                        </div>
                        <div class="p-list" id="poster-list-container">
                            <!-- 列表项将在这里生成 -->
                            <div style="text-align:center; padding-top:100px; opacity:0.7;">
                                请在左侧选择数据并点击生成
                            </div>
                        </div>
                        <div class="p-footer" contenteditable="true">
                            星光不问赶路人 · 时光不负有心人<br>
                            xx中学教务处 宣
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- 语音控制入口 -->
    <div id="voice-fab" class="voice-fab" onclick="VoiceControl.toggle()" title="点击开启语音控制">
        <i class="ti ti-microphone"></i>
    </div>

    <!-- 全屏语音 HUD -->
    <div id="voice-hud" class="voice-hud" onclick="VoiceControl.stop()">
        <div class="voice-wave">
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
            <div class="voice-bar"></div>
        </div>
        <div id="voice-status" class="voice-text-main">正在聆听...</div>
        <div id="voice-result" class="voice-text-sub">请说出指令，例如：“打开全科总表”</div>

        <div class="voice-cmd-list">
            <div class="voice-cmd-item"><span class="voice-cmd-key">"看总榜"</span> 跳转综合排名</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"看教师"</span> 教师分析</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"查某某"</span> 搜索学生</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"全屏模式"</span> 隐藏菜单</div>
            <div class="voice-cmd-item"><span class="voice-cmd-key">"退出语音"</span> 关闭语音</div>
        </div>
        <div style="margin-top: 30px; font-size: 12px; color: #64748b;">(点击任意处关闭)</div>
    </div>

    <div id="drill-modal" class="modal" style="display: none; z-index: 12000;">
        <!-- 修改点：style 中宽度改为 95%，max-width 改为 1200px，高度改为 90vh -->
        <div class="modal-content"
            style="width: 95%; max-width: 1200px; height: 90vh; display: flex; flex-direction: column;">

            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="drill-back-btn" class="btn btn-sm btn-gray hidden" onclick="DrillSystem.goBack()">
                        <i class="ti ti-arrow-left"></i> 返回
                    </button>
                    <h3 id="drill-title" style="margin:0; color:var(--primary); font-size:18px;">数据详情</h3>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <!-- 新增导出按钮 -->
                    <button id="drill-export-btn" class="btn btn-sm btn-green" onclick="DrillSystem.exportExcel()">
                        <i class="ti ti-file-export"></i> 导出为Excel
                    </button>
                    <button onclick="document.getElementById('drill-modal').style.display='none'"
                        style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
            </div>

            <!-- 内容区域 -->
            <div id="drill-content" style="flex:1; overflow-y:auto;"></div>

            <!-- 底部统计 -->
            <div id="drill-footer"
                style="border-top:1px solid #eee; padding-top:10px; margin-top:10px; font-size:12px; color:#666; text-align:right;">
            </div>
        </div>
    </div>

    <div id="target-editor-modal" class="modal" style="display: none; z-index: 11500;">
        <div class="modal-content" style="width: 90%; max-width: 1000px;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <h3 style="color:var(--primary); margin:0;">🎯 设定各校指标目标</h3>
                <button onclick="document.getElementById('target-editor-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div class="info-bar" style="margin-bottom:10px;">
                💡 提示：此处修改将直接更新内存数据，记得点击“开始计算”刷新结果。
            </div>

            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="target-editor-table">
                    <thead>
                        <tr>
                            <th>学校名称</th>
                            <th style="background:#e0f2fe;">指标一目标 (人)</th>
                            <th style="background:#fff7ed;">指标二目标 (人)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:15px; text-align:right;">
                <button class="btn btn-gray"
                    onclick="document.getElementById('target-editor-modal').style.display='none'">取消</button>
                <button class="btn btn-primary" onclick="saveTargetEditor()">💾 保存并重算</button>
            </div>
        </div>
    </div>

    <style>
        /* 钻取弹窗专用样式 */
        .drill-class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .drill-class-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .drill-class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
            background: #eff6ff;
        }

        .drill-val {
            font-size: 18px;
            font-weight: 800;
            color: var(--primary);
            margin: 5px 0;
        }

        .drill-label {
            font-size: 12px;
            color: #64748b;
        }

        .drill-stu-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .drill-stu-tag {
            background: white;
            border: 1px solid #cbd5e1;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .drill-stu-score {
            color: var(--primary);
            font-weight: bold;
            font-family: monospace;
        }

        .clickable-num {
            cursor: pointer;
            text-decoration: underline;
            color: var(--primary);
            font-weight: bold;
        }

        .clickable-num:hover {
            color: #d97706;
        }
    </style>
    <!-- 批量打印隐藏容器 -->
    <div id="batch-print-container" style="display:none;"></div>
    <div id="desk-labels-print-area"></div>
    <!-- 全局快捷搜索弹窗 -->
    <div id="spotlight-mask" class="spotlight-mask" onclick="closeSpotlight(event)">
        <div class="spotlight-box" onclick="event.stopPropagation()">
            <div class="spotlight-input-wrap">
                <i class="ti ti-search" style="font-size:24px; color:var(--primary); margin-right:10px;"></i>
                <input type="text" id="spotlight-input" class="spotlight-input" placeholder="输入姓名、学校或班级..."
                    oninput="doSpotlightSearch()">
            </div>
            <div id="spotlight-results" class="spotlight-results"></div>
            <div class="spotlight-hint">输入关键字搜索，点击结果可直接跳转至该生分析报告</div>
        </div>
    </div>
    <!-- 教师详情模态框 -->
    <div class="modal" id="teacherModal" style="display: none;">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h3 id="modalTeacherName" style="color:var(--primary);">教师姓名</h3><button id="closeModal"
                    style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                <div class="bg-gray-50">
                    <h4 style="margin-bottom:15px; color:#333;">教学概况</h4>
                    <div style="display:flex; justify-content:space-around;">
                        <div class="stat-item">
                            <div class="stat-value" id="modalAvgScore">0.00</div>
                            <div class="stat-label">平均分</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="modalExcellentRate">0%</div>
                            <div class="stat-label">优秀率</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="modalPassRate">0%</div>
                            <div class="stat-label">及格率</div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50">
                    <h4 style="margin-bottom:15px; color:#333;">对比分析</h4>
                    <div style="margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:5px;">
                            <span>平均分对比</span><span id="modalAvgComparison">0%</span>
                        </div>
                        <div style="height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden;">
                            <div id="modalAvgProgress" style="width:0; height:100%; transition:1s;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <table class="subject-table" id="modalSubjectTable">
                <thead>
                    <tr>
                        <th>学科</th>
                        <th>平均分</th>
                        <th>对比</th>
                        <th>优秀率</th>
                        <th>对比</th>
                        <th>及格率</th>
                        <th>对比</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="mobileShareModal" style="display: none; z-index: 10001;">
        <div class="modal-content" style="max-width: 450px; text-align: center; background: #333;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="color:white; font-size:16px;">📱 长按/右键保存图片</h3>
                <button onclick="document.getElementById('mobileShareModal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="mobile-img-result" style="max-height: 80vh; overflow-y: auto; border:1px solid #555;">
                <!-- 图片将生成在这里 -->
            </div>
            <div style="margin-top:15px;">
                <button class="btn btn-primary" onclick="downloadMobileImage()">⬇️ 下载图片</button>
            </div>
        </div>
    </div>
    <!-- 同名同姓/转班 手动映射确认框 -->
    <div class="modal" id="mappingModal" style="display: none; z-index: 10002;">
        <div class="modal-content" style="max-width: 700px;">
            <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="color:#d97706; font-size:18px;">⚠️ 检测到疑似同名/转班学生</h3>
                <p style="font-size:13px; color:#666; margin-top:5px;">
                    系统发现以下学生在“上次考试”中有同名记录，但班级不一致（可能转班了）。<br>
                    请手动确认对应关系，以便精确计算进退步。
                </p>
            </div>

            <div class="table-wrap" style="max-height: 50vh; overflow-y: auto;">
                <table id="mappingTable" style="width:100%; font-size:13px;">
                    <thead>
                        <tr>
                            <th style="background:#fef3c7;">当前学生 (本次)</th>
                            <th style="background:#fef3c7;">选择对应的上次记录</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div style="margin-top:20px; text-align:right; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-gray"
                    onclick="document.getElementById('mappingModal').style.display='none'">取消分析</button>
                <button class="btn btn-primary" onclick="confirmMappingsAndRun()">✅ 确认匹配并继续</button>
            </div>
        </div>
    </div>
    <!-- 电子奖状模态框 -->
    <div id="cert-modal" class="modal" style="display: none; z-index: 10005;">
        <div class="modal-content" style="max-width: 550px; text-align: center; background: #fff; padding: 10px;">
            <!-- 这里是奖状的可视化区域 -->
            <div id="cert-capture-area"
                style="padding: 40px; background: #fffaf0; border: 12px double #b45309; position: relative; overflow: hidden; box-shadow: inset 0 0 50px rgba(180,83,9,0.05);">
                <!-- 背景装饰：由于是单文件，我们用 CSS 画一个简易防伪印章效果 -->
                <div
                    style="position: absolute; bottom: 30px; right: 40px; width: 100px; height: 100px; border: 3px solid rgba(220,38,38,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: rgba(220,38,38,0.2); font-weight: bold; transform: rotate(-15deg); pointer-events: none; font-size: 14px;">
                    教务处核准</div>

                <h1 style="color: #b45309; font-size: 42px; margin-bottom: 5px; font-family: 'STKaiti', '楷体', serif;">
                    荣誉证书</h1>
                <div style="width: 150px; height: 3px; background: #b45309; margin: 0 auto 25px;"></div>

                <p style="font-size: 22px; margin-top: 20px; text-align: left; line-height: 2;">
                    <strong id="cert-name"
                        style="border-bottom: 2px solid #333; padding: 0 15px; color: #1e293b;">张三</strong> 同学：
                </p>
                <p style="text-align: left; text-indent: 2.5em; line-height: 2; font-size: 18px; color: #374151;">
                    在本次 <span id="cert-exam-name" style="font-weight: bold; color: #2563eb;">期末考试</span>
                    中，凭借坚持不懈的努力和出色的表现，获得了
                    <strong id="cert-honor" style="color: #dc2626; font-size: 24px;">“进步之星”</strong>
                    光荣称号，特发此证，以资鼓励！
                </p>
                <div style="margin-top: 50px; text-align: right; padding-right: 20px;">
                    <p style="font-weight: bold; font-size: 18px; color: #1e293b;" id="cert-school-footer">XX中学教务处</p>
                    <p id="cert-date" style="color: #64748b;">2024年12月</p>
                </div>
            </div>

            <!-- 底部操作按钮 -->
            <div style="margin-top: 20px; display: flex; gap: 15px; padding: 10px;">
                <button class="btn btn-orange" style="flex:1; font-size: 16px; height: 45px;"
                    onclick="downloadCertificate()">
                    <i class="ti ti-download"></i> 保存奖状为高清图片
                </button>
                <button class="btn btn-gray" style="width: 100px;"
                    onclick="document.getElementById('cert-modal').style.display='none'">关闭</button>
            </div>
        </div>
    </div>
    <div id="school-profile-modal" class="modal" style="display: none;">
        <div class="modal-content" style="width: 95%; max-width: 1400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="sp-title" style="margin:0; color:var(--primary); font-size:20px;">🏫 学校画像</h3>
                <button onclick="document.getElementById('school-profile-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div class="school-modal-grid">
                <!-- 左侧：雷达图 -->
                <div
                    style="background:#f8fafc; border-radius:8px; padding:10px; border:1px solid #e2e8f0; height:300px; position:relative;">
                    <h4 style="text-align:center; font-size:13px; color:#64748b; margin-bottom:5px;">学科均衡度诊断 (vs 全镇均值)
                    </h4>
                    <div style="height:260px; width:100%;"><canvas id="schoolRadarChart"></canvas></div>
                </div>

                <!-- 右侧：数据概览 -->
                <div>
                    <h4 style="margin-bottom:10px; border-left:4px solid var(--primary); padding-left:8px;">📊 核心指标</h4>
                    <div class="fb-dashboard" style="grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">综合排名</div>
                            <div class="fb-val text-red" id="sp-rank">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">考核总分</div>
                            <div class="fb-val text-blue" id="sp-score">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">平均分赋分</div>
                            <div class="fb-val" id="sp-s1">-</div>
                        </div>
                        <div class="fb-card" style="padding:10px;">
                            <div class="fb-lbl">三率赋分</div>
                            <div class="fb-val" id="sp-s2">-</div>
                        </div>
                    </div>

                    <div class="info-bar" style="font-size:12px;">
                        💡 <strong>诊断建议：</strong><br>
                        <span id="sp-diagnosis">点击学校查看分析...</span>
                    </div>
                </div>
            </div>

            <!-- 分数段分布图 (双轴) -->
            <div style="margin-top:20px; padding-top:15px; border-top:1px dashed #e2e8f0;">
                <h4
                    style="margin-bottom:10px; color:#333; font-size:14px; display:flex; justify-content:space-between;">
                    <span>📉 分数段结构对比 (本校 vs 全镇)</span>
                    <span style="font-weight:normal; font-size:12px; color:#666;">柱状=本校占比 | 折线=全镇均值</span>
                </h4>
                <div style="height:180px; width:100%; position:relative;">
                    <canvas id="schoolDistChart"></canvas>
                </div>
            </div>

            <div class="school-modal-actions">
                <span style="font-size:12px; color:#999; margin-right:auto; align-self:center;">跳转后将自动筛选该校数据</span>
                <button class="btn btn-purple" onclick="jumpToModule('class-comparison')"><i
                        class="ti ti-layout-columns"></i> 班级对比</button>
                <button class="btn btn-blue" onclick="jumpToModule('teacher-analysis')"><i class="ti ti-school"></i>
                    教师评价</button>
                <button class="btn btn-green" onclick="jumpToModule('student-details')"><i class="ti ti-users"></i>
                    学生名单</button>
            </div>
        </div>
    </div>
    <!-- 外观设置模态框 -->
    <div id="skin-modal" class="modal" style="display: none; z-index: 11000;">
        <div class="modal-content" style="max-width: 500px;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:var(--primary);"><i class="ti ti-palette"></i> 系统外观定制</h3>
                <button onclick="document.getElementById('skin-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 1. 主题色设置 -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">1. 选择主色调</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                    <!-- 预设颜色 -->
                    <div onclick="setThemeColor('#4f46e5')"
                        style="width:30px; height:30px; background:#4f46e5; border-radius:50%; cursor:pointer; border:2px solid #ddd;"
                        title="默认紫"></div>
                    <div onclick="setThemeColor('#2563eb')"
                        style="width:30px; height:30px; background:#2563eb; border-radius:50%; cursor:pointer; border:2px solid #ddd;"
                        title="科技蓝"></div>
                    <div onclick="setThemeColor('#059669')"
                        style="width:30px; height:30px; background:#059669; border-radius:50%; cursor:pointer; border:2px solid #ddd;"
                        title="护眼绿"></div>
                    <div onclick="setThemeColor('#dc2626')"
                        style="width:30px; height:30px; background:#dc2626; border-radius:50%; cursor:pointer; border:2px solid #ddd;"
                        title="中国红"></div>
                    <div onclick="setThemeColor('#b45309')"
                        style="width:30px; height:30px; background:#b45309; border-radius:50%; cursor:pointer; border:2px solid #ddd;"
                        title="尊贵金"></div>
                    <div onclick="setThemeColor('#0f172a')"
                        style="width:30px; height:30px; background:#0f172a; border-radius:50%; cursor:pointer; border:2px solid #ddd;"
                        title="深邃黑"></div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="color" id="custom-color-input" onchange="setThemeColor(this.value)"
                        style="width:50px; height:30px; padding:0; border:none;">
                    <span style="font-size:12px; color:#666;">自定义颜色 (点击色块选择)</span>
                </div>
            </div>

            <!-- 2. Logo 设置 -->
            <div style="margin-bottom: 25px;">
                <h4 style="margin-bottom:10px; color:#333;">2. 定制校徽/Logo</h4>
                <div class="upload-box" style="padding:15px; border:1px dashed #ccc; min-height:auto;"
                    onclick="document.getElementById('logoInput').click()">
                    <div style="color:var(--primary); font-size:20px;"><i class="ti ti-photo-up"></i> 点击上传 Logo 图片</div>
                    <p style="font-size:12px; color:#999; margin:5px 0;">建议使用透明背景 PNG，高度60px左右<br>图片将保存在本地浏览器中</p>
                    <input type="file" id="logoInput" accept="image/*" hidden onchange="handleLogoUpload(this)">
                </div>
                <button class="btn btn-gray btn-sm" onclick="clearLogo()" style="margin-top:5px;">🗑️ 清除 Logo</button>
            </div>

            <!-- 3. 标题设置 -->
            <div style="margin-bottom: 10px;">
                <h4 style="margin-bottom:10px; color:#333;">3. 系统名称</h4>
                <input type="text" id="custom-title-input" placeholder="默认为：乡镇学校成绩分析..."
                    style="width:100%; margin-bottom:5px;" oninput="updateTitlePreview(this.value)">
                <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="saveSkinSettings()">💾
                    保存并应用</button>
            </div>
        </div>
    </div>
    <div id="admin-modal" class="modal" style="display: none; z-index: 60000;">
        <div class="modal-content" style="max-width: 600px;"> <!-- 稍微调宽一点 -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3 style="color:#b91c1c; margin:0;"><i class="ti ti-shield-lock"></i> 账号管理</h3>
                    <!-- 新增：查看日志按钮 -->
                    <button onclick="Logger.view()"
                        style="font-size:12px; background:#fff; border:1px solid #ccc; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; align-items:center; gap:4px;">
                        <i class="ti ti-history"></i> 操作日志
                    </button>
                </div>
                <button onclick="document.getElementById('admin-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div class="info-bar" style="margin-bottom:20px;">
                此处功能将基于您在【数据中心】上传的 Excel 数据批量生成账号。<br>
                所有生成账号的默认初始密码均为 <strong>123456</strong>。
            </div>

            <div style="display:grid; gap:15px;">
                <!-- 功能区 1 -->
                <div style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <h4 style="margin-bottom:10px; color:#334155;">1. 批量生成/重置账号</h4>
                    <div style="margin-bottom:10px;">
                        <label
                            style="font-size:12px; font-weight:bold; color:#64748b; display:block; margin-bottom:5px;">
                            请选择要生成的学校 (多选):
                        </label>
                        <div id="admin-gen-school-list"
                            style="max-height:100px; overflow-y:auto; background:white; border:1px solid #cbd5e1; border-radius:4px; padding:5px; font-size:12px;">
                            <div style="color:#999; text-align:center; padding:10px;">暂无数据，请先上传成绩</div>
                        </div>
                        <div style="text-align:right; margin-top:2px;">
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(true)"
                                style="font-size:11px; color:var(--primary);">全选</a> /
                            <a href="javascript:void(0)" onclick="Auth.toggleAllSchools(false)"
                                style="font-size:11px; color:var(--primary);">清空</a>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="Auth.generateAccounts()" style="width:100%;">
                        <i class="ti ti-user-plus"></i> 一键生成所有账号 (教师+家长)
                    </button>
                    <button class="btn btn-green" onclick="Auth.exportAccounts()"
                        style="width:100%; background:#059669; color:white;">
                        <i class="ti ti-file-export"></i> 导出账号密码表 (Excel)
                    </button>
                    <!-- 新增：批量同步云端按钮 -->
                    <button class="btn btn-blue" onclick="Auth.syncBatchToCloud()"
                        style="width:100%; background:#2563eb; color:white; margin-top:5px;">
                        <i class="ti ti-cloud-upload"></i> 一键同步所有账号到云端 (Database)
                    </button>
                    <p style="font-size:11px; color:#64748b; margin-top:2px; text-align:center;">
                        将本地生成的账号批量写入 Supabase 数据库，以便用户登录。
                    </p>
                    <!-- 新增：清空云端按钮 -->
                    <div style="margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                        <button class="btn btn-danger" onclick="Auth.deleteCloudAccounts()"
                            style="width:100%; background:#dc2626; color:white;">
                            <i class="ti ti-trash-x"></i> ⚠️ 清空云端所有普通账号
                        </button>
                        <p style="font-size:11px; color:#ef4444; margin-top:2px; text-align:center;">
                            警告：将删除云端所有家长和教师账号（保留管理员）。
                        </p>
                    </div>
                    <hr style="margin: 15px 0; border:0; border-top:1px dashed #ccc;">
                    <h4 style="margin-bottom:10px; color:#7c3aed;">🚀 发送给家长</h4>
                    <button class="btn btn-purple" onclick="Packager.exportDistributableHTML()"
                        style="width:100%; background:#7c3aed; color:white; font-weight:bold;">
                        <i class="ti ti-package"></i> 生成可分发网页 (含数据)
                    </button>
                    <p
                        style="font-size:11px; color:#7c3aed; margin-top:5px; background:#f3e8ff; padding:5px; border-radius:4px;">
                        生成一个内置了成绩和账号的新HTML文件。请把这个新文件发到家长群。
                    </p>
                    <p style="font-size:12px; color:#666; margin-top:5px;">
                        教师账号 = 教师姓名 (默认密码 yssy2016)<br> <!-- 🟢 修改点：更新显示文本 -->
                        家长账号 = 学生姓名 (默认密码 123456)
                    </p>
                </div>

                <!-- 功能区 2: 云端账号管理 (修正版) -->
                <div
                    style="background:#fff; padding:15px; border:1px solid #cbd5e1; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">

                    <!-- 👇👇👇 🟢 修改：增加了班主任、级部主任选项，以及右侧的 Excel 工具栏 🟢 👇👇👇 -->
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <h4 style="margin:0; color:#0369a1;"><i class="ti ti-cloud-upload"></i> 2. 添加/管理云端账号</h4>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-sm btn-green" onclick="AccountExcel.downloadTemplate()"
                                title="下载导入模板">
                                <i class="ti ti-download"></i> 模板
                            </button>
                            <button class="btn btn-sm btn-orange"
                                onclick="document.getElementById('accExcelInput').click()" title="上传Excel批量导入">
                                <i class="ti ti-file-import"></i> 导入
                            </button>
                            <input type="file" id="accExcelInput" accept=".xlsx,.xls" hidden
                                onchange="AccountExcel.upload(this)">
                        </div>
                    </div>

                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <select id="manual-role" style="padding:8px; border:1px solid #ccc; width:30%; font-size:12px;"
                            onchange="toggleAdminManualInput()">
                            <option value="teacher">👨‍🏫 科任教师</option>
                            <option value="class_teacher">📋 班主任</option>
                            <option value="grade_director">🚀 级部主任</option>
                            <option value="director">🎓 教务主任</option>
                            <option value="parent">👨‍👩‍👧 家长</option>
                            <option value="admin">🔑 管理员</option>
                        </select>
                        <!-- 级部输入框 (默认隐藏) -->
                        <input type="text" id="manual-grade" placeholder="级部(如:7)"
                            style="padding:8px; border:1px solid #ccc; width:20%; display:none;">

                        <input type="text" id="manual-school" placeholder="所属学校 (必填)"
                            style="padding:8px; border:1px solid #ccc; width:25%;">
                        <input type="text" id="manual-name" placeholder="账号/姓名"
                            style="padding:8px; border:1px solid #ccc; flex:1;">
                    </div>

                    <!-- 班级输入框 (默认隐藏，仅家长需要) -->
                    <div id="manual-class-wrap" style="margin-bottom:10px; display:none;">
                        <input type="text" id="manual-class" placeholder="输入班级 (如: 701，家长必填)"
                            style="width:100%; padding:8px; border:1px solid #ccc;">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <input type="text" id="manual-pass" value="123456" placeholder="密码"
                            style="padding:8px; border-radius:4px; border:1px solid #ccc; width:60%;">
                        <!-- 这里的 onclick 必须指向 Auth.addCloudAccount -->
                        <button class="btn btn-primary" onclick="Auth.addCloudAccount()" style="flex:1;">添加/更新</button>
                    </div>
                    <p style="font-size:12px; color:#999; margin-top:5px;">提示：直接写入云端数据库。账号必须唯一。</p>
                </div>

                <script>
                    // 👇👇👇 🟢 新增：Excel 账号批量导入工具 🟢 👇👇👇
                    const AccountExcel = {
                        downloadTemplate: function () {
                            const wb = XLSX.utils.book_new();
                            const headers = ["角色", "学校", "班级", "级部(年级)", "姓名/账号", "密码", "备注"];
                            const data = [
                                headers,
                                ["科任教师", "实验中学", "", "7", "张老师", "123456", "只看自己教的课"],
                                ["班主任", "实验中学", "701", "7", "王班头", "123456", "看本班所有"],
                                ["级部主任", "实验中学", "", "7", "李级部", "123456", "管理整个七年级"],
                                ["家长", "实验中学", "701", "", "张小明", "123456", "只能看自己"],
                                ["教务主任", "实验中学", "", "", "赵主任", "123456", "查看全校"]
                            ];
                            const ws = XLSX.utils.aoa_to_sheet(data);
                            ws['!cols'] = [{ wch: 12 }, { wch: 15 }, { wch: 8 }, { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 20 }];
                            XLSX.utils.book_append_sheet(wb, ws, "账号导入模板");
                            XLSX.writeFile(wb, "账号批量导入模板.xlsx");
                        },

                        upload: function (input) {
                            const file = input.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = async function (e) {
                                try {
                                    const data = new Uint8Array(e.target.result);
                                    const wb = XLSX.read(data, { type: 'array' });
                                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                                    if (json.length === 0) return alert("表格为空");
                                    if (!confirm(`解析到 ${json.length} 条账号数据，确定要导入云端吗？`)) return;

                                    UI.loading(true, "正在批量创建云端账号...");

                                    const roleMap = {
                                        "科任教师": "teacher", "教师": "teacher",
                                        "班主任": "class_teacher",
                                        "级部主任": "grade_director", "年级主任": "grade_director",
                                        "家长": "parent", "学生": "parent",
                                        "教务主任": "director",
                                        "管理员": "admin"
                                    };

                                    let successCount = 0;
                                    const batchData = [];

                                    json.forEach(row => {
                                        const roleCN = row['角色'] || "";
                                        const role = roleMap[roleCN.trim()] || "teacher"; // 默认教师
                                        const user = row['姓名/账号'] || row['姓名'];
                                        const pass = row['密码'] || "123456";
                                        const school = row['学校'] || window.MY_SCHOOL || "默认学校";
                                        const cls = row['班级'] ? String(row['班级']).trim() : "";
                                        const grade = row['级部(年级)'] ? String(row['级部(年级)']).trim() : ""; // 新增级部字段

                                        if (user) {
                                            batchData.push({
                                                username: user,
                                                password: pass.toString(),
                                                role: role,
                                                school: school,
                                                class_name: role === 'class_teacher' || role === 'parent' ? cls : (role === 'grade_director' ? grade : ""), // 级部主任的class字段存年级
                                                // 注意：这里复用了 class_name 字段。
                                                // 对于级部主任，class_name 存 "7" (代表7年级)
                                                // 对于班主任，class_name 存 "701"
                                            });
                                        }
                                    });

                                    // 分批写入 Supabase
                                    const { error } = await sbClient.from('system_users').upsert(batchData, { onConflict: 'username' });

                                    UI.loading(false);
                                    if (error) throw error;

                                    alert(`✅ 成功导入 ${batchData.length} 个账号！`);
                                    input.value = ''; // 清空

                                } catch (err) {
                                    UI.loading(false);
                                    alert("导入失败：" + err.message);
                                }
                            };
                            reader.readAsArrayBuffer(file);
                        }
                    };

                    // 👇👇👇 🟢 修改：输入框联动逻辑 (适配新角色) 🟢 👇👇👇
                    function toggleAdminManualInput() {
                        const role = document.getElementById('manual-role').value;
                        const clsWrap = document.getElementById('manual-class-wrap'); // 家长/班主任用
                        const clsInput = document.getElementById('manual-class');
                        const nameInp = document.getElementById('manual-name');
                        const schoolInp = document.getElementById('manual-school');
                        const gradeInp = document.getElementById('manual-grade'); // 级部主任用

                        // 1. 先全部隐藏/重置
                        clsWrap.style.display = 'none';
                        gradeInp.style.display = 'none';
                        schoolInp.style.display = 'block'; // 默认显示学校

                        // 2. 根据角色开启特定框
                        if (role === 'parent') {
                            clsWrap.style.display = 'block';
                            clsInput.placeholder = "输入班级 (如: 701，家长必填)";
                            nameInp.placeholder = "学生姓名";
                        }
                        else if (role === 'class_teacher') {
                            clsWrap.style.display = 'block';
                            clsInput.placeholder = "管理班级 (如: 701)";
                            nameInp.placeholder = "班主任姓名";
                        }
                        else if (role === 'grade_director') {
                            gradeInp.style.display = 'block'; // ✅ 确保这行执行，显示年级框
                            nameInp.placeholder = "主任姓名";
                        }
                        else if (role === 'director') {
                            nameInp.placeholder = "主任姓名";
                        }
                        else if (role === 'admin') {
                            schoolInp.style.display = 'none'; // 管理员不需要填学校
                            nameInp.placeholder = "管理员账号";
                        }
                        else { // teacher
                            nameInp.placeholder = "教师姓名";
                        }
                    }
                </script>

                <!-- 功能区 3 -->
                <div style="background:#fff; padding:15px; border:1px solid #eee; border-radius:8px;">
                    <h4 style="margin-bottom:10px; color:#333;">3. 修改管理员密码</h4>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="new-admin-pass" placeholder="输入新密码"
                            style="padding:8px; flex:1; border:1px solid #cbd5e1; border-radius:4px;">
                        <button class="btn btn-gray" onclick="changeAdminPass()">确认修改</button>
                    </div>
                </div>
                <div
                    style="background:#f0fdf4; padding:15px; border:1px solid #86efac; border-radius:8px; margin-top:5px;">
                    <h4 style="margin-bottom:10px; color:#166534;"><i class="ti ti-cloud-download"></i> 4. 导出云端所有账号
                        (完整备份)</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <p style="font-size:12px; color:#15803d; margin:0; flex:1;">
                            此功能直接从云端数据库下载，包含<strong>批量生成</strong>、<strong>手动添加</strong>及<strong>Excel导入</strong>的所有账号。<br>
                            包含：角色、学校、班级、账号、密码。
                        </p>
                        <button class="btn btn-green" onclick="Auth.exportAllCloudAccounts()"
                            style="background:#16a34a; color:white; font-weight:bold; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                            <i class="ti ti-download"></i> 下载全量账号表
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 简单的修改密码脚本 (内联 - 云端同步版) -->
    <script>
        async function changeAdminPass() {
            const p = document.getElementById('new-admin-pass').value.trim();
            if (!p) return alert("密码不能为空");

            // 1. 更新本地状态 (确保当前会话立即生效)
            if (typeof Auth !== 'undefined') {
                Auth.db.admin.pass = p;
                localStorage.setItem('SYS_USERS', JSON.stringify(Auth.db));
            }

            // 2. 同步到云端数据库 (核心修复)
            if (sbClient) {
                // 显示加载动画
                const loader = document.getElementById('global-loader');
                const txt = document.getElementById('loader-text');
                if (loader) { loader.classList.remove('hidden'); if (txt) txt.innerText = "正在更新云端密码..."; }

                try {
                    // 更新 system_users 表中 username='admin' 的记录
                    const { error } = await sbClient
                        .from('system_users')
                        .update({ password: p })
                        .eq('username', 'admin');

                    // 隐藏加载动画
                    if (loader) loader.classList.add('hidden');

                    if (error) {
                        console.error(error);
                        alert("❌ 本地修改成功，但【云端同步失败】！\n错误信息：" + error.message);
                    } else {
                        alert("✅ 管理员密码已修改！\n(本地和云端均已更新为: " + p + ")");
                        document.getElementById('new-admin-pass').value = '';
                    }
                } catch (err) {
                    if (loader) loader.classList.add('hidden');
                    alert("❌ 程序异常：" + err.message);
                }
            } else {
                alert("⚠️ 警告：未连接到云端数据库，仅修改了本地缓存密码。");
            }
        }
    </script>

    <!-- 用户个人修改密码逻辑 (通用 - 完整修复版) -->
    <script>
        // 1. 打开修改密码弹窗 (支持强制模式)
        function openUserPasswordModal(isForced = false) {
            // 获取当前用户
            const user = JSON.parse(sessionStorage.getItem('CURRENT_USER'));
            if (!user) return alert("未检测到登录用户，请刷新页面。");

            // 清空输入框
            document.getElementById('upm-old').value = '';
            document.getElementById('upm-new').value = '';
            document.getElementById('upm-confirm').value = '';

            const modal = document.getElementById('user-password-modal');
            const closeBtn = modal.querySelector('button[onclick*="none"]'); // 查找关闭按钮

            if (isForced) {
                // 🔴 强制模式：隐藏关闭按钮，禁止点击背景关闭
                if (closeBtn) closeBtn.style.display = 'none';
                // 简单的防止点击背景关闭逻辑 (覆盖 onclick)
                modal.onclick = (e) => e.stopPropagation();
            } else {
                // 普通模式：显示关闭按钮
                if (closeBtn) closeBtn.style.display = 'block';
                modal.onclick = (e) => {
                    if (e.target === modal) modal.style.display = 'none';
                };
            }

            // 显示弹窗
            modal.style.display = 'flex';
        }

        // 2. 提交密码修改 (同步云端)
        async function submitUserPasswordChange() {
            // 检查数据库连接
            if (!sbClient) return alert("❌ 云端未连接，无法修改密码。");

            const user = JSON.parse(sessionStorage.getItem('CURRENT_USER'));
            if (!user) return alert("未检测到登录用户，请刷新重试。");

            // 获取输入值
            const oldPass = document.getElementById('upm-old').value.trim();
            const newPass = document.getElementById('upm-new').value.trim();
            const confirmPass = document.getElementById('upm-confirm').value.trim();

            // 基础校验
            if (!oldPass || !newPass) return alert("密码不能为空");
            if (newPass !== confirmPass) return alert("两次输入的新密码不一致");
            if (newPass.length < 6) return alert("新密码长度至少需要 6 位，建议使用字母+数字组合");
            if (oldPass === newPass) return alert("新密码不能与旧密码相同");

            UI.loading(true, "正在验证并更新密码...");

            try {
                // A. 验证旧密码是否正确 (必须去数据库查，防止本地篡改)
                const { data: verifyData, error: verifyError } = await sbClient
                    .from('system_users')
                    .select('*')
                    .eq('username', user.name)
                    .eq('password', oldPass)
                    .maybeSingle();

                if (verifyError) {
                    throw new Error("验证旧密码时出错: " + verifyError.message);
                }

                if (!verifyData) {
                    UI.loading(false);
                    return alert("❌ 旧密码错误！请检查后重试。");
                }

                // B. 执行更新操作
                const { error: updateError } = await sbClient
                    .from('system_users')
                    .update({ password: newPass })
                    .eq('username', user.name);

                UI.loading(false);

                if (updateError) {
                    throw new Error("更新密码失败: " + updateError.message);
                }

                // C. 成功后处理
                alert("✅ 密码修改成功！\n\n为了安全起见，请使用新密码重新登录。");
                document.getElementById('user-password-modal').style.display = 'none';

                // 强制登出
                Auth.logout();

            } catch (e) {
                UI.loading(false);
                console.error(e);
                alert("❌ 修改失败：" + e.message);
            }
        }
    </script>

    <!-- 核心逻辑脚本 -->
    <script src="./assets/js/app.js"></script>

    <script>
        // ✋ 🔴 [已移除]：删除了整个 MobApp 对象及其所有逻辑，确保手机端不再加载极简版代码 🔴
    </script>
    <button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="position: fixed; bottom: 30px; left: 30px; width: 45px; height: 45px; 
               border-radius: 50%; background: rgba(30, 41, 59, 0.8); color: white; 
               border: none; cursor: pointer; display: none; z-index: 999; 
               box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s;">
        <i class="ti ti-arrow-up" style="font-size: 20px;"></i>
    </button>

    <script>
        // 监听滚动，自动显示/隐藏按钮
        window.addEventListener('scroll', () => {
            const btn = document.getElementById('back-to-top');
            if (window.scrollY > 300) {
                btn.style.display = 'block';
                btn.style.opacity = '1';
            } else {
                btn.style.display = 'none';
            }
        });
    </script>
    <!-- 修改密码模态框 -->
    <div id="user-password-modal" class="modal" style="display: none; z-index: 70000;">
        <div class="modal-content" style="max-width: 400px;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="color:var(--primary); margin:0;"><i class="ti ti-lock"></i> 修改个人密码</h3>
                <button onclick="document.getElementById('user-password-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:15px;">
                <div>
                    <label style="font-size:12px; font-weight:bold; color:#666;">当前旧密码</label>
                    <input type="password" id="upm-old" placeholder="输入当前密码"
                        style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold; color:#666;">新密码 (建议字母+数字)</label>
                    <input type="password" id="upm-new" placeholder="输入新密码"
                        style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
                </div>
                <div>
                    <label style="font-size:12px; font-weight:bold; color:#666;">确认新密码</label>
                    <input type="password" id="upm-confirm" placeholder="再次输入新密码"
                        style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
                </div>

                <button class="btn btn-primary" onclick="submitUserPasswordChange()"
                    style="padding:12px; margin-top:10px;">
                    确认修改并同步
                </button>
            </div>
        </div>
    </div>

    <!-- 1. 家长端：申诉提交弹窗 -->
    <div id="issue-submit-modal" class="modal" style="display: none; z-index: 75000;">
        <div class="modal-content" style="max-width: 500px;">
            <div style="border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:15px;">
                <h3 style="color:#b45309; margin:0; font-size:18px;">📝 成绩核查申请</h3>
                <p style="font-size:12px; color:#666; margin-top:5px;">请填写具体问题，教务处将在核实后处理。</p>
            </div>

            <div style="display:grid; gap:15px;">
                <!-- 隐藏域：自动填充学生信息 -->
                <div
                    style="background:#f9fafb; padding:10px; border-radius:6px; font-size:13px; color:#374151; display:flex; gap:10px;">
                    <input type="text" id="issue-student-school" readonly
                        style="flex:1; border:none; background:transparent; font-weight:bold;">
                    <input type="text" id="issue-student-class" readonly
                        style="width:60px; border:none; background:transparent; font-weight:bold;">
                    <input type="text" id="issue-student-name" readonly
                        style="width:80px; border:none; background:transparent; font-weight:bold;">
                </div>

                <div>
                    <label style="font-size:12px; font-weight:bold; color:#374151;">问题类型</label>
                    <select id="issue-type"
                        style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;">
                        <option value="缺考/零分">❌ 显示缺考/零分 (实际已考)</option>
                        <option value="分数错误">📉 分数与预估严重不符</option>
                        <option value="信息有误">🆔 姓名/考号错误</option>
                        <option value="其他">📝 其他问题</option>
                    </select>
                </div>

                <div>
                    <label style="font-size:12px; font-weight:bold; color:#374151;">具体说明 (必填)</label>
                    <textarea id="issue-desc" rows="4" placeholder="例如：数学试卷已交，但系统显示0分。大致预估分数为90分左右。"
                        style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px; font-size:14px;"></textarea>
                </div>

                <div>
                    <label style="font-size:12px; font-weight:bold; color:#374151;">联系电话 (选填)</label>
                    <input type="text" id="issue-contact" placeholder="方便老师回访"
                        style="width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;">
                </div>

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn btn-gray" style="flex:1;"
                        onclick="document.getElementById('issue-submit-modal').style.display='none'">取消</button>
                    <button class="btn btn-primary" style="flex:1; background:#b45309;"
                        onclick="IssueManager.submit()">🚀 提交申请</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 管理员端：消息处理中心 -->
    <div id="admin-issue-modal" class="modal" style="display: none; z-index: 76000;">
        <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
            <!-- 顶部标题栏 -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <!-- 动态标题 ID -->
                    <h3 style="color:var(--primary); margin:0;" id="issue-modal-title"><i class="ti ti-bell"></i> 申诉反馈中心
                    </h3>
                    <button class="btn btn-sm btn-gray" onclick="IssueManager.loadIssues()"><i
                            class="ti ti-refresh"></i> 刷新</button>
                </div>
                <button onclick="document.getElementById('admin-issue-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 操作工具栏 (包含正常模式和历史模式两套按钮) -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">

                <!-- A. 正常模式的操作按钮 -->
                <div style="display:flex; gap:10px;" id="issue-normal-actions">
                    <button class="btn btn-sm btn-danger" onclick="IssueManager.batchSoftDelete()">
                        <i class="ti ti-trash"></i> 批量删除 (放入回收站)
                    </button>
                    <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                        <input type="checkbox" id="issue-check-all" onchange="IssueManager.toggleSelectAll(this)"
                            style="margin-right:5px;"> 全选
                    </div>
                </div>

                <!-- B. 历史记录模式的操作按钮 (默认隐藏) -->
                <div style="display:none; gap:10px;" id="issue-history-actions">
                    <button class="btn btn-sm btn-danger" style="background:#b91c1c; border-color:#991b1b;"
                        onclick="IssueManager.batchHardDelete()">
                        <i class="ti ti-trash-x"></i> 彻底粉碎选中
                    </button>
                    <button class="btn btn-sm btn-green" onclick="IssueManager.batchRestore()">
                        <i class="ti ti-rotate"></i> 还原选中
                    </button>
                    <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                        <input type="checkbox" id="issue-history-check-all"
                            onchange="IssueManager.toggleSelectAll(this)" style="margin-right:5px;"> 全选
                    </div>
                </div>

                <!-- C. 切换视图按钮 -->
                <div>
                    <button class="btn btn-sm btn-gray" id="btn-issue-history"
                        onclick="IssueManager.toggleHistoryView()">
                        <i class="ti ti-history"></i> 查看删除历史
                    </button>
                </div>
            </div>

            <!-- 提示条 -->
            <div id="issue-tip-bar"
                style="background:#fffbeb; color:#92400e; padding:10px; border-radius:6px; font-size:12px; margin-bottom:10px;">
                <i class="ti ti-info-circle"></i> 提示：处理完问题后，请点击“标记已阅/解决”。点击“批量删除”会将记录移入历史记录。
            </div>

            <!-- 列表容器 -->
            <div id="admin-issue-list"
                style="flex:1; overflow-y:auto; background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #e5e7eb;">
                <!-- JS 动态加载内容 -->
            </div>
        </div>
    </div>

    <!-- 3. 管理员端：操作日志管理中心 -->
    <div id="admin-log-modal" class="modal" style="display: none; z-index: 77000;">
        <div class="modal-content" style="max-width: 900px; height: 85vh; display: flex; flex-direction: column;">
            <!-- 标题栏 -->
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h3 style="color:#333; margin:0;" id="log-modal-title"><i class="ti ti-history"></i> 系统操作日志</h3>
                    <button class="btn btn-sm btn-gray" onclick="Logger.loadLogs()"><i class="ti ti-refresh"></i>
                        刷新</button>
                </div>
                <button onclick="document.getElementById('admin-log-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 操作栏 -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <!-- 正常模式按钮 -->
                <div style="display:flex; gap:10px;" id="log-normal-actions">
                    <button class="btn btn-sm btn-danger" onclick="Logger.batchSoftDelete()">
                        <i class="ti ti-trash"></i> 批量删除
                    </button>
                    <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                        <input type="checkbox" id="log-check-all" onchange="Logger.toggleSelectAll(this)"
                            style="margin-right:5px;"> 全选
                    </div>
                </div>

                <!-- 历史模式按钮 -->
                <div style="display:none; gap:10px;" id="log-history-actions">
                    <button class="btn btn-sm btn-danger" style="background:#b91c1c;"
                        onclick="Logger.batchHardDelete()">
                        <i class="ti ti-trash-x"></i> 彻底粉碎选中
                    </button>
                    <button class="btn btn-sm btn-green" onclick="Logger.batchRestore()">
                        <i class="ti ti-rotate"></i> 还原选中
                    </button>
                    <div style="font-size:12px; color:#666; display:flex; align-items:center;">
                        <input type="checkbox" id="log-history-check-all" onchange="Logger.toggleSelectAll(this)"
                            style="margin-right:5px;"> 全选
                    </div>
                </div>

                <!-- 视图切换 -->
                <div>
                    <button class="btn btn-sm btn-gray" id="btn-log-history" onclick="Logger.toggleHistoryView()">
                        <i class="ti ti-recycle"></i> 日志回收站
                    </button>
                </div>
            </div>

            <!-- 列表容器 -->
            <div id="admin-log-list"
                style="flex:1; overflow-y:auto; background:#f9fafb; padding:0; border:1px solid #e5e7eb; border-radius:4px;">
                <!-- 表格将在这里生成 -->
            </div>

            <!-- 底部简单分页或统计 -->
            <div style="padding-top:10px; font-size:12px; color:#999; text-align:right;">
                显示最近 100 条记录
            </div>
        </div>
    </div>

    <!-- 4. 通用：账号搜索与密码管理 (多角色权限) -->
    <div id="account-manager-modal" class="modal" style="display: none; z-index: 78000;">
        <div class="modal-content" style="max-width: 700px; height: 80vh; display: flex; flex-direction: column;">

            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="color:var(--primary); margin:0;"><i class="ti ti-user-search"></i> 账号搜索与管理</h3>
                <button onclick="document.getElementById('account-manager-modal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>

            <!-- 搜索区 -->
            <div
                style="background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:15px;">
                <div style="display:flex; gap:10px;">
                    <input type="text" id="acc-search-input" placeholder="输入姓名或账号进行查找..."
                        style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:6px;"
                        onkeydown="if(event.key==='Enter') AccountManager.search()">
                    <button class="btn btn-primary" onclick="AccountManager.search()">
                        <i class="ti ti-search"></i> 搜索
                    </button>
                </div>
                <div id="acc-permission-hint" style="font-size:12px; color:#64748b; margin-top:8px;">
                    <!-- JS 会在这里显示当前用户的权限范围提示 -->
                </div>
            </div>

            <!-- 列表容器 -->
            <div class="table-wrap" style="flex:1; overflow-y:auto; box-shadow:none; border:1px solid #e2e8f0;">
                <table id="acc-result-table">
                    <thead>
                        <tr>
                            <th>账号/姓名</th>
                            <th>角色</th>
                            <th>班级/范围</th>
                            <th>当前密码</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align:center; padding:30px; color:#999;">请输入关键字搜索</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. 数据综合管理后台 (成绩/教师/档案) -->
    <div id="data-manager-modal" class="modal" style="display: none; z-index: 79000;">
        <div class="modal-content" style="max-width: 900px; height: 90vh; display: flex; flex-direction: column;">

            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <!-- ✋ 🔴 [旧代码]：标题 -->
                <h3 style="color:#0f172a; margin:0;"><i class="ti ti-database-edit"></i> 教务数据综合管理</h3>
                <!-- 🟢 [新代码]：修改标题，体现云端属性 -->
                <h3 style="color:#0f172a; margin:0;"><i class="ti ti-cloud-cog"></i> 云端教务数据综合控制台</h3>
                <!-- ✋ 🟢 [修改结束] -->

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-sm btn-purple" onclick="DataManager.saveAndSync()">
                        <i class="ti ti-cloud-upload"></i> 保存修改并同步云端
                    </button>
                    <button onclick="document.getElementById('data-manager-modal').style.display='none'"
                        style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
            </div>

            <!-- 顶部 Tab 切换 -->
            <div
                style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px; overflow-x:auto;">
                <div class="login-tab active" id="tab-data-stu" onclick="DataManager.switchTab('student')">
                    <i class="ti ti-users"></i> 学生成绩
                </div>

                <div class="login-tab" id="tab-data-tea" onclick="DataManager.switchTab('teacher')">
                    <i class="ti ti-id"></i> 教师任课
                </div>

                <div class="login-tab" id="tab-data-params" onclick="DataManager.switchTab('params')">
                    <i class="ti ti-settings"></i> 年级指标参数
                </div>
                <div class="login-tab" id="tab-data-targets" onclick="DataManager.switchTab('targets')">
                    <i class="ti ti-target"></i> 目标人数管理
                </div>

                <div class="login-tab" id="tab-data-sql" onclick="DataManager.switchTab('sql')">
                    <i class="ti ti-terminal-2"></i> SQL 极速查询
                </div>
                <div class="login-tab" id="tab-data-cloud" onclick="DataManager.switchTab('cloud')">
                    <i class="ti ti-cloud"></i> 云端存档管理
                </div>
                <div class="login-tab" id="tab-data-history" onclick="DataManager.switchTab('history')">
                    <i class="ti ti-history"></i> 历史数据对比
                </div>
            </div>

            <!-- 搜索工具栏 (仅在学生/教师 Tab 显示) -->
            <div id="dm-search-bar"
                style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:10px; display:flex; gap:10px;">
                <input type="text" id="dm-search-input" placeholder="输入姓名/班级/考号筛选..."
                    style="flex:1; padding:8px; border:1px solid #cbd5e1; border-radius:4px;"
                    oninput="DataManager.renderCurrentTab()">
                <button class="btn btn-sm btn-primary" onclick="DataManager.renderCurrentTab()">搜索</button>
                <span id="dm-stu-selected-count"
                    style="align-self:center; font-size:12px; color:#475569; white-space:nowrap;">已选 0 项</span>
                <button class="btn btn-sm btn-danger" id="dm-stu-batch-delete"
                    onclick="DataManager.deleteSelectedStudents()" disabled
                    style="opacity:0.6; white-space:nowrap;">批量删除</button>
            </div>

            <!-- 列表容器 -->
            <div class="table-wrap" style="flex:1; overflow-y:auto; box-shadow:none; border:1px solid #e2e8f0;">
                <!-- 学生表 -->
                <table id="dm-student-table" style="font-size:12px;">
                    <thead>
                        <tr>
                            <th style="width:40px; text-align:center;"><input type="checkbox" id="dm-stu-select-all"
                                    onchange="DataManager.toggleStudentSelectAll(this.checked)"></th>
                            <th>学校</th>
                            <th>班级</th>
                            <th>姓名</th>
                            <th>考号</th>
                            <th>总分</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>

                <!-- ==================== 教师任课管理区域 ==================== -->
                <div id="dm-teacher-area" style="display:none;">
                    <!-- 顶部控制栏 -->
                    <div
                        style="background:#f8fafc; padding:12px; border-bottom:2px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; position:sticky; top:0; z-index:10; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">

                        <!-- 左侧：学校和学期选择 -->
                        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                            <div style="display:flex; align-items:center; gap:6px;">
                                <label style="font-weight:bold; color:#334155; font-size:13px;">🏫 本校：</label>
                                <select id="dm-teacher-school-select"
                                    style="padding:6px 10px; width:160px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                                    onchange="DataManager.updateTeacherSchoolFilter()">
                                    <option value="">-- 显示全部 --</option>
                                </select>
                            </div>

                            <div style="display:flex; align-items:center; gap:6px;">
                                <label style="font-weight:bold; color:#334155; font-size:13px;">📅 学期：</label>
                                <select id="dm-teacher-term-select"
                                    style="padding:6px 10px; width:200px; font-size:12px; border:1px solid #cbd5e1; border-radius:6px; outline:none;"
                                    onchange="DataManager.switchTeacherTerm(this.value)"></select>
                            </div>
                        </div>

                        <!-- 右侧：操作按钮组 -->
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                            <button class="btn btn-sm btn-purple" onclick="CloudManager.loadTeachers()"
                                title="从云端同步本学期的教师任课数据"
                                style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                                <i class="ti ti-cloud-download"></i> 云端同步
                            </button>

                            <button class="btn btn-sm btn-orange" onclick="CloudManager.saveTeachers()"
                                title="保存当前教师任课数据到云端"
                                style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                                <i class="ti ti-cloud-upload"></i> 上传云端
                            </button>

                            <button class="btn btn-sm btn-green"
                                onclick="document.getElementById('dm-teacher-file').click()" title="导入Excel格式的教师任课表"
                                style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                                <i class="ti ti-file-import"></i> Excel导入
                            </button>
                            <input type="file" id="dm-teacher-file" accept=".xlsx,.xls" hidden
                                onchange="DataManager.handleTeacherUpload(this)">

                            <button class="btn btn-sm btn-primary" onclick="DataManager.addTeacher()"
                                title="手动添加一条教师任课记录"
                                style="padding:6px 12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                                <i class="ti ti-plus"></i> 手动新增
                            </button>

                            <button class="btn btn-sm" onclick="downloadTemplate('teacher')" title="下载教师任课表Excel模板"
                                style="padding:6px 12px; font-size:12px; background:white; border:1px solid #cbd5e1; color:#475569; display:flex; align-items:center; gap:4px;">
                                <i class="ti ti-download"></i> 下载模板
                            </button>
                        </div>
                    </div>

                    <!-- 提示信息栏 -->
                    <div
                        style="background:#eff6ff; border-left:4px solid #3b82f6; padding:10px 15px; margin:10px; font-size:12px; color:#1e40af; border-radius:4px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <i class="ti ti-info-circle" style="font-size:16px;"></i>
                            <div>
                                <strong>使用说明：</strong>
                                <ul style="margin:5px 0 0 20px; padding:0; line-height:1.6;">
                                    <li>选择学期后，可以从云端同步或导入Excel文件</li>
                                    <li>Excel格式要求：<strong>班级</strong>、<strong>学科</strong>、<strong>教师姓名</strong> 三列</li>
                                    <li>导入后数据自动保存到本地，点击「上传云端」可同步到云端数据库</li>
                                    <li>教师任课数据会在「班级教学管理」等模块中自动引用</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 教师任课表格 -->
                    <div style="margin:10px;">
                        <table id="dm-teacher-table" style="font-size:12px; width:100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background:#f8fafc; border-bottom:2px solid #e2e8f0;">
                                    <th
                                        style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:20%;">
                                        学校</th>
                                    <th
                                        style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:15%;">
                                        班级</th>
                                    <th
                                        style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:15%;">
                                        学科</th>
                                    <th
                                        style="padding:10px; text-align:left; font-weight:bold; color:#475569; border-right:1px solid #e2e8f0; width:20%;">
                                        教师姓名</th>
                                    <th
                                        style="padding:10px; text-align:center; font-weight:bold; color:#475569; width:30%;">
                                        操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- 档案管理区域 -->
                <!-- D. 年级指标参数设置区域 (保持不变，仅为了定位) -->
                <div id="dm-params-area" style="display:none; padding:20px;">
                    <div style="background:#f0f9ff; border:1px solid #bae6fd; padding:20px; border-radius:8px;">
                        <h4
                            style="color:#0369a1; margin-bottom:15px; border-bottom:1px dashed #bae6fd; padding-bottom:10px;">
                            <i class="ti ti-settings"></i> 年级划线参数配置
                        </h4>
                        <div id="dm-params-tip"
                            style="display:none; background:#fff7ed; border:1px dashed #fdba74; color:#9a3412; padding:8px 10px; border-radius:6px; font-size:12px; margin-bottom:12px;">
                            提示：当前非 9 年级期中/期末，参数仅用于预设，不参与计算。
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <div>
                                <label style="font-weight:bold; display:block; margin-bottom:5px;">指标一 (优生线)
                                    划线名次：</label>
                                <input type="number" id="dm_ind1_input" class="mob-input" style="background:white;"
                                    placeholder="例如: 500">
                                <p style="font-size:12px; color:#64748b; margin-top:5px;">全镇总分排名第 N 名的分数将作为优生线。</p>
                            </div>
                            <div>
                                <label style="font-weight:bold; display:block; margin-bottom:5px;">指标二 (普高线)
                                    划线名次：</label>
                                <input type="number" id="dm_ind2_input" class="mob-input" style="background:white;"
                                    placeholder="例如: 1200">
                                <p style="font-size:12px; color:#64748b; margin-top:5px;">全镇总分排名第 N 名的分数将作为及格/普高线。</p>
                            </div>
                        </div>
                        <div style="margin-top:20px; text-align:right;">
                            <button class="btn btn-primary" onclick="DataManager.saveParamsLocally()">
                                <i class="ti ti-device-floppy"></i> 暂存参数 (需点击右上角保存同步)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 👇👇👇 ✋ 🔴 [修改开始]：修改目标管理区域，改为文件导入模式 🔴 ✋ 👇👇👇 -->
                <!-- E. 目标人数管理区域 -->
                <div id="dm-targets-area" style="display:none; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:#166534;"><i class="ti ti-target"></i> 各校目标人数管理</h4>

                        <!-- 🟢 [新代码]：改为导入按钮 + 隐藏的文件输入框 -->
                        <div>
                            <button class="btn btn-sm btn-green"
                                onclick="document.getElementById('dm-target-file').click()">
                                <i class="ti ti-file-import"></i> 导入目标人数文件 (.xlsx)
                            </button>
                            <input type="file" id="dm-target-file" accept=".xlsx,.xls" hidden
                                onchange="DataManager.handleTargetUpload(this)">

                            <a href="javascript:void(0)"
                                style="font-size:12px; margin-left:10px; color:#666; text-decoration:underline;"
                                onclick="alert('Excel格式要求：\n第一列：学校名称\n第二列：指标一目标人数\n第三列：指标二目标人数')">格式说明</a>
                        </div>
                        <!-- 👆 🟢 [修改结束] -->
                    </div>

                    <div class="info-bar" style="margin-bottom:10px;">
                        💡 提示：导入后请点击右上角【保存修改并同步云端】按钮，以防止刷新后丢失。
                    </div>

                    <div class="table-wrap"
                        style="box-shadow:none; border:1px solid #e2e8f0; max-height: 60vh; overflow-y: auto;">
                        <table class="comparison-table" style="font-size:13px;">
                            <thead>
                                <tr>
                                    <th>学校名称</th>
                                    <th style="background:#e0f2fe;">指标一目标 (人)</th>
                                    <th style="background:#fff7ed;">指标二目标 (人)</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="dm-targets-tbody">
                                <!-- JS 动态渲染 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="dm-sql-area" style="display:none; padding:15px; height:100%; flex-direction:column;">
                    <!-- 提示与常用语句 -->
                    <div style="margin-bottom:10px; display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('base')">📋 查前10名</button>
                        <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('count')">📊 各校人数</button>
                        <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('avg')">📈 各班均分</button>
                        <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('failed')">📉
                            不及格名单</button>
                        <button class="btn btn-sm btn-gray" onclick="DataManager.setQuickSQL('teacher')">👩‍🏫
                            查任课学生</button>
                        <div style="flex:1; text-align:right; font-size:12px; color:#666; align-self:center;">
                            表名: <b>students</b> (成绩), <b>teachers</b> (任课)
                        </div>
                    </div>

                    <!-- 历史与收藏 -->
                    <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                        <select id="dm-sql-history-select"
                            style="min-width:220px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;"
                            onchange="DataManager.applySQLHistory(this.value)">
                            <option value="">🕘 最近/收藏</option>
                        </select>
                        <input id="dm-sql-history-name" type="text" placeholder="收藏名称(可选)"
                            style="padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px; width:180px;">
                        <button class="btn btn-sm btn-green" onclick="DataManager.saveNamedSQL()">⭐ 保存收藏</button>
                        <button class="btn btn-sm btn-gray" onclick="DataManager.clearSQLHistory()">🧹 清空历史</button>
                    </div>

                    <!-- Talk to Data 自然语言查数 -->
                    <div
                        style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; padding:8px;">
                        <input id="dm-nlq-input" type="text" placeholder="例如：找出701班物理不及格但数学前10名的学生"
                            style="flex:1; min-width:280px; padding:6px 8px; border:1px solid #cbd5e1; border-radius:6px; font-size:12px;">
                        <button class="btn btn-sm btn-purple" onclick="talkToData()">💬 自然语言查数</button>
                        <span id="dm-nlq-status" style="font-size:12px; color:#64748b;"></span>
                    </div>

                    <!-- SQL 输入框 -->
                    <textarea id="dm-sql-input"
                        style="width:100%; height:120px; background:#1e293b; color:#a5b4fc; font-family:'Consolas', monospace; padding:10px; border-radius:6px; font-size:14px; border:1px solid #475569; resize:none;"
                        placeholder="在此输入 SQL 语句..."></textarea>

                    <!-- 操作栏 -->
                    <div style="margin:10px 0; display:flex; justify-content:space-between;">
                        <div id="sql-status-msg" style="font-size:12px; color:#ef4444; font-weight:bold;"></div>
                        <div>
                            <button class="btn btn-sm btn-green" onclick="DataManager.exportSQLResult()">📥 导出结果
                                Excel</button>
                            <button class="btn btn-primary" onclick="DataManager.runSQL()"><i
                                    class="ti ti-player-play"></i> 执行查询 (Run)</button>
                        </div>
                    </div>

                    <!-- 结果表格容器 -->
                    <div class="table-wrap"
                        style="flex:1; overflow:auto; border:1px solid #e2e8f0; border-radius:4px; box-shadow:none;">
                        <table id="dm-sql-table" style="font-size:12px; width:100%;">
                            <thead>
                                <tr>
                                    <th>查询结果将显示在这里</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="dm-cloud-area" style="display:none; padding:15px; flex-direction:column; height:100%;">
                    <div class="info-bar">
                        <i class="ti ti-cloud"></i> <strong>我的云端数据管理：</strong>
                        此处列出您上传到云端的所有备份（包括自动保存和手动备份）。您可以删除旧的存档以释放空间。
                        <br><span style="color:red; font-size:11px;">* 注意：删除操作不可恢复，请谨慎操作。</span>
                    </div>
                    <div id="dm-cloud-summary"
                        style="background:#f8fafc; border:1px dashed #cbd5e1; border-radius:8px; padding:10px; font-size:12px; color:#475569; margin:10px 0;">
                        📌 云端摘要将在此显示
                    </div>
                    <div
                        style="display:flex; gap:12px; align-items:center; font-size:12px; color:#475569; margin-bottom:8px;">
                        <label><input type="checkbox" id="cloud-filter-current" checked
                                onchange="DataManager.renderCloudBackups()"> 仅当前项目</label>
                        <label><input type="checkbox" id="cloud-filter-snapshots" checked
                                onchange="DataManager.renderCloudBackups()"> 显示快照</label>
                    </div>
                    <div
                        style="display:flex; gap:8px; align-items:center; font-size:12px; color:#475569; margin-bottom:8px;">
                        <span id="cloud-selected-count">已选 0 项</span>
                        <button class="btn btn-sm btn-danger" id="btn-cloud-batch-delete"
                            onclick="DataManager.deleteSelectedCloudBackups()" disabled title="请先勾选需要删除的存档"
                            style="opacity:0.6;">
                            <i class="ti ti-trash"></i> 批量删除
                        </button>
                    </div>
                    <div class="table-wrap" style="flex:1; overflow-y:auto;">
                        <table class="comparison-table" id="dm-cloud-table">
                            <thead>
                                <tr>
                                    <th style="width:44px; text-align:center;"><input type="checkbox"
                                            id="dm-cloud-select-all"
                                            onchange="DataManager.toggleCloudSelectAll(this.checked)" title="全选/取消全选">
                                    </th>
                                    <th>存档 Key (项目名)</th>
                                    <th>上传时间</th>
                                    <th>数据大小</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="dm-history-area" style="display:none; padding:15px; flex-direction:column; height:100%;">
                    <div
                        style="background:#f0fdf4; border:1px solid #86efac; padding:15px; border-radius:8px; margin-bottom:15px;">
                        <h4 style="margin:0 0 10px 0; color:#166534;"><i class="ti ti-file-import"></i> 上传历史考试数据
                            (用于进退步分析)</h4>
                        <div style="font-size:12px; color:#15803d; line-height:1.6; margin-bottom:10px;">
                            <strong>📂 智能解析规则：</strong><br>
                            1. <strong>多校识别：</strong> 系统将读取 Excel 的 <span
                                style="background:white; padding:0 4px; border:1px dashed #ccc;">Sheet名称</span>
                            作为学校名称。<br>
                            2. <strong>匹配键值：</strong> 对比分析将严格基于 <span
                                style="background:white; padding:0 4px; border:1px dashed #ccc;">[班级] + [姓名]</span>
                            进行锚定。<br>
                            3. <strong>匿名处理：</strong> 若表格中缺少姓名列，系统将自动标记为“无名氏_序号”，仅作校内人数统计，不参与个人进退步。<br>
                            4. <strong>单校模式：</strong> 若仅检测到一个学校，系统将自动隐藏“全镇排名”列，转为校内深度对比。
                        </div>
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-green" onclick="document.getElementById('dm-history-file').click()">
                                <i class="ti ti-upload"></i> 点击上传历史 Excel
                            </button>
                            <input type="file" id="dm-history-file" accept=".xlsx,.xls" hidden
                                onchange="DataManager.handleHistoryUpload(this)">
                            <span id="dm-history-status"
                                style="align-self:center; font-size:12px; color:#666;">暂未上传</span>
                        </div>
                    </div>

                    <div class="sub-header">📊 历史对比数据预览</div>
                    <div class="table-wrap" style="flex:1; overflow-y:auto;">
                        <table id="dm-history-preview-table" style="font-size:12px;">
                            <thead>
                                <tr>
                                    <th>学校 (Sheet名)</th>
                                    <th>班级</th>
                                    <th>姓名</th>
                                    <th>上次总分</th>
                                    <th>上次校排</th>
                                    <th>上次镇排</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" style="text-align:center; padding:20px; color:#999;">请上传文件预览数据</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 分页控件 (仅在学生/教师 Tab 显示) -->
                <div id="dm-pagination"
                    style="padding-top:10px; text-align:right; font-size:12px; color:#666; display:flex; justify-content:flex-end; gap:10px; align-items:center;">
                    <button class="btn btn-sm btn-gray" onclick="DataManager.changePage(-1)">上一页</button>
                    <span id="dm-page-info">1 / 1</span>
                    <button class="btn btn-sm btn-gray" onclick="DataManager.changePage(1)">下一页</button>
                </div>
            </div>
        </div>

        <!-- ================== 性能监控与优化工具 ================== -->
        <script>
            // 全局性能监控工具
            window.PerformanceMonitor = {
                // 获取页面性能数据
                getMetrics: function () {
                    if (!window.performance || !performance.timing) {
                        return { error: "浏览器不支持性能API" };
                    }

                    const t = performance.timing;
                    const metrics = {
                        DNS解析: t.domainLookupEnd - t.domainLookupStart,
                        TCP连接: t.connectEnd - t.connectStart,
                        请求响应: t.responseEnd - t.requestStart,
                        DOM解析: t.domComplete - t.domLoading,
                        页面完全加载: t.loadEventEnd - t.navigationStart,
                        白屏时间: t.responseStart - t.navigationStart,
                        首屏时间: t.domContentLoadedEventEnd - t.navigationStart
                    };

                    return metrics;
                },

                // 打印性能报告
                report: function () {
                    const metrics = this.getMetrics();
                    console.group('📊 系统性能报告');
                    for (let key in metrics) {
                        if (typeof metrics[key] === 'number') {
                            console.log(`${key}: ${metrics[key]}ms`);
                        }
                    }
                    console.groupEnd();

                    // 检查内存使用(仅Chrome)
                    if (performance.memory) {
                        const memory = performance.memory;
                        console.log(`💾 内存使用: ${(memory.usedJSHeapSize / 1048576).toFixed(2)}MB / ${(memory.jsHeapSizeLimit / 1048576).toFixed(2)}MB`);
                    }

                    return metrics;
                },

                // 优化建议
                getSuggestions: function () {
                    const metrics = this.getMetrics();
                    const suggestions = [];

                    if (metrics['页面完全加载'] > 5000) {
                        suggestions.push('⚠️ 页面加载时间超过5秒，建议优化网络或减少外部资源');
                    }
                    if (metrics['DOM解析'] > 2000) {
                        suggestions.push('⚠️ DOM解析较慢，考虑减少DOM节点或延迟加载非关键内容');
                    }
                    if (performance.memory && performance.memory.usedJSHeapSize > 100 * 1048576) {
                        suggestions.push('⚠️ 内存占用较高(>100MB)，建议定期刷新页面');
                    }

                    if (suggestions.length === 0) {
                        suggestions.push('✅ 系统运行良好，无需优化');
                    }

                    return suggestions;
                }
            };

            // 内存清理工具
            window.MemoryCleaner = {
                clean: function () {
                    console.log('🧹 开始清理内存...');

                    // 清理大型图表实例
                    if (window.Chart && Chart.instances) {
                        Object.values(Chart.instances).forEach(chart => {
                            if (chart && typeof chart.destroy === 'function') {
                                chart.destroy();
                            }
                        });
                        console.log('✅ 已清理图表实例');
                    }

                    console.log('💡 建议: 刷新页面以完全释放内存');

                    if (confirm('是否刷新页面以完全清理内存?')) {
                        location.reload();
                    }
                }
            };

            // 开发模式自动性能检测
            if (localStorage.getItem('DEV_MODE') === 'true') {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        PerformanceMonitor.report();
                        PerformanceMonitor.getSuggestions().forEach(s => console.log(s));
                    }, 1000);
                });
            }
        </script>

        <!-- 📱 移动端交互逻辑 (Mobile Interaction Logic) -->
        <script>
            const MobMgr = {
                init: function () {
                    // 仅在移动端运行
                    if (window.innerWidth > 768) return;

                    console.log('📱 Mobile Dashboard Initialized');

                    // 1. 设置顶部日期
                    const date = new Date();
                    const dateStr = `${date.getMonth() + 1}月${date.getDate()}日`;
                    const dateEl = document.getElementById('mob-date-display');
                    if (dateEl) dateEl.innerText = dateStr;

                    // 2. 启动数据监控与渲染
                    this.checkLoginAndRender();
                    // 轮询检查数据更新 (比如刚导入数据后)
                    setInterval(() => this.checkLoginAndRender(), 2000);
                },

                checkLoginAndRender: function () {
                    if (window.innerWidth > 768) return;

                    const loginOverlay = document.getElementById('login-overlay');
                    // 如果登录层隐藏，视作已登录
                    const isLogged = loginOverlay && loginOverlay.style.display === 'none';

                    if (isLogged) {
                        // A. 渲染用户信息
                        if (window.Auth && Auth.currentUser) {
                            const nameEl = document.getElementById('mob-dash-user');
                            if (nameEl && nameEl.innerText === '老师') { // 避免重复刷新闪烁
                                nameEl.innerText = Auth.currentUser.name || '老师';
                            }
                        }

                        // B. 渲染统计卡片
                        this.renderStats();
                    }
                },

                renderStats: function () {
                    if (window.Data && window.Data.cleanData && window.Data.cleanData.length > 0) {
                        const students = window.Data.cleanData;
                        const total = students.length;

                        // 计算平均分 (总分字段)
                        let totalScore = 0;
                        let count = 0;
                        students.forEach(s => {
                            const score = parseFloat(s['总分']);
                            if (!isNaN(score)) {
                                totalScore += score;
                                count++;
                            }
                        });
                        const avg = count > 0 ? (totalScore / count).toFixed(1) : '--';

                        // 计算班级数
                        const classCount = new Set(students.map(s => s['班级'])).size;

                        // 更新 DOM
                        const elTotal = document.getElementById('mob-stat-total');
                        const elAvg = document.getElementById('mob-stat-avg');
                        const elPass = document.getElementById('mob-stat-pass'); // 复用及格率位置显示班级数

                        if (elTotal) elTotal.innerText = total;
                        if (elAvg) elAvg.innerText = avg;
                        // 这里把及格率改成显示班级数，因为及格线不确定
                        if (elPass) {
                            elPass.innerHTML = `${classCount} <span style="font-size:10px;color:#94a3b8">个班</span>`;
                            elPass.style.color = '#3b82f6';
                        }
                    }
                },

                showToast: function (msg) {
                    if (window.showToast) window.showToast(msg);
                    else alert(msg);
                }
            };

            // 启动移动端管理器
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => MobMgr.init());
            } else {
                MobMgr.init();
            }
        </script>


        <!-- ============================================================
         FINAL AUTHORITY: Dark Mode Override (MUST be last style block)
         This block wins the CSS cascade against ALL prior style blocks.
         ============================================================ -->
        <style>
            /* UNIVERSAL: Every element with class-driven or default background */
            body.dark-mode table,
            body.dark-mode thead,
            body.dark-mode tbody,
            body.dark-mode tr,
            body.dark-mode th,
            body.dark-mode td,
            body.dark-mode tr:nth-child(even),
            body.dark-mode tr:nth-child(odd),
            body.dark-mode .comparison-table th,
            body.dark-mode .comparison-table td,
            body.dark-mode .comparison-table thead th,
            body.dark-mode .glass-table th,
            body.dark-mode .glass-table td,
            body.dark-mode .pure-table th,
            body.dark-mode .pure-table td {
                background: transparent !important;
                background-color: transparent !important;
                color: #cbd5e1 !important;
                border-color: rgba(255, 255, 255, 0.08) !important;
            }

            /* Table headers get a subtle frosted dark treatment */
            body.dark-mode table thead th,
            body.dark-mode .comparison-table thead th,
            body.dark-mode .glass-table thead th {
                background: rgba(30, 41, 59, 0.7) !important;
                color: #94a3b8 !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            }

            /* Hover effect for rows */
            body.dark-mode tbody tr:hover,
            body.dark-mode tbody tr:hover td {
                background: rgba(255, 255, 255, 0.05) !important;
            }

            /* Alternating row stripe (subtle) */
            body.dark-mode tbody tr:nth-child(even) td {
                background: rgba(255, 255, 255, 0.02) !important;
            }

            /* Target school highlight rows */
            body.dark-mode .bg-highlight,
            body.dark-mode .bg-highlight td,
            body.dark-mode tr.bg-highlight,
            body.dark-mode tr.bg-highlight td {
                background: rgba(249, 115, 22, 0.15) !important;
                color: #fdba74 !important;
            }

            /* UNIVERSAL: Strip ALL inline style backgrounds */
            body.dark-mode [style*="background"] {
                background: transparent !important;
                background-color: transparent !important;
            }

            /* Structural containers with inline backgrounds get glassmorphism */
            body.dark-mode div[style*="background"],
            body.dark-mode section[style*="background"],
            body.dark-mode details[style*="background"],
            body.dark-mode summary[style*="background"],
            body.dark-mode li[style*="background"] {
                background: rgba(30, 41, 59, 0.45) !important;
                backdrop-filter: blur(12px) !important;
                -webkit-backdrop-filter: blur(12px) !important;
                border-color: rgba(255, 255, 255, 0.08) !important;
            }

            /* WHITELIST: Elements that NEED their inline backgrounds */
            body.dark-mode button[style*="background"],
            body.dark-mode .btn[style*="background"],
            body.dark-mode [class*="btn-"][style*="background"],
            body.dark-mode .heatmap-cell[style*="background"],
            body.dark-mode .contribution-bar[style*="background"],
            body.dark-mode .data-bar-bg[style*="background"],
            body.dark-mode .progress-fill[style*="background"],
            body.dark-mode .bar-fill[style*="background"],
            body.dark-mode .score-bar[style*="background"],
            body.dark-mode span.badge[style*="background"],
            body.dark-mode .t-badge[style*="background"] {
                background: revert !important;
                background-color: revert !important;
            }

            /* Unscoped white/light class backgrounds */
            body.dark-mode .table-wrap,
            body.dark-mode .card-box,
            body.dark-mode .info-card,
            body.dark-mode .doc-card,
            body.dark-mode .starter-card,
            body.dark-mode .glass-panel,
            body.dark-mode .modal-content,
            body.dark-mode .spotlight-box,
            body.dark-mode .nav-dropdown-menu,
            body.dark-mode .log-item,
            body.dark-mode .task-item,
            body.dark-mode .issue-item,
            body.dark-mode .info-bar,
            body.dark-mode .class-students-container,
            body.dark-mode .student-compare-card,
            body.dark-mode .class-group-header {
                background: rgba(30, 41, 59, 0.45) !important;
                border-color: rgba(255, 255, 255, 0.08) !important;
            }

            /* Dark text overrides */
            body.dark-mode [style*="color:#334155"],
            body.dark-mode [style*="color: #334155"],
            body.dark-mode [style*="color:#475569"],
            body.dark-mode [style*="color: #475569"],
            body.dark-mode [style*="color:#333"],
            body.dark-mode [style*="color: #333"],
            body.dark-mode [style*="color:#666"],
            body.dark-mode [style*="color: #666"],
            body.dark-mode [style*="color:#1e293b"],
            body.dark-mode [style*="color: #1e293b"],
            body.dark-mode [style*="color:#0f172a"],
            body.dark-mode [style*="color: #0f172a"],
            body.dark-mode [style*="color:#202020"],
            body.dark-mode [style*="color: #202020"] {
                color: #cbd5e1 !important;
            }

            /* Login overlay special case */
            body.dark-mode #login-overlay[style*="background"] {
                background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%) !important;
            }
        </style>

</body>

</html>